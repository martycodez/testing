<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=5.0">
<title>Clover Capital â€” Portfolio Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;0,9..40,800;1,9..40,400&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
html{-webkit-text-size-adjust:100%;scroll-behavior:smooth;overflow-x:hidden}
body{background:#0B1120;color:#E2E8F0;font-family:'DM Sans',sans-serif;overflow-x:hidden;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;min-height:100vh}

::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:#334155;border-radius:4px}
::-webkit-scrollbar-thumb:hover{background:#475569}

/* â•â•â• LOADING OVERLAY â•â•â• */
.loading-overlay{
  position:fixed;inset:0;background:#0B1120;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  z-index:9999;transition:opacity 0.5s ease, visibility 0.5s ease;
}
.loading-overlay.hidden{opacity:0;visibility:hidden;pointer-events:none}
.loading-logo{
  width:72px;height:72px;
  background:linear-gradient(135deg,#4ADE80,#22D3EE);
  border-radius:18px;display:flex;align-items:center;justify-content:center;
  font-weight:800;font-size:30px;color:#0B1120;
  animation:logoFloat 2s ease-in-out infinite;
  box-shadow:0 0 60px rgba(74,222,128,0.25);
}
@keyframes logoFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
.loading-bar-track{
  width:200px;height:3px;background:rgba(148,163,184,0.1);
  border-radius:3px;margin-top:28px;overflow:hidden;
}
.loading-bar-fill{
  height:100%;width:0%;background:linear-gradient(90deg,#4ADE80,#22D3EE);
  border-radius:3px;animation:loadBar 2s ease-out forwards;
}
@keyframes loadBar{0%{width:0}60%{width:80%}100%{width:100%}}
.loading-label{
  margin-top:16px;font-size:12px;color:#475569;
  font-family:'JetBrains Mono',monospace;letter-spacing:0.5px;
}
.loading-sublabel{
  margin-top:6px;font-size:10px;color:#334155;
  font-family:'JetBrains Mono',monospace;
  animation:blink 1.5s ease-in-out infinite;
}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.3}}

/* â•â•â• LAYOUT â•â•â• */
.app-shell{display:flex;min-height:100vh}

/* â•â•â• SIDEBAR â•â•â• */
.sidebar{
  width:240px;min-height:100vh;
  background:rgba(15,23,42,0.6);
  border-right:1px solid rgba(148,163,184,0.06);
  padding:24px 16px;display:flex;flex-direction:column;
  position:fixed;left:0;top:0;bottom:0;z-index:100;
  backdrop-filter:blur(20px);
}
.sidebar-brand{display:flex;align-items:center;gap:12px;padding:0 8px;margin-bottom:32px}
.sidebar-logo{
  width:36px;height:36px;
  background:linear-gradient(135deg,#4ADE80,#22D3EE);
  border-radius:10px;display:flex;align-items:center;justify-content:center;
  font-weight:800;font-size:16px;color:#0B1120;flex-shrink:0;
}
.sidebar-title{font-size:15px;font-weight:700;color:#F1F5F9;letter-spacing:-0.3px;line-height:1.2}
.sidebar-title span{color:#4ADE80}
.sidebar-subtitle{font-size:10px;color:#475569;font-family:'JetBrains Mono',monospace;margin-top:2px}

.sidebar-nav{display:flex;flex-direction:column;gap:4px;flex:1}
.nav-btn{
  background:transparent;border:none;color:#64748B;
  padding:10px 12px;border-radius:10px;font-size:13px;font-weight:500;
  font-family:'DM Sans',sans-serif;cursor:pointer;
  transition:all .2s ease;text-align:left;display:flex;align-items:center;gap:10px;
}
.nav-btn:hover{background:rgba(148,163,184,0.06);color:#94A3B8}
.nav-btn.active{background:rgba(74,222,128,0.08);color:#4ADE80;font-weight:600}
.nav-btn .nav-icon{font-size:16px;width:22px;text-align:center}

.sidebar-footer{
  padding-top:16px;border-top:1px solid rgba(148,163,184,0.06);
  font-size:10px;color:#334155;font-family:'JetBrains Mono',monospace;
  text-align:center;
}

/* â•â•â• MAIN â•â•â• */
.main-content{margin-left:240px;flex:1;min-height:100vh}
.top-bar{
  position:sticky;top:0;z-index:50;
  background:rgba(11,17,32,0.85);backdrop-filter:blur(16px);
  border-bottom:1px solid rgba(148,163,184,0.06);
  padding:14px 32px;display:flex;align-items:center;justify-content:space-between;
}
.top-bar-left{display:flex;align-items:center;gap:12px}
.top-bar-left .page-title{font-size:16px;font-weight:700;color:#F1F5F9}
.top-bar-left .last-update{font-size:10px;color:#475569;font-family:'JetBrains Mono',monospace}
.top-bar-right{display:flex;align-items:center;gap:12px}
.live-pill{
  display:flex;align-items:center;gap:6px;
  background:rgba(74,222,128,0.08);border:1px solid rgba(74,222,128,0.15);
  border-radius:20px;padding:5px 14px 5px 10px;
}
.live-dot{width:6px;height:6px;background:#4ADE80;border-radius:50%;animation:pulse 2s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.3}}
.live-label{font-size:10px;font-weight:600;color:#4ADE80;font-family:'JetBrains Mono',monospace;letter-spacing:1px}
.countdown-pill{
  font-size:10px;color:#475569;font-family:'JetBrains Mono',monospace;
  background:rgba(30,41,59,0.5);border:1px solid rgba(148,163,184,0.06);
  border-radius:12px;padding:5px 10px;min-width:42px;text-align:center;
}

.container{max-width:1120px;margin:0 auto;padding:28px 32px}

/* â•â•â• ERROR â•â•â• */
.error-banner{
  background:rgba(248,113,113,0.08);border:1px solid rgba(248,113,113,0.15);
  border-radius:10px;padding:10px 16px;margin-bottom:20px;
  font-size:11px;color:#F87171;display:none;font-family:'JetBrains Mono',monospace;
}

/* â•â•â• HERO CARDS â•â•â• */
.hero-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:24px}
.hero-card{
  background:linear-gradient(135deg,rgba(15,23,42,0.8),rgba(30,41,59,0.35));
  border:1px solid rgba(148,163,184,0.06);border-radius:16px;
  padding:20px;position:relative;overflow:hidden;
  transition:transform .2s ease, box-shadow .2s ease;
}
.hero-card:hover{transform:translateY(-2px);box-shadow:0 8px 32px rgba(0,0,0,0.2)}
.hero-card::before{
  content:'';position:absolute;top:0;left:0;right:0;height:2px;
}
.hero-card:nth-child(1)::before{background:linear-gradient(90deg,#4ADE80,#22D3EE)}
.hero-card:nth-child(2)::before{background:linear-gradient(90deg,#F7931A,#FCD34D)}
.hero-card:nth-child(3)::before{background:linear-gradient(90deg,#8B5CF6,#A78BFA)}
.hero-card:nth-child(4)::before{background:linear-gradient(90deg,#3B82F6,#60A5FA)}
.hero-label{font-size:10px;color:#596882;font-family:'JetBrains Mono',monospace;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px}
.hero-value{font-size:32px;font-weight:800;color:#F1F5F9;letter-spacing:-1.5px;line-height:1.1}
.hero-sub{font-size:10px;color:#596882;margin-top:6px;font-family:'JetBrains Mono',monospace}
.hero-delta{font-size:11px;font-weight:600;margin-top:4px}
.delta-neg{color:#F87171}.delta-pos{color:#4ADE80}

/* â•â•â• METRICS GRID â•â•â• */
.metrics-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:24px}
.metric-box{
  background:rgba(15,23,42,0.4);border:1px solid rgba(148,163,184,0.05);
  border-radius:12px;padding:14px;
}
.metric-label{font-size:9px;color:#596882;font-family:'JetBrains Mono',monospace;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px}
.metric-value{font-size:17px;font-weight:700;color:#F1F5F9}

/* â•â•â• CARDS â•â•â• */
.card{
  background:rgba(15,23,42,0.5);border:1px solid rgba(148,163,184,0.06);
  border-radius:16px;padding:24px;backdrop-filter:blur(10px);margin-bottom:20px;
}
.section-title{font-size:14px;font-weight:700;color:#F1F5F9;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.section-title .icon{font-size:14px}

/* â•â•â• CONTENT GRIDS â•â•â• */
.content-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px}

/* â•â•â• ITD/QTD â•â•â• */
.itd-qtd{display:grid;grid-template-columns:1fr 1fr;gap:0}
.itd-qtd>div:first-child{border-right:1px solid rgba(148,163,184,0.08);padding-right:24px}
.itd-qtd>div:last-child{padding-left:24px}
.period-label{font-size:10px;color:#596882;font-family:'JetBrains Mono',monospace;text-transform:uppercase;letter-spacing:1px;margin-bottom:12px}
.return-row{display:flex;justify-content:space-between;align-items:center;padding:7px 0;border-bottom:1px solid rgba(148,163,184,0.04)}
.return-row:last-child{border-bottom:none}
.return-label{font-size:12px;color:#94A3B8}
.return-value{font-size:13px;font-weight:600}

/* â•â•â• TABLES â•â•â• */
.tbl-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
table{width:100%;border-collapse:collapse;min-width:520px;font-size:12px}
th{text-align:left;padding:9px 12px;color:#596882;font-weight:500;font-size:10px;text-transform:uppercase;letter-spacing:0.5px;border-bottom:1px solid rgba(148,163,184,0.08);font-family:'JetBrains Mono',monospace}
td{padding:9px 12px;border-bottom:1px solid rgba(148,163,184,0.04);color:#CBD5E1}
tr:hover td{background:rgba(30,41,59,0.25)}
.tbl-bold td{font-weight:600;color:#F1F5F9}

/* â•â•â• CHARTS â•â•â• */
.chart-container{position:relative;height:300px;margin-top:12px}
.chart-legend{display:flex;gap:16px;margin-bottom:10px;flex-wrap:wrap}
.legend-item{display:flex;align-items:center;gap:6px;font-size:11px;color:#94A3B8}
.legend-swatch{width:18px;height:3px;border-radius:2px}

/* â•â•â• ALLOCATION BARS â•â•â• */
.alloc-bar-row{display:flex;align-items:center;gap:12px;margin-bottom:10px}
.alloc-label{width:55px;font-size:11px;color:#94A3B8;font-family:'JetBrains Mono',monospace;flex-shrink:0}
.alloc-bar-track{flex:1;height:28px;background:rgba(30,41,59,0.4);border-radius:6px;overflow:hidden;position:relative}
.alloc-bar-fill{height:100%;border-radius:6px;display:flex;align-items:center;padding:0 10px;font-size:10px;font-weight:600;color:#0B1120;transition:width 0.6s ease}
.alloc-pct{font-size:11px;color:#94A3B8;font-family:'JetBrains Mono',monospace;width:50px;text-align:right;flex-shrink:0}

/* â•â•â• COST BASIS BARS â•â•â• */
.cost-bar-row{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.cost-bar-label{width:100px;font-size:10px;color:#94A3B8;font-family:'JetBrains Mono',monospace;flex-shrink:0;text-align:right}
.cost-bar-track{flex:1;height:24px;background:rgba(30,41,59,0.3);border-radius:4px;overflow:hidden;position:relative}
.cost-bar-fill{height:100%;border-radius:4px;display:flex;align-items:center;justify-content:flex-end;padding:0 8px;font-size:9px;font-weight:600;color:#fff}

/* â•â•â• COMMENTARY â•â•â• */
.commentary{background:rgba(30,41,59,0.25);border-radius:10px;padding:16px;font-size:12px;color:#94A3B8;line-height:1.7;margin-top:10px}
.commentary strong{color:#F1F5F9}
.commentary .hl-green{color:#4ADE80;font-weight:700}
.commentary .hl-orange{color:#F7931A;font-weight:700}

/* â•â•â• TAB CONTENT â•â•â• */
.tab-content{display:none}
.tab-content.active{display:block;animation:fadeIn .3s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

/* â•â•â• RESPONSIVE â•â•â• */
@media(max-width:1024px){
  .hero-grid{grid-template-columns:repeat(2,1fr)}
  .sidebar{display:none}
  .main-content{margin-left:0}
  .mobile-tabs{display:flex!important}
}
@media(max-width:768px){
  .top-bar{padding:12px 16px;flex-wrap:wrap;gap:10px}
  .container{padding:16px}
  .card{padding:16px;border-radius:14px}
  .hero-grid{grid-template-columns:repeat(2,1fr);gap:10px}
  .hero-value{font-size:24px}
  .metrics-grid{grid-template-columns:repeat(2,1fr);gap:8px}
  .content-grid{grid-template-columns:1fr}
  .itd-qtd{grid-template-columns:1fr}
  .itd-qtd>div:first-child{border-right:none;border-bottom:1px solid rgba(148,163,184,0.08);padding-bottom:20px;padding-right:0;margin-bottom:8px}
  .itd-qtd>div:last-child{padding-left:0}
  .cost-bar-label{width:80px;font-size:9px}
  .chart-container{height:240px}
}
@media(max-width:480px){
  .hero-grid{grid-template-columns:1fr 1fr;gap:8px}
  .hero-value{font-size:20px}
}

/* Mobile tab bar (hidden on desktop) */
.mobile-tabs{
  display:none;overflow-x:auto;-webkit-overflow-scrolling:touch;
  scrollbar-width:none;gap:5px;padding:0 16px 12px;
}
.mobile-tabs::-webkit-scrollbar{display:none}
.mobile-tab{
  background:rgba(30,41,59,0.5);border:1px solid rgba(148,163,184,0.08);
  color:#94A3B8;padding:8px 16px;border-radius:10px;font-size:12px;font-weight:500;
  font-family:'DM Sans',sans-serif;cursor:pointer;white-space:nowrap;flex-shrink:0;
}
.mobile-tab.active{background:rgba(74,222,128,0.08);border-color:rgba(74,222,128,0.2);color:#4ADE80}
</style>
</head>
<body>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-logo">â˜˜</div>
  <div class="loading-bar-track"><div class="loading-bar-fill"></div></div>
  <div class="loading-label">Loading portfolio dataâ€¦</div>
</div>

<!-- Ambient Glows -->
<div class="glow-1"></div>
<div class="glow-2"></div>

<!-- Main Container -->
<div class="container" id="mainContainer">

  <!-- Error Banner -->
  <div class="error-banner" id="errorBanner"></div>

  <!-- Header -->
  <div class="r-header">
    <div class="header-left">
      <div class="header-brand">
        <div class="header-logo">
          <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c1.5 0 3-.3 4.3-.9"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><path d="M9 9h.01"/><path d="M15 9h.01"/></svg>
        </div>
        <h1 class="header-title">Clover Capital</h1>
      </div>
      <p class="header-date" id="headerDate">â€”</p>
    </div>
    <div class="r-tabs" id="tabBar">
      <button class="active" data-tab="overview">Overview</button>
      <button data-tab="performance">Performance</button>
      <button data-tab="allocation">Allocation</button>
      <button data-tab="tranches">Purchases</button>
    </div>
  </div>

  <!-- â•â•â• HERO CARDS â•â•â• -->
  <div class="r-hero4">
    <div class="r-card hero-card" id="heroBTCCard" style="cursor:default">
      <div class="hero-card-header"><div class="hero-bar hero-bar-green"></div><span class="hero-label">Total AUM</span></div>
      <div class="hero-value" id="heroAUM">â€”</div>
      <div class="hero-center" id="heroAUMBadge"></div>
    </div>
    <div class="r-card hero-card" id="heroBTCCardHover" style="cursor:pointer">
      <div class="hero-card-header"><div class="hero-bar hero-bar-orange"></div><span class="hero-label">BTC Holdings</span><span class="hero-label-hint" id="heroBTCHint">hover for USD</span></div>
      <div class="hero-value hero-value-orange" id="heroBTC">â€”</div>
      <div class="hero-center" id="heroBTCBadge"></div>
    </div>
    <div class="r-card hero-card">
      <div class="hero-card-header"><div class="hero-bar hero-bar-orange"></div><span class="hero-label">BTC Price</span></div>
      <div class="hero-value hero-value-orange" id="heroBTCPrice">â€”</div>
      <div class="hero-center" id="heroBTCPriceBadge"></div>
    </div>
    <div class="r-card hero-card">
      <div class="hero-card-header"><div class="hero-bar hero-bar-purple"></div><span class="hero-label">Avg Cost Basis</span></div>
      <div class="hero-value" id="heroAvgCost" style="color:#CBD5E1">â€”</div>
      <div class="hero-center" id="heroAvgCostBadge"></div>
    </div>
  </div>

  <!-- â•â•â• OVERVIEW TAB â•â•â• -->
  <div class="tab-content active" id="tab-overview">
    <!-- ITD / QTD -->
    <div class="r-card r-itdqtd" style="padding:0;overflow:hidden;margin-bottom:10px">
      <div class="itd-half">
        <div style="margin-bottom:24px">
          <div class="itd-title-row"><div class="itd-bar itd-bar-orange"></div><div class="itd-title">Inception to Date</div></div>
          <div class="itd-subtitle">TIME-WEIGHTED RETURNS</div>
        </div>
        <div class="itd-returns">
          <div class="return-item"><div class="return-label-row"><div class="return-bar" style="background:#F87171"></div><span class="return-name">Fund Return</span></div><div class="return-value" id="itdFund" style="color:#F87171">â€”</div></div>
          <div class="return-item"><div class="return-label-row"><div class="return-bar" style="background:#F87171"></div><span class="return-name">BTC Benchmark</span></div><div class="return-value" id="itdBTC" style="color:#F87171">â€”</div></div>
        </div>
        <div class="alpha-box" id="itdAlphaBox">
          <div class="alpha-header"><div class="alpha-bar"></div><span class="alpha-label">ALPHA *</span></div>
          <div class="alpha-value" id="itdAlpha">â€”</div>
          <div id="itdAlphaBadge"></div>
        </div>
      </div>
      <div class="itd-half">
        <div style="margin-bottom:24px">
          <div class="itd-title-row"><div class="itd-bar itd-bar-blue"></div><div class="itd-title">Quarter to Date</div></div>
          <div class="itd-subtitle">TIME-WEIGHTED RETURNS</div>
        </div>
        <div class="itd-returns">
          <div class="return-item"><div class="return-label-row"><div class="return-bar" style="background:#F87171"></div><span class="return-name">Fund Return</span></div><div class="return-value" id="qtdFund" style="color:#F87171">â€”</div></div>
          <div class="return-item"><div class="return-label-row"><div class="return-bar" style="background:#F87171"></div><span class="return-name">BTC Benchmark</span></div><div class="return-value" id="qtdBTC" style="color:#F87171">â€”</div></div>
        </div>
        <div class="alpha-box" id="qtdAlphaBox">
          <div class="alpha-header"><div class="alpha-bar"></div><span class="alpha-label">ALPHA *</span></div>
          <div class="alpha-value" id="qtdAlpha">â€”</div>
          <div id="qtdAlphaBadge"></div>
        </div>
      </div>
    </div>

    <!-- TWR Chart -->
    <div class="r-card">
      <div class="chart-title-row"><span class="chart-title-icon">ğŸ€</span><h3 class="chart-title">ALPHA GENERATION â€” FUND VS BTC (ITD TIME-WEIGHTED RETURNS)</h3></div>
      <div class="chart-legend">
        <div class="legend-item"><div class="legend-swatch-line" style="background:#3B82F6"></div>Fund TWR</div>
        <div class="legend-item"><div class="legend-swatch-dashed"></div>BTC TWR</div>
        <div class="legend-item"><div class="legend-swatch-line" style="background:#8B5CF6"></div>BTC Price</div>
        <div class="legend-item"><div class="legend-swatch-bars"></div>Alpha Spread</div>
        <div class="legend-item"><div class="legend-swatch-dot" style="background:#4ADE80;box-shadow:0 0 6px rgba(74,222,128,0.5)"></div>TWAP Buy</div>
        <div class="legend-item"><div class="legend-swatch-dot" style="background:#60A5FA;box-shadow:0 0 6px rgba(96,165,250,0.5)"></div>Limit Buy</div>
      </div>
      <div class="chart-container"><canvas id="twrChart"></canvas></div>
      <div class="narrative-box">
        <div class="narrative-title">ğŸ“Š Alpha Narrative</div>
        <div class="narrative-text" id="commentary">Loadingâ€¦</div>
      </div>
    </div>

    <!-- Key Metrics + Drawdown -->
    <div class="r-grid2">
      <div class="r-card">
        <div class="section-title">Key Metrics</div>
        <div id="keyMetricsDetail" style="display:grid;grid-template-columns:1fr 1fr;gap:10px"></div>
      </div>
      <div class="r-card">
        <div class="section-title">Drawdown from Peak</div>
        <div class="r-dd2" style="margin-bottom:16px">
          <div class="dd-stat"><div class="dd-stat-label">Max Drawdown</div><div class="dd-stat-value" id="maxDDValue" style="color:#F87171">â€”</div><div class="dd-stat-sub" id="maxDDDate"></div></div>
          <div class="dd-stat"><div class="dd-stat-label">Current Drawdown</div><div class="dd-stat-value" id="curDDValue" style="color:#F87171">â€”</div></div>
        </div>
        <div class="chart-container" style="height:200px"><canvas id="drawdownChart"></canvas></div>
      </div>
    </div>
  </div>

  <!-- â•â•â• PERFORMANCE TAB â•â•â• -->
  <div class="tab-content" id="tab-performance">
    <div class="r-card">
      <div class="chart-title-row"><span class="chart-title-icon">ğŸ€</span><h3 class="chart-title">ALPHA GENERATION â€” FUND VS BTC</h3></div>
      <div class="chart-legend">
        <div class="legend-item"><div class="legend-swatch-line" style="background:#3B82F6"></div>Fund TWR</div>
        <div class="legend-item"><div class="legend-swatch-dashed"></div>BTC TWR</div>
        <div class="legend-item"><div class="legend-swatch-line" style="background:#8B5CF6"></div>BTC Price</div>
        <div class="legend-item"><div class="legend-swatch-bars"></div>Alpha Spread</div>
        <div class="legend-item"><div class="legend-swatch-dot" style="background:#4ADE80;box-shadow:0 0 6px rgba(74,222,128,0.5)"></div>TWAP Buy</div>
        <div class="legend-item"><div class="legend-swatch-dot" style="background:#60A5FA;box-shadow:0 0 6px rgba(96,165,250,0.5)"></div>Limit Buy</div>
      </div>
      <div class="chart-container"><canvas id="twrChart2"></canvas></div>
      <div class="narrative-box"><div class="narrative-title">ğŸ“Š Alpha Narrative</div><div class="narrative-text" id="commentary2">Loadingâ€¦</div></div>
    </div>
    <div class="r-card">
      <div class="section-title"><span class="section-icon">ğŸ“ˆ</span> Alpha Spread Over Time (Fund Return âˆ’ BTC Return)</div>
      <div class="chart-legend">
        <div class="legend-item"><div class="legend-swatch-line" style="background:#4ADE80"></div>Alpha</div>
        <div class="legend-item"><div class="legend-swatch-line" style="background:#8B5CF6"></div>BTC Price</div>
      </div>
      <div class="chart-container" style="height:260px"><canvas id="alphaSpreadChart"></canvas></div>
    </div>
    <div class="r-card">
      <div class="section-title">Drawdown from Peak</div>
      <div class="r-dd2" style="margin-bottom:16px">
        <div class="dd-stat"><div class="dd-stat-label">Max Drawdown</div><div class="dd-stat-value" id="maxDDValue2" style="color:#F87171">â€”</div><div class="dd-stat-sub" id="maxDDDate2"></div></div>
        <div class="dd-stat"><div class="dd-stat-label">Current Drawdown</div><div class="dd-stat-value" id="curDDValue2" style="color:#F87171">â€”</div></div>
      </div>
      <div class="chart-container" style="height:200px"><canvas id="drawdownChart2"></canvas></div>
    </div>
    <div class="r-grid2">
      <div class="r-card"><div class="section-title">Time-Weighted Returns</div><div class="tbl-wrap"><table class="r-tbl"><thead><tr><th>Asset</th><th>QTD P&L</th><th>QTD Ret</th><th>ITD P&L</th><th>ITD Ret</th></tr></thead><tbody id="mwrBody"></tbody></table></div></div>
      <div class="r-card"><div class="section-title">BTC Benchmark</div><div class="tbl-wrap"><table class="r-tbl"><thead><tr><th>Benchmark</th><th>QTD P&L</th><th>QTD Ret</th><th>ITD P&L</th><th>ITD Ret</th></tr></thead><tbody id="btcTwrBody"></tbody></table></div></div>
    </div>
  </div>

  <!-- â•â•â• ALLOCATION TAB â•â•â• -->
  <div class="tab-content" id="tab-allocation">
    <div class="r-card"><div class="section-title">Asset Allocation</div><div id="allocBars"></div></div>
    <div class="r-grid2">
      <div class="r-card"><div class="section-title">Allocation Chart</div><div class="chart-container" style="height:280px"><canvas id="holdingsChart"></canvas></div></div>
      <div class="r-card"><div class="section-title">Asset Breakdown</div><div class="tbl-wrap"><table class="r-tbl"><thead><tr><th>Asset</th><th>Amount</th><th>Price</th><th>Value</th><th>Weight</th></tr></thead><tbody id="allocTable"></tbody></table></div></div>
    </div>
    <div class="r-card"><div class="section-title">Custodian Breakdown</div><div class="tbl-wrap"><table class="r-tbl"><thead><tr><th>Asset</th><th>Venue</th><th>Amount</th><th>Price</th><th>Value</th></tr></thead><tbody id="venueTable"></tbody></table></div></div>
  </div>

  <!-- â•â•â• PURCHASES TAB â•â•â• -->
  <div class="tab-content" id="tab-tranches">
    <div class="r-card"><div class="section-title">Purchase Tranches</div><div class="tbl-wrap"><table class="r-tbl"><thead><tr><th>Tranche</th><th>Quantity</th><th>Avg Cost</th><th>Date</th><th>Current Value</th></tr></thead><tbody id="purchaseTable"></tbody></table></div></div>
    <div class="r-card">
      <div class="section-title">Cost Basis by Tranche</div>
      <div style="display:flex;justify-content:space-between;margin-bottom:12px;font-size:11px;font-family:'JetBrains Mono',monospace">
        <span style="color:#4ADE80">â— BTC Price: <span id="btcPriceLabel">â€”</span></span>
        <span style="color:#F7931A">â— Avg Cost: <span id="avgCostLabel">â€”</span></span>
      </div>
      <div id="costBars"></div>
    </div>
    <div class="r-card"><div class="section-title">Purchase Cost</div><div class="chart-container" style="height:280px"><canvas id="purchaseCostChart"></canvas></div></div>
  </div>

</div>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG (from index(4).html)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SHEET_ID = '1QiW-1REapN-UD76xTf5ne4P-J6cWvMPJuuVqaYATFk0';
const PUBLISH_ID = '2PACX-1vRwRHNmvnfYRYB3LRuUpLd2pt8R-RSSYYqU2DZ_QUoNRzFW0NmzZ2OsICbxX1xYc9l4ChniUmdwhDbF';
const TABS = {
  dashboard: 163729112,
  perfSummary: 828103600,
  returnsDaily: 1053773100,
  purchases: 1222270502,
  historicalPrices: 1760753841
};
const REFRESH_INTERVAL = 60000;
const INCEPTION_DATE = '2025-12-12';
const INCEPTION_AUM = 33770670.78;
const INCEPTION_BTC_PRICE = 90287.49;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let lastGoodData = null;
let charts = {};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CSV FETCHING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function csvUrl(gid) {
  return `https://docs.google.com/spreadsheets/d/e/${PUBLISH_ID}/pub?gid=${gid}&single=true&output=csv&_t=${Date.now()}`;
}

async function fetchCSV(gid) {
  const resp = await fetch(csvUrl(gid), {cache: 'no-store'});
  if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
  const text = await resp.text();
  if (!text || text.length < 10 || text.includes('<!DOCTYPE')) throw new Error('Got HTML instead of CSV for gid ' + gid);
  return Papa.parse(text, { header: false, skipEmptyLines: true }).data;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARSING HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parseNum(s) {
  if (!s || s === '-' || s === '') return null;
  return parseFloat(String(s).replace(/[$,%()]/g, '').replace(/\s/g, ''));
}
function parsePct(s) {
  if (!s || s === '-' || s === '') return null;
  let n = parseFloat(String(s).replace(/[%$,+]/g, '').replace(/[()]/g, m => m === '(' ? '-' : ''));
  if (String(s).includes('%')) return n / 100;
  return n;
}
function parseDollar(s) {
  if (!s || s === '-' || s === '') return null;
  let str = String(s).replace(/[$,\s]/g, '');
  if (str.startsWith('(') && str.endsWith(')')) str = '-' + str.slice(1, -1);
  return parseFloat(str);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FORMATTING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmtDollar(n, compact) {
  if (n == null || isNaN(n)) return 'â€”';
  if (compact && Math.abs(n) >= 1e6) return '$' + (n / 1e6).toFixed(2) + 'M';
  if (compact && Math.abs(n) >= 1e3) return '$' + (n / 1e3).toFixed(1) + 'K';
  return n < 0 
    ? '-$' + Math.abs(n).toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2})
    : '$' + n.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2});
}
function fmtPct(n, decimals=2) {
  if (n == null || isNaN(n)) return 'â€”';
  return (n * 100).toFixed(decimals) + '%';
}
function fmtPctRaw(n, decimals=2) {
  if (n == null || isNaN(n)) return 'â€”';
  return n.toFixed(decimals) + '%';
}
function fmtNum(n, decimals=2) {
  if (n == null || isNaN(n)) return 'â€”';
  return n.toLocaleString('en-US', {minimumFractionDigits:decimals, maximumFractionDigits:decimals});
}
function colorPct(el, val) {
  if (val == null) return;
  el.style.color = val >= 0 ? '#4ADE80' : '#F87171';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA PARSING FROM SHEETS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parseDashboard(rows) {
  const data = {};
  data.todayDate = rows[1]?.[2] || '';
  data.aum = parseDollar(rows[4]?.[1]);
  data.btcPrice = parseDollar(rows[4]?.[4]);
  data.btcHoldings = parseNum(rows[4]?.[7]);
  data.btcAvgCost = parseDollar(rows[5]?.[14]);
  data.btcAvgPurchasePrice = parseDollar(rows[6]?.[14]);
  data.twoPointFiveAUM = parseDollar(rows[7]?.[14]);
  data.mwrITDFund = parsePct(rows[8]?.[14]);
  data.itdTWRFund = parsePct(rows[10]?.[14]);
  data.itdTWRBTC = parsePct(rows[11]?.[14]);
  data.itdAlpha = parsePct(rows[12]?.[14]);
  data.qtdTWRFund = parsePct(rows[14]?.[14]);
  data.qtdTWRBTC = parsePct(rows[15]?.[14]);
  data.qtdAlpha = parsePct(rows[16]?.[14]);
  data.mwrRows = [];
  for (let i = 10; i <= 15; i++) {
    data.mwrRows.push({
      label: rows[i]?.[1] || '',
      qtdPnl: parseDollar(rows[i]?.[2]),
      qtdRet: parsePct(rows[i]?.[4]),
      itdPnl: parseDollar(rows[i]?.[6]),
      itdRet: parsePct(rows[i]?.[8])
    });
  }
  data.btcTWR = {
    label: rows[19]?.[1] || 'BTC (ALL TWR)',
    qtdPnl: parseDollar(rows[19]?.[2]),
    qtdRet: parsePct(rows[19]?.[4]),
    itdPnl: parseDollar(rows[19]?.[6]),
    itdRet: parsePct(rows[19]?.[8])
  };
  data.assets = [];
  for (let i = 23; i <= 27; i++) {
    const asset = rows[i]?.[1];
    if (!asset) continue;
    data.assets.push({
      asset: asset,
      amount: parseNum(rows[i]?.[2]),
      price: parseDollar(rows[i]?.[4]),
      aum: parseDollar(rows[i]?.[6]),
      pct: parseNum(rows[i]?.[8]?.replace('%','')) / 100
    });
  }
  data.venues = [];
  let currentAsset = '';
  for (let i = 31; i <= 44; i++) {
    const row = rows[i];
    if (!row) continue;
    const assetCol = row[1]?.trim();
    const venueCol = row[2]?.trim();
    if (assetCol && assetCol !== '') currentAsset = assetCol;
    if (venueCol && venueCol !== '') {
      data.venues.push({ asset: currentAsset, venue: venueCol, amount: row[4] || '', price: row[6] || '', value: row[8] || '' });
    } else if (assetCol) {
      data.venues.push({ asset: currentAsset, venue: '(Total)', amount: row[4] || '', price: row[6] || '', value: row[8] || '', isSummary: true });
    }
  }
  return data;
}

function parsePerfSummary(rows) {
  const data = {};
  data.inceptionDate = rows[3]?.[2];
  data.currentDate = rows[3]?.[4];
  data.quarterStart = rows[4]?.[2];
  data.daysSinceInception = parseNum(rows[4]?.[4]);
  data.itdFundTWR = parsePct(rows[8]?.[2]);
  data.itdBTCTWR = parsePct(rows[8]?.[3]);
  data.itdAlpha = parsePct(rows[8]?.[4]);
  data.inceptionBTCPrice = parseDollar(rows[12]?.[3]);
  data.currentBTCPrice = parseDollar(rows[13]?.[3]);
  data.itdPnLFund = parseDollar(rows[14]?.[2]);
  data.itdPnLBTC = parseDollar(rows[14]?.[3]);
  data.itdPnLAlpha = parseDollar(rows[14]?.[4]);
  data.qtdFundTWR = parsePct(rows[18]?.[2]);
  data.qtdBTCTWR = parsePct(rows[18]?.[3]);
  data.qtdAlpha = parsePct(rows[18]?.[4]);
  data.dec31BTCPrice = parseDollar(rows[21]?.[3]);
  data.qtdPnLFund = parseDollar(rows[22]?.[2]);
  data.qtdPnLBTC = parseDollar(rows[22]?.[3]);
  data.qtdPnLAlpha = parseDollar(rows[22]?.[4]);
  data.currentAUM = parseDollar(rows[25]?.[2]);
  data.totalCapitalInvested = parseDollar(rows[26]?.[2]);
  data.totalPnL = parseDollar(rows[27]?.[2]);
  data.btcHoldings = parseNum(rows[28]?.[2]);
  data.currentBTCPriceKM = parseDollar(rows[29]?.[3]);
  return data;
}

function parseReturnsDaily(rows) {
  const data = [];
  for (let i = 3; i < rows.length; i++) {
    const row = rows[i];
    if (!row || !row[0]) break;
    const date = row[0];
    const dailyTWR = parseNum(row[4]?.replace('%',''));
    const cumTWR = parseNum(row[5]?.replace('%',''));
    const portfolioValue = parseDollar(row[6]);
    const totalGL = parseDollar(row[7]);
    const btcHoldings = parseNum(row[9]);
    const btcPrice = parseDollar(row[10]);
    const btcMarketValue = parseDollar(row[12]);
    if (cumTWR == null && dailyTWR == null) continue;
    data.push({ date, dailyTWR, cumTWR, portfolioValue, totalGL, btcHoldings, btcPrice, btcMarketValue });
  }
  return data;
}

function parsePurchases(rows) {
  const purchases = [];
  for (let i = 3; i <= 20; i++) {
    const row = rows[i];
    if (!row || !row[1]) break;
    purchases.push({ token: row[1], venue: row[2], description: row[3], orderDate: row[4], fillDate: row[5], qty: parseNum(row[6]), basis: parseDollar(row[7]), value: parseDollar(row[8]) });
  }
  const inflows = [];
  for (let i = 3; i <= 20; i++) {
    const row = rows[i];
    if (!row || !row[10]) break;
    inflows.push({ stakeholder: row[10], person: row[11], asset: row[12], qty: row[13], basis: row[14], value: row[15], date: row[16] });
  }
  const stats = {};
  for (let i = 2; i <= 12; i++) {
    const row = rows[i];
    if (row && row[18]) stats[row[18].trim()] = row[19];
  }
  return { purchases, inflows, stats };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmtDollarCompact(n) {
  if (n == null || isNaN(n)) return 'â€”';
  if (Math.abs(n) >= 1e6) return '$' + (n/1e6).toFixed(2) + 'M';
  if (Math.abs(n) >= 1e3) return '$' + (n/1e3).toFixed(0) + 'K';
  return '$' + n.toFixed(0);
}

function makeBadge(val, prevVal, prevLabel) {
  if (val == null) return '';
  const isPos = val >= 0;
  const color = isPos ? '#4ADE80' : '#F87171';
  const arrow = isPos ? 'â–²' : 'â–¼';
  const bgClass = isPos ? 'hero-badge-pos' : 'hero-badge-neg';
  const pctStr = (isPos ? '+' : '') + (val * 100).toFixed(1) + '%';
  let html = `<span class="hero-badge ${bgClass}">`;
  html += `<span class="arrow" style="color:${color}">${arrow}</span>`;
  html += `<span class="pct" style="color:${color}">${pctStr}</span>`;
  if (prevLabel != null) {
    html += `<span class="sep">Â·</span><span class="detail">prev wk</span> <span class="detail-mono">${prevLabel}</span>`;
  }
  html += '</span>';
  return html;
}

function renderDrawdownStats(returnsDaily) {
  let peak = 1, maxDD = 0, maxDDDate = '', curDD = 0;
  for (const d of returnsDaily) {
    const cumVal = 1 + (d.cumTWR || 0) / 100;
    if (cumVal > peak) peak = cumVal;
    const dd = (cumVal - peak) / peak;
    if (dd < maxDD) { maxDD = dd; maxDDDate = d.date; }
    curDD = dd;
  }
  ['maxDDValue','maxDDValue2'].forEach(id => { const el = document.getElementById(id); if (el) el.textContent = fmtPctRaw(maxDD * 100); });
  ['maxDDDate','maxDDDate2'].forEach(id => { const el = document.getElementById(id); if (el) el.textContent = maxDDDate ? formatDateLabel(maxDDDate) : ''; });
  ['curDDValue','curDDValue2'].forEach(id => { const el = document.getElementById(id); if (el) el.textContent = fmtPctRaw(curDD * 100); });
}

function renderHero(dash, perf, returnsDaily) {
  // AUM
  const aum = perf?.currentAUM || dash.aum;
  document.getElementById('heroAUM').textContent = fmtDollar(aum, true);
  const aumDelta = (aum - INCEPTION_AUM) / INCEPTION_AUM;
  // Prev week AUM from returnsDaily
  let prevAUM = null;
  if (returnsDaily && returnsDaily.length > 7) prevAUM = returnsDaily[returnsDaily.length - 8]?.portfolioValue;
  const prevAUMDelta = prevAUM ? (aum - prevAUM) / prevAUM : aumDelta;
  document.getElementById('heroAUMBadge').innerHTML = makeBadge(prevAUMDelta, null, prevAUM ? fmtDollar(prevAUM, true) : fmtDollar(INCEPTION_AUM, true));

  // BTC Holdings
  document.getElementById('heroBTC').textContent = fmtNum(dash.btcHoldings);
  let prevBTC = null;
  if (returnsDaily && returnsDaily.length > 7) prevBTC = returnsDaily[returnsDaily.length - 8]?.btcHoldings;
  const btcDelta = prevBTC ? (dash.btcHoldings - prevBTC) / prevBTC : null;
  document.getElementById('heroBTCBadge').innerHTML = btcDelta != null ? makeBadge(btcDelta, null, fmtNum(prevBTC)) : '';

  // BTC hover to show USD
  const btcCard = document.getElementById('heroBTCCardHover');
  const btcValEl = document.getElementById('heroBTC');
  const btcHintEl = document.getElementById('heroBTCHint');
  btcCard.onmouseenter = () => { btcValEl.textContent = fmtDollar(dash.btcHoldings * dash.btcPrice, true); btcHintEl.style.opacity = '0'; };
  btcCard.onmouseleave = () => { btcValEl.textContent = fmtNum(dash.btcHoldings); btcHintEl.style.opacity = '1'; };

  // BTC Price
  document.getElementById('heroBTCPrice').textContent = fmtDollar(dash.btcPrice);
  const priceDelta = (dash.btcPrice - INCEPTION_BTC_PRICE) / INCEPTION_BTC_PRICE;
  const prevPrice = returnsDaily && returnsDaily.length > 7 ? returnsDaily[returnsDaily.length - 8]?.btcPrice : null;
  document.getElementById('heroBTCPriceBadge').innerHTML = makeBadge(priceDelta, null, prevPrice ? fmtDollar(prevPrice, true) : fmtDollar(INCEPTION_BTC_PRICE, true));

  // Avg Cost Basis
  const avgCost = dash.btcAvgCost || 88923;
  document.getElementById('heroAvgCost').textContent = fmtDollar(avgCost);
  const aboveSpot = avgCost - dash.btcPrice;
  const aboveColor = aboveSpot > 0 ? '#F7931A' : '#4ADE80';
  document.getElementById('heroAvgCostBadge').innerHTML = `<span class="hero-badge hero-badge-orange"><span class="pct" style="color:${aboveColor}">${fmtDollarCompact(Math.abs(aboveSpot))}</span><span class="sep">Â·</span><span class="detail">${aboveSpot > 0 ? 'above spot' : 'below spot'}</span></span>`;

  // Date
  document.getElementById('headerDate').textContent = dash.todayDate || new Date().toLocaleDateString('en-US', {year:'numeric', month:'long', day:'numeric'});
}

function renderITDQTD(dash, perf) {
  const setReturn = (id, val) => {
    const el = document.getElementById(id);
    if (!el) return;
    if (val == null) { el.textContent = 'â€”'; return; }
    el.textContent = (val >= 0 ? '+' : '') + fmtPct(val);
    el.style.color = val >= 0 ? '#4ADE80' : '#F87171';
    const bar = el.closest('.return-item')?.querySelector('.return-bar');
    if (bar) bar.style.background = val >= 0 ? '#4ADE80' : '#F87171';
  };

  const itdFund = perf?.itdFundTWR ?? dash.itdTWRFund;
  const itdBTC = perf?.itdBTCTWR ?? dash.itdTWRBTC;
  const itdAlpha = perf?.itdAlpha ?? dash.itdAlpha;
  const qtdFund = perf?.qtdFundTWR ?? dash.qtdTWRFund;
  const qtdBTC = perf?.qtdBTCTWR ?? dash.qtdTWRBTC;
  const qtdAlpha = perf?.qtdAlpha ?? dash.qtdAlpha;

  setReturn('itdFund', itdFund);
  setReturn('itdBTC', itdBTC);
  setReturn('qtdFund', qtdFund);
  setReturn('qtdBTC', qtdBTC);

  // Alpha boxes
  const renderAlpha = (id, val, prevPP, prevPct) => {
    const el = document.getElementById(id);
    if (!el) return;
    if (val == null) { el.textContent = 'â€”'; return; }
    const isPos = val >= 0;
    el.textContent = (isPos ? '+' : '') + fmtPct(val);
    el.className = isPos ? 'alpha-value' : 'alpha-value alpha-value-neg';
    const badgeEl = document.getElementById(id === 'itdAlpha' ? 'itdAlphaBadge' : 'qtdAlphaBadge');
    if (badgeEl && prevPP) {
      badgeEl.innerHTML = `<span class="alpha-badge"><span class="arrow">â–²</span><span class="val">${prevPP}</span><span class="sep">Â·</span><span class="detail">prev wk</span> <span class="detail-mono">${prevPct}</span></span>`;
    }
  };

  renderAlpha('itdAlpha', itdAlpha, '+1.68pp', '+2.17%');
  renderAlpha('qtdAlpha', qtdAlpha, '+1.79pp', '+1.51%');
}

function renderMWR(dash) {
  const tbody = document.getElementById('mwrBody');
  tbody.innerHTML = '';
  dash.mwrRows.forEach((r, i) => {
    if (!r.label) return;
    const tr = document.createElement('tr');
    if (i === 0) tr.className = 'tbl-bold';
    tr.innerHTML = `
      <td>${r.label}</td>
      <td style="color:${(r.qtdPnl||0) >= 0 ? '#4ADE80' : '#F87171'}">${fmtDollar(r.qtdPnl)}</td>
      <td style="color:${(r.qtdRet||0) >= 0 ? '#4ADE80' : '#F87171'}">${fmtPct(r.qtdRet)}</td>
      <td style="color:${(r.itdPnl||0) >= 0 ? '#4ADE80' : '#F87171'}">${fmtDollar(r.itdPnl)}</td>
      <td style="color:${(r.itdRet||0) >= 0 ? '#4ADE80' : '#F87171'}">${fmtPct(r.itdRet)}</td>`;
    tbody.appendChild(tr);
  });
}

function renderBTCTWR(dash) {
  const tbody = document.getElementById('btcTwrBody');
  tbody.innerHTML = '';
  const r = dash.btcTWR;
  const tr = document.createElement('tr');
  tr.className = 'tbl-bold';
  tr.innerHTML = `
    <td>${r.label}</td>
    <td style="color:${(r.qtdPnl||0) >= 0 ? '#4ADE80' : '#F87171'}">${fmtDollar(r.qtdPnl)}</td>
    <td style="color:${(r.qtdRet||0) >= 0 ? '#4ADE80' : '#F87171'}">${fmtPct(r.qtdRet)}</td>
    <td style="color:${(r.itdPnl||0) >= 0 ? '#4ADE80' : '#F87171'}">${fmtDollar(r.itdPnl)}</td>
    <td style="color:${(r.itdRet||0) >= 0 ? '#4ADE80' : '#F87171'}">${fmtPct(r.itdRet)}</td>`;
  tbody.appendChild(tr);
}

function renderKeyMetrics(dash, perf, purchData) {
  const container = document.getElementById('keyMetricsDetail');
  const stats = purchData?.stats || {};
  const items = [
    { label: 'BTC Avg Cost (Portfolio)', value: fmtDollar(parseDollar(dash.btcAvgCost) || parseDollar(stats['Total Portfolio Average Cost'])) },
    { label: 'BTC Avg Purchase Price', value: fmtDollar(parseDollar(dash.btcAvgPurchasePrice) || parseDollar(stats['Average Purchase Price'])) },
    { label: 'Inception BTC Price', value: fmtDollar(perf?.inceptionBTCPrice || INCEPTION_BTC_PRICE) },
    { label: 'Current BTC Price', value: fmtDollar(dash.btcPrice) },
    { label: '2.5% of AUM', value: fmtDollar(parseDollar(dash.twoPointFiveAUM)) },
    { label: 'MWR ITD Return (Fund)', value: fmtPct(dash.mwrITDFund) },
    { label: 'Total Capital Invested', value: fmtDollar(perf?.totalCapitalInvested) },
    { label: 'Total P&L', value: fmtDollar(perf?.totalPnL) },
  ];
  container.innerHTML = items.map(i => `
    <div class="metric-box">
      <div class="metric-label">${i.label}</div>
      <div class="metric-value" style="font-size:14px">${i.value}</div>
    </div>`).join('');
}

function renderAllocation(dash) {
  const colors = { BTC: '#F7931A', WBTC: '#8B5CF6', USDC: '#22D3EE', Cash: '#94A3B8', ETH: '#627EEA' };
  const barsEl = document.getElementById('allocBars');
  barsEl.innerHTML = '';
  dash.assets.forEach(a => {
    const pctStr = ((a.pct || 0) * 100).toFixed(2);
    const barWidth = Math.max(2, (a.pct || 0) * 100);
    barsEl.innerHTML += `
      <div class="alloc-bar-row">
        <div class="alloc-label">${a.asset}</div>
        <div class="alloc-bar-track">
          <div class="alloc-bar-fill" style="width:${barWidth}%;background:${colors[a.asset] || '#4ADE80'}">
            ${barWidth > 15 ? fmtDollar(a.aum, true) : ''}
          </div>
        </div>
        <div class="alloc-pct">${pctStr}%</div>
      </div>`;
  });
  const tbody = document.getElementById('allocTable');
  tbody.innerHTML = '';
  dash.assets.forEach(a => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${colors[a.asset] || '#4ADE80'};margin-right:6px"></span>${a.asset}</td>
      <td>${fmtNum(a.amount, a.asset === 'USDC' || a.asset === 'Cash' ? 2 : a.amount < 1 ? 4 : 2)}</td>
      <td>${fmtDollar(a.price)}</td>
      <td>${fmtDollar(a.aum)}</td>
      <td>${((a.pct || 0) * 100).toFixed(2)}%</td>`;
    tbody.appendChild(tr);
  });
}

function renderVenues(dash) {
  const tbody = document.getElementById('venueTable');
  tbody.innerHTML = '';
  dash.venues.forEach(v => {
    const tr = document.createElement('tr');
    if (v.isSummary) tr.className = 'tbl-bold';
    tr.innerHTML = `<td>${v.isSummary ? v.asset : ''}</td><td>${v.isSummary ? '' : v.venue}</td><td>${v.amount}</td><td>${v.price}</td><td>${v.value}</td>`;
    tbody.appendChild(tr);
  });
}

function renderPurchases(purchData, dash) {
  const ptbody = document.getElementById('purchaseTable');
  ptbody.innerHTML = '';
  purchData.purchases.forEach(p => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${p.description || p.token}</td><td>${fmtNum(p.qty, 4)}</td><td>${fmtDollar(p.basis)}</td><td>${p.fillDate || p.orderDate || ''}</td><td>${fmtDollar(p.value)}</td>`;
    ptbody.appendChild(tr);
  });
  const itbody = document.getElementById('inflowsTable');
  itbody.innerHTML = '';
  purchData.inflows.forEach(inf => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${inf.stakeholder}</td><td>${inf.person}</td><td>${inf.asset}</td><td>${inf.qty}</td><td>${inf.value}</td><td>${inf.date}</td>`;
    itbody.appendChild(tr);
  });
  const costEl = document.getElementById('costBars');
  costEl.innerHTML = '';
  const allCosts = purchData.purchases.map(p => p.basis).filter(x => x != null);
  const maxCost = Math.max(...allCosts, dash.btcPrice || 0, INCEPTION_BTC_PRICE) * 1.05;
  const btcPricePct = ((dash.btcPrice || 0) / maxCost) * 100;
  purchData.purchases.forEach(p => {
    if (!p.basis) return;
    const width = (p.basis / maxCost) * 100;
    const isAbovePrice = p.basis > (dash.btcPrice || 0);
    costEl.innerHTML += `
      <div class="cost-bar-row">
        <div class="cost-bar-label">${p.description?.split(' - ')[0] || p.token}</div>
        <div class="cost-bar-track" style="position:relative">
          <div class="cost-bar-fill" style="width:${width}%;background:${isAbovePrice ? 'rgba(248,113,113,0.6)' : 'rgba(74,222,128,0.6)'}">
            ${fmtDollar(p.basis)}
          </div>
          <div style="position:absolute;left:${btcPricePct}%;top:0;bottom:0;width:2px;background:#4ADE80;opacity:0.6"></div>
        </div>
      </div>`;
  });
  document.getElementById('avgCostLabel').textContent = fmtDollar(parseDollar(dash.btcAvgCost));
  document.getElementById('btcPriceLabel').textContent = fmtDollar(dash.btcPrice);
}

function renderCommentary(dash, perf) {
  const alpha = perf?.itdAlpha ?? dash.itdAlpha;
  const alphaStr = alpha ? '+' + (alpha * 100).toFixed(2) + '%' : '?';
  const avgCost = fmtDollar(dash.btcAvgCost);
  const text = `The fund has consistently outperformed a passive BTC hold by <span class="hl-green">${alphaStr}</span> ITD through disciplined TWAP execution and opportunistic limit orders during drawdowns. Key alpha drivers: deploying capital via 7-day TWAPs to smooth entry prices, and aggressive limit buys during the Feb sell-off (entries at <span class="hl-orange">$78.5K</span> and <span class="hl-orange">$63.1K</span> vs inception at <span class="hl-orange">$90.3K</span>), lowering the blended cost basis from $90,287 to ${avgCost}. The <span class="hl-green">green bars</span> show periods of outperformance and <span class="hl-red">red bars</span> show underperformance â€” notice how decision points consistently widen the alpha gap.`;
  document.getElementById('commentary').innerHTML = text;
  const c2 = document.getElementById('commentary2');
  if (c2) c2.innerHTML = text;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHART RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const chartTooltip = {
  backgroundColor: 'rgba(15,23,42,0.95)',
  titleColor: '#F1F5F9', bodyColor: '#CBD5E1',
  borderColor: 'rgba(148,163,184,0.15)', borderWidth: 1, padding: 14,
  titleFont: { family: "'JetBrains Mono', monospace", size: 13, weight: 'bold' },
  bodyFont: { family: "'JetBrains Mono', monospace", size: 12 },
};
const axisFont = { family: "'JetBrains Mono', monospace", size: 10 };

function formatDateLabel(dateStr) {
  if (!dateStr) return '';
  const d = new Date(dateStr);
  if (isNaN(d)) return dateStr;
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function buildChartData(returnsDaily) {
  const labels = [], fundData = [], btcTWRData = [], btcPriceData = [], alphaData = [];
  for (const d of returnsDaily) {
    labels.push(formatDateLabel(d.date));
    const fund = d.cumTWR != null ? d.cumTWR : null;
    fundData.push(fund);
    const btcTWR = d.btcPrice ? ((d.btcPrice / INCEPTION_BTC_PRICE) - 1) * 100 : null;
    btcTWRData.push(btcTWR);
    btcPriceData.push(d.btcPrice);
    alphaData.push(fund != null && btcTWR != null ? fund - btcTWR : null);
  }
  return { labels, fundData, btcTWRData, btcPriceData, alphaData };
}

function makeAnnotations(labels) {
  const a = {};
  DECISIONS.forEach((dec, i) => {
    const idx = labels.findIndex(l => l === dec.date);
    if (idx === -1) return;
    a['line'+i] = { type:'line', xMin:idx, xMax:idx, borderColor:'rgba(148,163,184,0.2)', borderWidth:1, borderDash:[4,4] };
    a['label'+i] = { type:'label', xValue:idx, yValue:10, content:dec.label,
      color: dec.type==='opportunistic'?'#60A5FA':'#4ADE80',
      font:{size:10,weight:'bold',family:"'JetBrains Mono',monospace"}, position:'start' };
  });
  return a;
}

function makeTWRChart(canvasId, returnsDaily, chartKey) {
  const ctx = document.getElementById(canvasId)?.getContext('2d');
  if (!ctx) return;
  if (charts[chartKey]) charts[chartKey].destroy();
  const { labels, fundData, btcTWRData, btcPriceData, alphaData } = buildChartData(returnsDaily);
  charts[chartKey] = new Chart(ctx, {
    data: {
      labels,
      datasets: [
        { type:'bar', label:'Alpha Spread', data:alphaData, backgroundColor:alphaData.map(v=>v!=null&&v>=0?'rgba(34,197,94,0.5)':'rgba(239,68,68,0.5)'), borderWidth:0, barPercentage:1.0, categoryPercentage:1.0, yAxisID:'y', order:3 },
        { type:'line', label:'Fund TWR', data:fundData, borderColor:'#3B82F6', borderWidth:2, fill:false, tension:0.3, pointRadius:0, pointHoverRadius:4, yAxisID:'y', order:1 },
        { type:'line', label:'BTC TWR', data:btcTWRData, borderColor:'#F7931A', borderWidth:2, borderDash:[6,3], fill:false, tension:0.3, pointRadius:0, pointHoverRadius:4, yAxisID:'y', order:2 },
        { type:'line', label:'BTC Price', data:btcPriceData, borderColor:'#8B5CF6', borderWidth:1.5, fill:false, tension:0.3, pointRadius:0, pointHoverRadius:4, yAxisID:'y1', order:2 }
      ]
    },
    options: {
      responsive:true, maintainAspectRatio:false,
      interaction:{mode:'index',intersect:false},
      plugins:{
        legend:{display:false},
        annotation:{annotations:makeAnnotations(labels)},
        tooltip:{...chartTooltip, callbacks:{
          label(ctx){
            if(ctx.dataset.label==='BTC Price') return `BTC Price  $${ctx.raw?.toLocaleString()}`;
            if(ctx.dataset.label==='Alpha Spread') return `Alpha  ${ctx.raw>=0?'+':''}${ctx.raw?.toFixed(2)}%`;
            return `${ctx.dataset.label}  ${ctx.raw?.toFixed(2)}%`;
          }
        }}
      },
      scales:{
        x:{grid:{color:'rgba(148,163,184,0.06)'},ticks:{color:'#596882',font:axisFont,maxTicksLimit:12}},
        y:{position:'left',grid:{color:'rgba(148,163,184,0.06)'},ticks:{color:'#596882',font:axisFont,callback:v=>v+'%'}},
        y1:{position:'right',grid:{display:false},ticks:{color:'#8B5CF6',font:axisFont,callback:v=>'$'+(v/1000).toFixed(0)+'K'}}
      }
    }
  });
}

function makeDrawdownChart(canvasId, returnsDaily, chartKey) {
  const ctx = document.getElementById(canvasId)?.getContext('2d');
  if (!ctx) return;
  if (charts[chartKey]) charts[chartKey].destroy();
  const labels = [], ddData = [];
  let peak = 1;
  for (const d of returnsDaily) {
    labels.push(formatDateLabel(d.date));
    const cumVal = 1 + (d.cumTWR||0)/100;
    if (cumVal > peak) peak = cumVal;
    ddData.push(((cumVal-peak)/peak)*100);
  }
  charts[chartKey] = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets: [{ label: 'Drawdown', data: ddData, borderColor: '#F87171', backgroundColor: 'rgba(248,113,113,0.08)', borderWidth: 1.5, fill: true, tension: 0.3, pointRadius: 0, pointHoverRadius: 4 }] },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false }, tooltip: { ...chartTooltip, bodyColor: '#F87171', borderColor: 'rgba(248,113,113,0.2)', callbacks: { label: ctx => `Drawdown: ${ctx.raw?.toFixed(2)}%` } } },
      scales: {
        x: { grid: { color: 'rgba(148,163,184,0.05)' }, ticks: { color: '#596882', font: axisFont, maxTicksLimit: 12 } },
        y: { grid: { color: 'rgba(148,163,184,0.05)' }, ticks: { color: '#596882', font: axisFont, callback: v => v + '%' }, max: 0 }
      }
    }
  });
}

function renderHoldingsChart(returnsDaily) {
  const ctx = document.getElementById('holdingsChart')?.getContext('2d');
  if (!ctx) return;
  if (charts.holdings) charts.holdings.destroy();
  const labels = [], holdingsData = [], priceData = [];
  for (const d of returnsDaily) {
    labels.push(formatDateLabel(d.date));
    holdingsData.push(d.btcHoldings);
    priceData.push(d.btcPrice);
  }
  charts.holdings = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets: [
      { label: 'BTC Holdings', data: holdingsData, borderColor: '#4ADE80', borderWidth: 2, fill: false, tension: 0.3, pointRadius: 0, yAxisID: 'y' },
      { label: 'BTC Price', data: priceData, borderColor: '#8B5CF6', borderWidth: 1.5, fill: false, tension: 0.3, pointRadius: 0, yAxisID: 'y1' }
    ] },
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: { legend: { display: false }, tooltip: { ...chartTooltip, callbacks: { label: ctx => ctx.datasetIndex === 0 ? `Holdings: ${ctx.raw?.toFixed(2)} BTC` : `BTC Price: $${ctx.raw?.toLocaleString()}` } } },
      scales: {
        x: { grid: { color: 'rgba(148,163,184,0.05)' }, ticks: { color: '#596882', font: axisFont, maxTicksLimit: 12 } },
        y: { position: 'left', grid: { color: 'rgba(148,163,184,0.05)' }, ticks: { color: '#4ADE80', font: axisFont, callback: v => v.toFixed(0) + ' BTC' } },
        y1: { position: 'right', grid: { display: false }, ticks: { color: '#8B5CF6', font: axisFont, callback: v => '$' + (v/1000).toFixed(0) + 'K' } }
      }
    }
  });
}

function renderAlphaSpreadChart(returnsDaily) {
  const ctx = document.getElementById('alphaSpreadChart')?.getContext('2d');
  if (!ctx) return;
  if (charts.alphaSpread) charts.alphaSpread.destroy();
  const { labels, fundData, btcTWRData, btcPriceData, alphaData } = buildChartData(returnsDaily);
  charts.alphaSpread = new Chart(ctx, {
    data: {
      labels,
      datasets: [
        { type:'line', label:'Alpha', data:alphaData, borderColor:'#4ADE80', borderWidth:2, fill:false, tension:0.3, pointRadius:0, pointHoverRadius:4, yAxisID:'y' },
        { type:'line', label:'BTC Price', data:btcPriceData, borderColor:'#8B5CF6', borderWidth:1.5, fill:false, tension:0.3, pointRadius:0, pointHoverRadius:4, yAxisID:'y1' }
      ]
    },
    options: {
      responsive:true, maintainAspectRatio:false,
      interaction:{mode:'index',intersect:false},
      plugins:{legend:{display:false},tooltip:{...chartTooltip,callbacks:{
        label(ctx){ return ctx.dataset.label==='BTC Price'?`BTC Price  $${ctx.raw?.toLocaleString()}`:`Alpha  ${ctx.raw>=0?'+':''}${ctx.raw?.toFixed(2)}%`; }
      }}},
      scales:{
        x:{grid:{color:'rgba(148,163,184,0.06)'},ticks:{color:'#596882',font:axisFont,maxTicksLimit:12}},
        y:{position:'left',grid:{color:'rgba(148,163,184,0.06)'},ticks:{color:'#4ADE80',font:axisFont,callback:v=>v+'%'}},
        y1:{position:'right',grid:{display:false},ticks:{color:'#8B5CF6',font:axisFont,callback:v=>'$'+(v/1000).toFixed(0)+'K'}}
      }
    }
  });
}

function renderPurchaseCostChart(purchData, dash) {
  const ctx = document.getElementById('purchaseCostChart')?.getContext('2d');
  if (!ctx) return;
  if (charts.purchCost) charts.purchCost.destroy();
  const labels = [], costs = [], colors = [];
  purchData.purchases.forEach(p => {
    if (!p.basis) return;
    labels.push(p.description?.split(' - ')[0] || p.token);
    costs.push(p.basis);
    colors.push(p.basis > (dash.btcPrice||0) ? 'rgba(248,113,113,0.6)' : 'rgba(74,222,128,0.6)');
  });
  charts.purchCost = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [{ label:'Cost Basis', data:costs, backgroundColor:colors, borderWidth:0, borderRadius:4 }] },
    options: {
      responsive:true, maintainAspectRatio:false, indexAxis:'y',
      plugins:{legend:{display:false},tooltip:{...chartTooltip,callbacks:{label:ctx=>`Cost: $${ctx.raw?.toLocaleString()}`}},
        annotation:{annotations:{
          btcLine:{type:'line',xMin:dash.btcPrice,xMax:dash.btcPrice,borderColor:'#4ADE80',borderWidth:2,borderDash:[4,4],label:{display:true,content:'BTC Price',position:'start',color:'#4ADE80',font:{size:10}}}
        }}
      },
      scales:{
        x:{grid:{color:'rgba(148,163,184,0.06)'},ticks:{color:'#596882',font:axisFont,callback:v=>'$'+(v/1000).toFixed(0)+'K'}},
        y:{grid:{display:false},ticks:{color:'#94A3B8',font:{...axisFont,size:9}}}
      }
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('tabBar').addEventListener('click', e => {
  const btn = e.target.closest('button');
  if (!btn || !btn.dataset.tab) return;
  document.querySelectorAll('#tabBar button').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.getElementById('tab-' + btn.dataset.tab)?.classList.add('active');
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN DATA LOADING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadAllData() {
  try {
    const [dashRows, perfRows, returnsRows, purchRows] = await Promise.all([
      fetchCSV(TABS.dashboard),
      fetchCSV(TABS.perfSummary),
      fetchCSV(TABS.returnsDaily),
      fetchCSV(TABS.purchases)
    ]);
    
    const dash = parseDashboard(dashRows);
    const perf = parsePerfSummary(perfRows);
    const returnsDaily = parseReturnsDaily(returnsRows);
    const purchData = parsePurchases(purchRows);
    
    lastGoodData = { dash, perf, returnsDaily, purchData };
    
    renderHero(dash, perf, returnsDaily);
    renderITDQTD(dash, perf);
    renderKeyMetrics(dash, perf, purchData);
    renderMWR(dash);
    renderBTCTWR(dash);
    renderAllocation(dash);
    renderVenues(dash);
    renderPurchases(purchData, dash);
    renderCommentary(dash, perf);
    renderDrawdownStats(returnsDaily);
    
    // Charts
    makeTWRChart('twrChart', returnsDaily, 'twr');
    makeTWRChart('twrChart2', returnsDaily, 'twr2');
    makeDrawdownChart('drawdownChart', returnsDaily, 'dd');
    makeDrawdownChart('drawdownChart2', returnsDaily, 'dd2');
    renderHoldingsChart(returnsDaily);
    renderAlphaSpreadChart(returnsDaily);
    renderPurchaseCostChart(purchData, dash);
    
    const now = new Date();
    const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    document.getElementById('lastUpdate').textContent = `Updated ${timeStr}`;
    document.getElementById('lastUpdateSidebar').textContent = `Updated ${timeStr}`;
    
    document.getElementById('errorBanner').style.display = 'none';
    
  } catch (err) {
    console.error('Data fetch error:', err);
    const banner = document.getElementById('errorBanner');
    banner.textContent = `âš  Data refresh failed: ${err.message}. Showing last good data. Retrying in 60sâ€¦`;
    banner.style.display = 'block';
    if (!lastGoodData) {
      document.getElementById('lastUpdate').textContent = 'Failed to load â€” retryingâ€¦';
    }
  }
  
  document.getElementById('loadingOverlay').classList.add('hidden');
  document.getElementById('mainContainer').classList.add('visible');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT & AUTO-REFRESH (synced to top of each minute)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init() {
  await loadAllData();

  function secsUntilTop() {
    var sec = new Date().getSeconds();
    return sec === 0 ? 60 : 60 - sec;
  }

  function scheduleNext() {
    var wait = secsUntilTop();
    var cd = document.getElementById('countdown');
    var remaining = wait;
    cd.textContent = remaining + 's';
    var tick = setInterval(function() {
      remaining--;
      if (remaining <= 0) {
        clearInterval(tick);
        cd.textContent = 'â€¦';
        loadAllData().then(function() { scheduleNext(); }).catch(function() { scheduleNext(); });
      } else {
        cd.textContent = remaining + 's';
      }
    }, 1000);
  }
  scheduleNext();
}

init();
</script>
</body>
</html>
