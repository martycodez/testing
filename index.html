<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=5.0">
<title>Clover Capital â€” Portfolio Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;0,9..40,800;1,9..40,400&family=JetBrains+Mono:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/3.0.1/chartjs-plugin-annotation.min.js"></script>
<style>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CLOVER CAPITAL â€” DESIGN SYSTEM CSS
   Matches clover-design-system.jsx tokens exactly
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* === RESET === */
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
html{-webkit-text-size-adjust:100%;scroll-behavior:smooth;overflow-x:hidden}
body{background:#0B1120;overflow-x:hidden;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
  font-family:'DM Sans',sans-serif;color:#F1F5F9;min-height:100vh;
  background:linear-gradient(135deg,#0B1120 0%,#0F172A 40%,#111827 100%)}

/* === SCROLLBARS === */
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:#334155;border-radius:4px}
::-webkit-scrollbar-thumb:hover{background:#475569}
.r-tabs::-webkit-scrollbar{display:none}

/* === INTERACTIONS === */
button{-webkit-tap-highlight-color:transparent;cursor:pointer;transition:all .2s ease}
button:active{transform:scale(0.97)}

/* === PAGE SHELL === */
.page-shell{position:relative;z-index:1;max-width:1280px;margin:0 auto;padding:24px 20px}
.orb-orange{position:fixed;top:-200px;right:-200px;width:500px;height:500px;background:radial-gradient(circle,rgba(247,147,26,0.06) 0%,transparent 70%);pointer-events:none;z-index:0}
.orb-blue{position:fixed;bottom:-200px;left:-100px;width:600px;height:600px;background:radial-gradient(circle,rgba(59,130,246,0.04) 0%,transparent 70%);pointer-events:none;z-index:0}

/* === ERROR BANNER === */
.error-banner{display:none;background:rgba(239,68,68,0.12);border:1px solid rgba(239,68,68,0.25);color:#FCA5A5;padding:10px 20px;border-radius:10px;font-size:12px;font-family:'JetBrains Mono',monospace;margin-bottom:16px}

/* === LOADING OVERLAY === */
.loading-overlay{position:fixed;inset:0;background:#0B1120;display:flex;align-items:center;justify-content:center;z-index:999;transition:opacity .5s}
.loading-overlay.hidden{opacity:0;pointer-events:none}
.loading-icon{width:112px;height:112px;border-radius:28px;background:linear-gradient(135deg,#22C55E,#15803D);display:inline-flex;align-items:center;justify-content:center;margin-bottom:24px;box-shadow:0 8px 40px rgba(34,197,94,0.4);animation:bounce 1.2s ease-in-out infinite}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-14px)}}
@keyframes fadeInOut{0%,100%{opacity:0.4}50%{opacity:1}}

/* === CARD (glassmorphic) === */
.r-card{background:rgba(15,23,42,0.65);backdrop-filter:blur(20px);border:1px solid rgba(148,163,184,0.1);border-radius:16px;padding:24px;margin-bottom:14px}

/* === HEADER === */
.r-header{margin-bottom:28px;display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:16px}
.header-left{display:flex;flex-direction:column;gap:4px}
.header-brand{display:flex;align-items:center;gap:12px;margin-bottom:4px}
.header-logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#22C55E,#15803D);display:flex;align-items:center;justify-content:center;box-shadow:0 4px 20px rgba(34,197,94,0.3);font-size:18px;color:#fff}
.header-title{margin:0;font-size:22px;font-weight:700;font-family:'Playfair Display',serif;background:linear-gradient(135deg,#F1F5F9,#94A3B8);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.header-date{margin:0;color:#F1F5F9;font-size:13px}
.header-right{display:flex;flex-direction:column;align-items:flex-end;gap:12px}

/* === LIVE PILL === */
.live-pill{display:flex;align-items:center;gap:8px;background:rgba(34,197,94,0.08);border:1px solid rgba(34,197,94,0.2);border-radius:20px;padding:5px 14px 5px 10px;white-space:nowrap}
.live-dot{width:8px;height:8px;border-radius:50%;background:#4ADE80;box-shadow:0 0 8px rgba(74,222,128,0.6);animation:pulse-dot 2s ease-in-out infinite}
@keyframes pulse-dot{0%,100%{opacity:1;box-shadow:0 0 8px rgba(74,222,128,0.6)}50%{opacity:0.5;box-shadow:0 0 4px rgba(74,222,128,0.3)}}
.live-text{font-size:12px;font-weight:700;color:#4ADE80;font-family:'JetBrains Mono',monospace;letter-spacing:1px}
.live-cd{font-size:12px;color:#94A3B8;font-family:'JetBrains Mono',monospace;min-width:24px;text-align:right}

/* === TABS === */
.r-tabs{display:flex;gap:6px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;-ms-overflow-style:none;padding-bottom:3px;flex-shrink:0}
.r-tabs button{background:rgba(148,163,184,0.06);color:#B0BEC5;border:1px solid rgba(148,163,184,0.1);border-radius:8px;padding:6px 14px;font-size:13px;font-weight:600;font-family:'DM Sans',sans-serif;transition:all .2s}
.r-tabs button.active{background:rgba(74,222,128,0.15);color:#4ADE80;border-color:rgba(74,222,128,0.3)}
.r-tabs button:hover:not(.active){background:rgba(148,163,184,0.1)}

/* === TAB CONTENT === */
.tab-content{display:none}.tab-content.active{display:block}

/* === HERO GRID (4 columns) === */
.r-hero4{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:14px}
.hero-card{padding:24px 20px}
.hero-hdr{display:flex;align-items:center;gap:8px;margin-bottom:16px}
.hero-bar{width:4px;height:18px;border-radius:2px}
.hero-lbl{font-size:14px;font-weight:700;font-family:'DM Sans',sans-serif;color:#CBD5E1}
.hero-val{font-size:34px;font-weight:800;font-family:'DM Sans',sans-serif;color:#F1F5F9;line-height:1;margin-bottom:14px;text-align:center}
.hero-ctr{text-align:center}
.hero-hint{font-size:11px;color:#F1F5F9;text-align:right;transition:opacity .2s;margin-left:auto}

/* === DELTA PILL (badge) === */
.badge{display:inline-flex;align-items:center;gap:4px;border-radius:20px;padding:4px 10px;white-space:nowrap}
.badge-pos{background:rgba(34,197,94,0.12)}
.badge-neg{background:rgba(248,113,113,0.12)}
.badge-orange{background:rgba(247,147,26,0.12)}
.badge .arr{font-size:11px}
.badge .pv{font-size:12px;font-family:'JetBrains Mono',monospace;font-weight:700}
.badge .sp{font-size:11px;color:#CBD5E1;margin:0 1px}
.badge .dt{font-size:11px;color:#CBD5E1}
.badge .dm{font-size:11px;font-family:'JetBrains Mono',monospace;font-weight:600;color:#CBD5E1}

/* === ITD / QTD SPLIT PANEL === */
.r-itdqtd{display:grid;grid-template-columns:1fr 1fr;padding:0;overflow:hidden}
.r-itdqtd .itd-h{padding:28px 32px 24px}
.r-itdqtd .itd-h:first-child{border-right:1px solid rgba(148,163,184,0.08)}
.itd-tr{display:flex;align-items:center;gap:10px;margin-bottom:4px}
.itd-bar{width:5px;height:22px;border-radius:3px}
.itd-t{font-size:18px;font-weight:800;font-family:'DM Sans',sans-serif;color:#F1F5F9;letter-spacing:0.5px}
.itd-st{font-size:11px;color:#596882;font-family:'JetBrains Mono',monospace;letter-spacing:1px;margin-top:2px;padding-left:15px}
.itd-rets{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px}
.ret-i .ret-lr{display:flex;align-items:center;gap:6px;margin-bottom:10px}
.ret-bar{width:3px;height:14px;border-radius:2px}
.ret-nm{font-size:13px;font-weight:700;font-family:'DM Sans',sans-serif;color:#B0BEC5}
.ret-v{font-size:30px;font-weight:800;font-family:'DM Sans',sans-serif;line-height:1}

/* === ALPHA BOX === */
.alpha-box{background:linear-gradient(135deg,rgba(34,197,94,0.08),rgba(34,197,94,0.03));border:1px solid rgba(34,197,94,0.15);border-radius:14px;padding:18px 20px;text-align:center}
.alpha-hdr{display:flex;align-items:center;justify-content:center;gap:6px;margin-bottom:8px}
.alpha-bar{width:3px;height:14px;border-radius:2px;background:#4ADE80}
.alpha-lbl{font-size:13px;font-weight:700;font-family:'DM Sans',sans-serif;color:#4ADE80;text-transform:uppercase;letter-spacing:1.5px}
.alpha-val{font-size:32px;font-weight:800;font-family:'DM Sans',sans-serif;color:#4ADE80;line-height:1;margin-bottom:10px}
.alpha-bdg{display:inline-flex;align-items:center;gap:4px;background:rgba(34,197,94,0.12);border-radius:20px;padding:4px 10px}
.alpha-bdg span{font-size:12px;color:#4ADE80}
.alpha-bdg .av{font-family:'JetBrains Mono',monospace;font-weight:700}
.alpha-bdg .as{color:#CBD5E1;margin:0 1px;font-size:11px}
.alpha-bdg .ad{color:#CBD5E1;font-size:11px}
.alpha-bdg .am{font-family:'JetBrains Mono',monospace;font-weight:600;font-size:11px;color:#CBD5E1}

/* === CHART CARD === */
.chart-tr{display:flex;align-items:center;gap:8px;margin-bottom:16px}
.chart-icon{font-size:18px}
.chart-tt{margin:0;font-size:14px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:#F1F5F9}
.chart-leg{display:flex;align-items:center;gap:16px;margin-bottom:16px;font-size:12px;color:#8896AB}
.leg-i{display:flex;align-items:center;gap:6px}
.leg-line{width:16px;height:3px;border-radius:2px}
.leg-dash{width:16px;height:0;border-top:2px dashed #F7931A}
.leg-bars{width:16px;height:12px;background:linear-gradient(90deg,rgba(34,197,94,0.5) 50%,rgba(239,68,68,0.5) 50%);border-radius:2px}
.leg-dot{width:8px;height:8px;border-radius:50%}
.chart-box{height:360px;position:relative}

/* === SECTION TITLE === */
.sec-t{font-size:14px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:#F1F5F9;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.sec-icon{font-size:18px}

/* === NARRATIVE BOX === */
.narr{background:linear-gradient(135deg,rgba(34,197,94,0.06),rgba(15,23,42,0.65));backdrop-filter:blur(20px);border:1px solid rgba(34,197,94,0.15);border-radius:14px;padding:20px;margin-top:16px}
.narr-t{font-size:16px;font-weight:700;color:#4ADE80;margin-bottom:8px}
.narr-p{font-size:13px;color:#B0BEC5;line-height:1.7}
.hl-g{color:#4ADE80;font-weight:700}
.hl-o{color:#F7931A;font-weight:700}
.hl-r{color:#F87171;font-weight:600}

/* === KEY METRICS ROWS === */
.met-row{display:flex;justify-content:space-between;align-items:baseline;padding:14px 0;border-bottom:1px solid rgba(148,163,184,0.06)}
.met-row:last-child{border-bottom:none}
.met-row-label{font-size:14px;color:#B0BEC5}
.met-row-value{font-size:15px;font-weight:700;color:#F1F5F9;font-family:'JetBrains Mono',monospace;text-align:right}
.met-row-sub{font-size:11px;color:#4ADE80;font-style:italic;text-align:right;margin-top:2px;font-family:'JetBrains Mono',monospace}

/* === TWR SUMMARY === */
.twr-period{margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid rgba(148,163,184,0.1)}
.twr-period:last-child{margin-bottom:0;padding-bottom:0;border-bottom:none}
.twr-period-title{font-size:14px;font-weight:800;color:#F1F5F9;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.twr-period-bar{width:4px;height:18px;border-radius:2px;display:inline-block}
.twr-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid rgba(148,163,184,0.06)}
.twr-row:last-child{border-bottom:none}
.twr-row-label{font-size:14px;color:#B0BEC5}
.twr-row-label.alpha{color:#4ADE80;font-weight:600}
.twr-row-value{font-size:16px;font-weight:700;font-family:'JetBrains Mono',monospace}

/* === VENUE BREAKDOWN === */
.venue-group{margin-bottom:16px}
.venue-asset-title{font-size:14px;font-weight:700;margin-bottom:6px}
.venue-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0 6px 16px;border-bottom:1px solid rgba(148,163,184,0.06)}
.venue-row-label{font-size:13px;color:#B0BEC5}
.venue-row-value{font-size:13px;font-family:'JetBrains Mono',monospace;color:#F1F5F9;font-weight:500}
.venue-total{display:flex;justify-content:space-between;align-items:center;padding:8px 0 8px 16px;border-top:1px solid rgba(148,163,184,0.12)}
.venue-total-label{font-size:13px;font-weight:800;color:#F1F5F9;text-transform:uppercase;letter-spacing:0.5px}
.venue-total-value{font-size:14px;font-family:'JetBrains Mono',monospace;color:#F1F5F9;font-weight:800}

/* === 2-COL GRID === */
.r-grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:14px}
.r-grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-top:16px}

/* === TABLES === */
.tbl-w{overflow-x:auto;-webkit-overflow-scrolling:touch}
table.tbl{width:100%;border-collapse:collapse;font-size:13px;min-width:520px}
table.tbl th{text-align:left;padding:10px 12px;color:#8896AB;font-weight:600;font-size:12px;text-transform:uppercase;letter-spacing:1px;border-bottom:1px solid rgba(148,163,184,0.1)}
table.tbl td{padding:10px 12px;color:#B0BEC5;border-bottom:1px solid rgba(148,163,184,0.05)}
table.tbl td:first-child{color:#F1F5F9;font-weight:500}
table.tbl .mono{font-family:'JetBrains Mono',monospace}
table.tbl .right{text-align:right}
table.tbl th.right{text-align:right}
table.tbl .bold{font-weight:700;color:#F1F5F9}
table.tbl tr:hover td{background:rgba(148,163,184,0.03)}

/* === ALLOCATION BARS === */
.ab-row{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.ab-lbl{width:60px;font-size:13px;color:#B0BEC5;text-align:right;flex-shrink:0}
.ab-track{flex:1;height:28px;background:rgba(148,163,184,0.04);border-radius:4px;position:relative;overflow:hidden}
.ab-fill{height:100%;border-radius:4px;display:flex;align-items:center;padding-left:8px;font-size:11px;font-family:'JetBrains Mono',monospace;color:#F1F5F9;font-weight:600;opacity:0.7;transition:width .6s}
.ab-pct{width:55px;text-align:right;font-size:12px;font-family:'JetBrains Mono',monospace;color:#94A3B8;flex-shrink:0}

/* === COST BASIS BARS === */
.cb-row{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.cb-lbl{width:170px;flex-shrink:0;font-size:12px;color:#F1F5F9;font-weight:700;text-align:right;font-family:'JetBrains Mono',monospace}
.cb-track{flex:1;height:32px;position:relative;background:rgba(148,163,184,0.04);border-radius:4px}
.cb-fill{height:100%;border-radius:4px;display:flex;align-items:center;justify-content:flex-end;padding-right:8px;font-size:11px;font-family:'JetBrains Mono',monospace;font-weight:600;color:#F1F5F9}
.cb-pnl{width:60px;flex-shrink:0;text-align:right;font-size:12px;font-family:'JetBrains Mono',monospace;font-weight:700}
.cb-marker{position:absolute;top:-2px;bottom:-2px;width:2px;background:#F1F5F9;border-radius:1px}
.cb-val{width:50px;flex-shrink:0;font-size:11px;font-family:'JetBrains Mono',monospace;text-align:right;font-weight:600}

/* === DRAWDOWN === */
.r-dd2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.dd-s{text-align:center}
.dd-l{font-size:12px;color:#8896AB;font-weight:600;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px}
.dd-v{font-size:22px;font-weight:700;font-family:'JetBrains Mono',monospace}
.dd-sub{font-size:11px;color:#596882;margin-top:2px}

/* === SMALL METRIC CARD === */
.smc{padding:18px}
.smc-l{font-size:12px;color:#8896AB;font-weight:600;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px}
.smc-v{font-size:22px;font-weight:700;font-family:'JetBrains Mono',monospace}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE BREAKPOINTS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* TABLET â‰¤ 1024px */
@media(max-width:1024px){
  .r-hero4{grid-template-columns:repeat(2,1fr)!important}
}

/* MOBILE â‰¤ 768px */
@media(max-width:768px){
  /* Page shell */
  .page-shell{padding:14px 10px!important}
  
  /* Header */
  .r-header{flex-direction:column!important;align-items:stretch!important;gap:14px!important;margin-bottom:20px!important}
  .header-right{flex-direction:row!important;align-items:center!important;justify-content:space-between!important}
  .live-pill{order:1}
  .r-tabs{gap:4px;order:0;flex:1;overflow-x:auto;-webkit-overflow-scrolling:touch}
  .r-tabs button{white-space:nowrap;flex-shrink:0;padding:8px 12px!important;font-size:12px!important;border-radius:10px!important}
  
  /* Cards */
  .r-card{padding:14px!important;border-radius:14px!important}
  
  /* Hero cards - 2 col grid */
  .r-hero4{grid-template-columns:repeat(2,1fr)!important;gap:8px!important}
  .hero-card{padding:14px 12px!important}
  .hero-val{font-size:22px!important;margin-bottom:8px!important}
  .hero-lbl{font-size:11px!important}
  .hero-hdr{margin-bottom:10px!important}
  .badge{padding:3px 6px!important}
  .badge .pv{font-size:10px!important}
  .badge .dt{font-size:9px!important}
  .badge .sp{font-size:9px!important}
  .badge .dm{font-size:9px!important}
  .badge .arr{font-size:9px!important}
  
  /* Grids stack vertically */
  .r-grid2{grid-template-columns:1fr!important}
  .r-grid3{grid-template-columns:1fr!important}
  
  /* ITD / QTD panel */
  .r-itdqtd{grid-template-columns:1fr!important}
  .r-itdqtd .itd-h:first-child{border-right:none!important;border-bottom:1px solid rgba(148,163,184,0.1)!important;padding-bottom:24px!important;margin-bottom:8px}
  .r-itdqtd .itd-h{padding:18px 16px!important}
  .itd-t{font-size:15px!important}
  .ret-v{font-size:24px!important}
  .itd-rets{gap:12px!important}
  
  /* Drawdown boxes */
  .r-dd2{grid-template-columns:1fr!important}
  
  /* Tables - prevent horizontal scroll */
  .tbl-w{overflow-x:auto;-webkit-overflow-scrolling:touch;margin:0 -4px;padding:0 4px}
  table.tbl{min-width:0!important;font-size:11px!important}
  table.tbl th{padding:8px 6px!important;font-size:10px!important;letter-spacing:0.5px!important}
  table.tbl td{padding:8px 6px!important;font-size:11px!important}
  
  /* Performance Summary table */
  #perfSummaryBody td{padding:8px 4px!important}
  #perfSummaryBody span{font-size:10px!important;padding:2px 6px!important}
  
  /* Cost basis bars */
  .cb-row{flex-wrap:wrap!important;gap:6px!important}
  .cb-lbl{width:100%!important;text-align:left!important;font-size:11px!important}
  .cb-track{width:100%!important}
  .cb-pnl{width:auto!important}
  .cb-val{width:auto!important}
  
  /* Charts */
  .chart-box{height:220px!important}
  .chart-leg{flex-wrap:wrap!important;gap:8px!important;justify-content:flex-start!important}
  .leg-i{font-size:10px!important}
  
  /* Section titles */
  .sec-t{font-size:13px!important;letter-spacing:0.5px!important}
  .chart-tt{font-size:13px!important}
  
  /* Narration */
  .narr{padding:12px!important}
  .narr-t{font-size:12px!important}
  .narr-p{font-size:12px!important}
  
  /* Alpha box */
  .alpha-val{font-size:26px!important}
  .alpha-lbl{font-size:11px!important}
  
  /* Venue breakdown */
  .venue-row{padding:6px 0!important}
  .venue-row-name{font-size:12px!important}
  .venue-row-value{font-size:12px!important}
  
  /* Allocation bars */
  .ab-lbl{width:45px!important;font-size:11px!important}
  .ab-pct{width:45px!important;font-size:11px!important}
  
  /* Key metrics grid */
  .r-km-grid{grid-template-columns:1fr 1fr!important;gap:8px!important}
  .smc{padding:12px!important}
  .smc-l{font-size:10px!important}
  .smc-v{font-size:18px!important}
  
  /* Loading overlay */
  .loading-icon{width:80px!important;height:80px!important;border-radius:20px!important}
  .loading-icon span{font-size:40px!important}
  
  /* Twitter tab */
  .tw-filters{padding:14px!important}
  .tw-chip{padding:5px 10px!important;font-size:11px!important}
  .tw-section-title{font-size:13px!important}
  .tw-org{padding:10px 12px!important}
  .tw-org-name{font-size:13px!important}
  .tw-tweets li{font-size:12px!important}
}

/* SMALL PHONE â‰¤ 480px */
@media(max-width:480px){
  .page-shell{padding:10px 6px!important}
  .r-hero4{grid-template-columns:1fr 1fr!important;gap:6px!important}
  .hero-card{padding:10px 8px!important}
  .hero-val{font-size:18px!important}
  .hero-lbl{font-size:10px!important}
  .hero-bar{width:3px!important;height:14px!important}
  .r-card{padding:10px!important;border-radius:12px!important}
  .r-tabs button{padding:6px 9px!important;font-size:11px!important;border-radius:8px!important}
  .cb-lbl{font-size:10px!important}
  
  /* Tables ultra-compact */
  table.tbl{font-size:10px!important}
  table.tbl th{padding:6px 4px!important;font-size:9px!important}
  table.tbl td{padding:6px 4px!important;font-size:10px!important}
  #perfSummaryBody span{font-size:9px!important;padding:2px 4px!important}
  
  /* Charts smaller */
  .chart-box{height:180px!important}
  .ret-v{font-size:20px!important}
  .alpha-val{font-size:22px!important}
  .dd-v{font-size:24px!important}
  
  /* Drawdown boxes compact */
  .r-dd2 > div{padding:14px!important}
  
  /* Header logo */
  .header-logo{width:36px!important;height:36px!important}
  .header-logo span{font-size:24px!important}
  .header-name{font-size:18px!important}
}
/* Twitter/DeFi Brief Tab */
.tw-filters{background:rgba(148,163,184,0.04);border:1px solid rgba(148,163,184,0.08);border-radius:12px;padding:20px;margin-bottom:20px}
.tw-filter-group{margin-bottom:16px}
.tw-filter-group:last-of-type{margin-bottom:0}
.tw-filter-label{font-size:12px;color:#F1F5F9;font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-bottom:10px}
.tw-chips{display:flex;flex-wrap:wrap;gap:8px}
.tw-chip{padding:6px 14px;border-radius:20px;font-size:12px;font-weight:600;cursor:pointer;border:1px solid rgba(148,163,184,0.15);background:rgba(148,163,184,0.06);color:#94A3B8;transition:all 0.2s;font-family:'Inter',sans-serif}
.tw-chip:hover{border-color:rgba(74,222,128,0.3);color:#4ADE80}
.tw-chip.active{background:rgba(74,222,128,0.15);border-color:rgba(74,222,128,0.3);color:#4ADE80}
.tw-clear{background:none;border:1px solid rgba(248,113,113,0.2);color:#F87171;padding:6px 16px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;margin-top:12px}
.tw-clear:hover{background:rgba(248,113,113,0.1)}
.tw-date-display{color:#94A3B8;font-size:13px;margin-top:12px;font-family:'JetBrains Mono',monospace}
.tw-date-header{font-size:18px;font-weight:700;color:#F1F5F9;margin:24px 0 16px;padding-bottom:8px;border-bottom:1px solid rgba(148,163,184,0.1)}
.tw-section{margin-bottom:24px}
.tw-section-title{font-size:15px;font-weight:700;color:#4ADE80;text-transform:uppercase;letter-spacing:1px;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.tw-section-title::before{content:'';width:4px;height:18px;background:#4ADE80;border-radius:2px}
.tw-org{background:rgba(148,163,184,0.04);border:1px solid rgba(148,163,184,0.08);border-radius:10px;padding:14px 16px;margin-bottom:10px}
.tw-org-header{display:flex;align-items:center;gap:10px;margin-bottom:8px;flex-wrap:wrap}
.tw-org-name{font-size:14px;font-weight:700;color:#F1F5F9}
.tw-badge{font-size:10px;font-weight:700;padding:2px 8px;border-radius:10px;text-transform:uppercase;letter-spacing:0.5px}
.tw-badge-founder{background:rgba(139,92,246,0.15);color:#C4B5FD}
.tw-badge-team{background:rgba(59,130,246,0.15);color:#93C5FD}
.tw-handle{font-size:12px;color:#3B82F6;font-weight:700}
.tw-tweets{list-style:disc;padding:0 0 0 20px;margin:0}
.tw-tweets li{font-size:13px;color:#CBD5E1;line-height:1.6;padding:4px 0;margin-left:0}
.tw-tweets li::marker{color:#4ADE80}
.tw-tweets a{color:#4ADE80;font-size:11px;text-decoration:none;font-weight:700}
.tw-tweets a:hover{text-decoration:underline}
.tw-no-data{text-align:center;padding:40px;color:#596882}
.tw-no-data h2{color:#8896AB;font-size:16px;margin-bottom:8px}
</style>
</head>
<body>
<div class="loading-overlay" id="loadingOverlay">
  <div style="text-align:center">
    <div class="loading-icon"><span style="font-size:52px">â˜˜</span></div>
    <div style="color:#94A3B8;font-size:15px;font-family:'JetBrains Mono',monospace;animation:fadeInOut 1.2s ease-in-out infinite;margin-top:8px">Loading portfolio dataâ€¦</div>
  </div>
</div>
<div class="orb-orange"></div>
<div class="orb-blue"></div>
<div class="page-shell">
<div class="error-banner" id="errorBanner"></div>

<div class="r-header">
  <div class="header-left">
    <div class="header-brand">
      <div class="header-logo"><span style="font-size:35px">â˜˜</span></div>
      <h1 class="header-title">Clover Capital</h1>
    </div>
    <p class="header-date" id="headerDate">â€”</p>
  </div>
  <div class="header-right">
    <div class="live-pill" id="livePill">
      <span class="live-dot"></span>
      <span class="live-text">LIVE</span>
      <span class="live-cd" id="countdown">â€”</span>
    </div>
    <div class="r-tabs" id="tabBar">
      <button class="active" data-tab="overview">Overview</button>
      <button data-tab="performance">Performance</button>
      <button data-tab="allocation">Allocation</button>
      <button data-tab="tranches">Purchases</button>
      <button data-tab="twitter">Twitter</button>
    </div>
  </div>
</div>

<div class="r-hero4">
  <div class="r-card hero-card hero-common">
    <div class="hero-hdr"><div class="hero-bar" style="background:linear-gradient(180deg,#94A3B8,#64748B)"></div><span class="hero-lbl">Total AUM</span></div>
    <div class="hero-val" id="heroAUM">â€”</div>
    <div class="hero-ctr" id="heroAUMBadge"></div>
  </div>
  <div class="r-card hero-card hero-common" id="heroBTCCardHover" style="cursor:pointer">
    <div class="hero-hdr"><div class="hero-bar" style="background:linear-gradient(180deg,#F7931A,#E2761B)"></div><span class="hero-lbl">BTC Holdings</span><span class="hero-hint" id="heroBTCHint">hover for USD</span></div>
    <div class="hero-val" id="heroBTC" style="color:#F7931A">â€”</div>
    <div class="hero-ctr" id="heroBTCBadge"></div>
  </div>
  <div class="r-card hero-card hero-default">
    <div class="hero-hdr"><div class="hero-bar" style="background:linear-gradient(180deg,#F7931A,#E2761B)"></div><span class="hero-lbl">BTC Price</span></div>
    <div class="hero-val" id="heroBTCPrice" style="color:#F7931A">â€”</div>
    <div class="hero-ctr" id="heroBTCPriceBadge"></div>
  </div>
  <div class="r-card hero-card hero-default">
    <div class="hero-hdr"><div class="hero-bar" style="background:linear-gradient(180deg,#F87171,#EF4444)"></div><span class="hero-lbl">Avg Cost Basis</span></div>
    <div class="hero-val" id="heroAvgCost" style="color:#CBD5E1">â€”</div>
    <div class="hero-ctr" id="heroAvgCostBadge"></div>
  </div>
  <div class="r-card hero-card hero-alloc" style="display:none">
    <div class="hero-hdr"><div class="hero-bar" style="background:linear-gradient(180deg,#F7931A,#E2761B)"></div><span class="hero-lbl">BTC Exposure</span></div>
    <div class="hero-val" id="heroBTCExposure" style="color:#F7931A">â€”</div>
    <div class="hero-ctr" id="heroBTCExposureBadge"></div>
  </div>
  <div class="r-card hero-card hero-alloc" style="display:none">
    <div class="hero-hdr"><div class="hero-bar" style="background:linear-gradient(180deg,#2775CA,#1E5FAA)"></div><span class="hero-lbl">Cash + Stables</span></div>
    <div class="hero-val" id="heroCashStables" style="color:#2775CA">â€”</div>
    <div class="hero-ctr" id="heroCashStablesBadge"></div>
  </div>
  <div class="r-card hero-card hero-purch" style="display:none">
    <div class="hero-hdr"><div class="hero-bar" style="background:linear-gradient(180deg,#F7931A,#E2761B)"></div><span class="hero-lbl">BTC Holdings</span></div>
    <div class="hero-val" id="heroPurchHoldings" style="color:#F7931A">â€”</div>
    <div class="hero-ctr"></div>
  </div>
  <div class="r-card hero-card hero-purch" style="display:none">
    <div class="hero-hdr"><div class="hero-bar" style="background:linear-gradient(180deg,#4ADE80,#22C55E)"></div><span class="hero-lbl">BTC Purchased</span></div>
    <div class="hero-val" id="heroTotalBTCPurch" style="color:#4ADE80">â€”</div>
    <div class="hero-ctr"></div>
  </div>
  <div class="r-card hero-card hero-purch" style="display:none">
    <div class="hero-hdr"><div class="hero-bar" style="background:linear-gradient(180deg,#94A3B8,#64748B)"></div><span class="hero-lbl">Weighted Avg Cost</span></div>
    <div class="hero-val" id="heroWeightedAvgCost" style="color:#CBD5E1">â€”</div>
    <div class="hero-ctr"></div>
  </div>
  <div class="r-card hero-card hero-purch" style="display:none">
    <div class="hero-hdr"><div class="hero-bar" style="background:linear-gradient(180deg,#F87171,#EF4444)"></div><span class="hero-lbl">Unrealized ITD PNL</span></div>
    <div class="hero-val" id="heroUnrealizedPNL" style="color:#F87171">â€”</div>
    <div class="hero-ctr"></div>
  </div>
  <div class="r-card hero-card hero-perf" style="display:none">
    <div class="hero-hdr"><div class="hero-bar" style="background:linear-gradient(180deg,#94A3B8,#64748B)"></div><span class="hero-lbl">Days Since Inception</span></div>
    <div class="hero-val" id="heroDaysSinceInception" style="color:#F1F5F9">â€”</div>
    <div class="hero-ctr"></div>
  </div>
  <div class="r-card hero-card hero-perf" style="display:none">
    <div class="hero-hdr"><div class="hero-bar" style="background:linear-gradient(180deg,#F87171,#EF4444)"></div><span class="hero-lbl">Max Drawdown (MWR)</span></div>
    <div class="hero-val" id="heroMaxDDMWR" style="color:#F87171">â€”</div>
    <div class="hero-ctr"></div>
  </div>
  <div class="r-card hero-card hero-perf" style="display:none">
    <div class="hero-hdr"><div class="hero-bar" style="background:linear-gradient(180deg,#F87171,#EF4444)"></div><span class="hero-lbl">Unrealized ITD PNL</span></div>
    <div class="hero-val" id="heroPerfITDPNL" style="color:#F87171">â€”</div>
    <div class="hero-ctr"></div>
  </div>
  <div class="r-card hero-card hero-perf" style="display:none">
    <div class="hero-hdr"><div class="hero-bar" style="background:linear-gradient(180deg,#F87171,#EF4444)"></div><span class="hero-lbl">ITD MWR</span></div>
    <div class="hero-val" id="heroITDMWR" style="color:#F87171">â€”</div>
    <div class="hero-ctr"></div>
  </div>
</div>

<div class="tab-content active" id="tab-overview">
  <div class="r-card r-itdqtd">
    <div class="itd-h">
      <div style="margin-bottom:24px"><div class="itd-tr"><div class="itd-bar" style="background:linear-gradient(180deg,#F7931A,#E2761B)"></div><div class="itd-t">Inception to Date</div></div><div class="itd-st">TIME-WEIGHTED RETURNS</div></div>
      <div class="itd-rets">
        <div class="ret-i"><div class="ret-lr"><div class="ret-bar" style="background:#F87171"></div><span class="ret-nm">Fund Return</span></div><div class="ret-v" id="itdFund" style="color:#F87171">â€”</div></div>
        <div class="ret-i"><div class="ret-lr"><div class="ret-bar" style="background:#F87171"></div><span class="ret-nm">BTC Benchmark</span></div><div class="ret-v" id="itdBTC" style="color:#F87171">â€”</div></div>
      </div>
      <div class="alpha-box"><div class="alpha-hdr"><div class="alpha-bar"></div><span class="alpha-lbl">ALPHA *</span></div><div class="alpha-val" id="itdAlpha">â€”</div><div id="itdAlphaBadge"></div></div>
    </div>
    <div class="itd-h">
      <div style="margin-bottom:24px"><div class="itd-tr"><div class="itd-bar" style="background:linear-gradient(180deg,#3B82F6,#2563EB)"></div><div class="itd-t">Quarter to Date</div></div><div class="itd-st">TIME-WEIGHTED RETURNS</div></div>
      <div class="itd-rets">
        <div class="ret-i"><div class="ret-lr"><div class="ret-bar" style="background:#F87171"></div><span class="ret-nm">Fund Return</span></div><div class="ret-v" id="qtdFund" style="color:#F87171">â€”</div></div>
        <div class="ret-i"><div class="ret-lr"><div class="ret-bar" style="background:#F87171"></div><span class="ret-nm">BTC Benchmark</span></div><div class="ret-v" id="qtdBTC" style="color:#F87171">â€”</div></div>
      </div>
      <div class="alpha-box"><div class="alpha-hdr"><div class="alpha-bar"></div><span class="alpha-lbl">ALPHA *</span></div><div class="alpha-val" id="qtdAlpha">â€”</div><div id="qtdAlphaBadge"></div></div>
    </div>
  </div>

  <div class="r-card">
    <div class="chart-tr"><span class="chart-icon">ğŸ§ </span><h3 class="chart-tt">ALPHA GENERATION â€” FUND VS BTC (ITD TIME-WEIGHTED RETURNS)</h3></div>
    <div class="chart-leg">
      <div class="leg-i"><div class="leg-line" style="background:#3B82F6"></div>Fund TWR</div>
      <div class="leg-i"><div class="leg-dash"></div>BTC TWR</div>
      <div class="leg-i"><div class="leg-line" style="background:#8B5CF6"></div>BTC Price</div>
      <div class="leg-i"><div class="leg-bars"></div>Alpha Spread</div>
      <div class="leg-i"><div class="leg-dot" style="background:#4ADE80;box-shadow:0 0 6px rgba(74,222,128,0.5)"></div>TWAP Buy</div>
      <div class="leg-i"><div class="leg-dot" style="background:#60A5FA;box-shadow:0 0 6px rgba(96,165,250,0.5)"></div>Limit Buy</div>
    </div>
    <div class="chart-box"><canvas id="twrChart"></canvas></div>
    <div class="narr"><div class="narr-t">ğŸ“Š Alpha Narrative</div><div class="narr-p" id="commentary">Loadingâ€¦</div></div>
  </div>

  <div class="r-grid2">
    <div class="r-card">
      <div class="sec-t"><span class="sec-icon">ğŸ”‘</span> KEY METRICS</div>
      <div id="keyMetricsDetail"></div>
    </div>
    <div class="r-card">
      <div class="sec-t"><span class="sec-icon">â±ï¸</span> TIME-WEIGHTED RETURNS</div>
      <div id="twrSummary"></div>
    </div>
  </div>

  <div class="r-grid2">
    <div class="r-card">
      <div class="sec-t"><span class="sec-icon">ğŸ¥§</span> ASSET BREAKDOWN</div>
      <div style="height:380px;position:relative"><canvas id="assetPieChart"></canvas></div>
      <div id="pieLegend" style="display:flex;flex-wrap:nowrap;justify-content:center;gap:14px;margin-top:24px;font-size:13px"></div>
    </div>
    <div class="r-card">
      <div class="sec-t"><span class="sec-icon">ğŸ¦</span> VENUE BREAKDOWN</div>
      <div id="venueBreakdown"></div>
    </div>
  </div>
</div>

<div class="tab-content" id="tab-performance">
  <div class="r-card">
    <div class="sec-t"><span class="sec-icon">ğŸ“Š</span> PERFORMANCE SUMMARY â€” FUND VS BTC (MONEY-WEIGHTED RETURNS)</div>
    <div class="tbl-w"><table class="tbl">
      <thead><tr><th style="text-align:left">Metric</th><th style="text-align:right">QTD PNL ($)</th><th style="text-align:right">QTD Return (%)</th><th style="text-align:right">ITD PNL ($)</th><th style="text-align:right">ITD Return (%)</th></tr></thead>
      <tbody id="perfSummaryBody"></tbody>
    </table></div>
  </div>
  <div class="r-card">
    <div class="chart-tr"><span class="chart-icon">ğŸ§ </span><h3 class="chart-tt">ALPHA GENERATION â€” FUND VS BTC</h3></div>
    <div class="chart-leg">
      <div class="leg-i"><div class="leg-line" style="background:#3B82F6"></div>Fund TWR</div><div class="leg-i"><div class="leg-dash"></div>BTC TWR</div><div class="leg-i"><div class="leg-line" style="background:#8B5CF6"></div>BTC Price</div><div class="leg-i"><div class="leg-bars"></div>Alpha Spread</div><div class="leg-i"><div class="leg-dot" style="background:#4ADE80;box-shadow:0 0 6px rgba(74,222,128,0.5)"></div>TWAP Buy</div><div class="leg-i"><div class="leg-dot" style="background:#60A5FA;box-shadow:0 0 6px rgba(96,165,250,0.5)"></div>Limit Buy</div>
    </div>
    <div class="chart-box"><canvas id="twrChart2"></canvas></div>
    <div class="narr"><div class="narr-t">ğŸ“Š Alpha Narrative</div><div class="narr-p" id="commentary2">Loadingâ€¦</div></div>
  </div>
  <div class="r-card">
    <div class="sec-t"><span class="sec-icon">ğŸ¯</span> ALPHA SPREAD OVER TIME (FUND RETURN â€“ BTC RETURN)</div>
    <div class="chart-leg" style="margin-bottom:12px">
      <div class="leg-i"><div style="width:12px;height:12px;border-radius:2px;background:#4ADE80"></div>Outperforming BTC</div>
      <div class="leg-i"><div style="width:12px;height:12px;border-radius:2px;background:#F87171"></div>Underperforming BTC</div>
      <div class="leg-i"><div class="leg-line" style="background:#8B5CF6"></div>BTC Price</div>
      <div class="leg-i"><div style="width:16px;height:0;border-top:2px dashed #F1F5F9"></div>Inception $90.3K</div>
      <div class="leg-i"><div class="leg-dot" style="background:#4ADE80;box-shadow:0 0 6px rgba(74,222,128,0.5)"></div>TWAP Buy</div>
      <div class="leg-i"><div class="leg-dot" style="background:#60A5FA;box-shadow:0 0 6px rgba(96,165,250,0.5)"></div>Limit Buy</div>
    </div>
    <div class="chart-box" style="height:300px"><canvas id="alphaSpreadChart"></canvas></div>
  </div>
  <div class="r-card">
    <div class="sec-t"><span class="sec-icon">ğŸ“‰</span> DRAWDOWN FROM PEAK</div>
    <div class="r-dd2" style="margin-bottom:20px">
      <div style="border:1px solid rgba(248,113,113,0.25);background:rgba(248,113,113,0.06);border-radius:12px;padding:20px">
        <div style="text-align:left;display:flex;align-items:center;gap:6px;margin-bottom:6px"><div style="width:4px;height:16px;border-radius:2px;background:#F87171"></div><span style="font-size:12px;color:#F1F5F9;font-weight:700;text-transform:uppercase;letter-spacing:1px">Max Drawdown</span></div>
        <div class="dd-v" id="maxDDValue2" style="color:#F87171;font-size:32px;text-align:left">â€”</div>
        <div id="maxDDDate2" style="text-align:left;color:#F1F5F9;font-weight:700;font-family:'JetBrains Mono',monospace;font-size:12px;margin-top:4px"></div>
      </div>
      <div style="border:1px solid rgba(247,147,26,0.25);background:rgba(247,147,26,0.06);border-radius:12px;padding:20px">
        <div style="text-align:left;display:flex;align-items:center;gap:6px;margin-bottom:6px"><div style="width:4px;height:16px;border-radius:2px;background:#F7931A"></div><span style="font-size:12px;color:#F1F5F9;font-weight:700;text-transform:uppercase;letter-spacing:1px">Current Drawdown</span></div>
        <div class="dd-v" id="curDDValue2" style="color:#F7931A;font-size:32px;text-align:left">â€”</div>
        <div id="curDDRecovery2" style="text-align:left;color:#F1F5F9;font-weight:700;font-family:'JetBrains Mono',monospace;font-size:12px;margin-top:4px"></div>
      </div>
    </div>
    <div class="chart-box" style="height:220px"><canvas id="drawdownChart2"></canvas></div>
  </div>
</div>

<div class="tab-content" id="tab-allocation">
  <div class="r-card">
    <div class="sec-t"><span class="sec-icon">ğŸ“</span> ASSET ALLOCATION</div>
    <div class="tbl-w">
      <table class="tbl">
        <thead><tr><th style="text-align:left">Asset</th><th style="text-align:right">Amount</th><th style="text-align:right">Price</th><th style="text-align:right">AUM</th><th style="text-align:right">Weight</th></tr></thead>
        <tbody id="allocTableNew"></tbody>
      </table>
    </div>
  </div>
  <div class="r-grid2">
    <div class="r-card"><div class="sec-t"><span class="sec-icon">ğŸ¥§</span> ALLOCATION CHART</div><div class="chart-box" style="height:380px"><canvas id="allocPieChart"></canvas></div><div id="allocPieLegend" style="display:flex;flex-wrap:nowrap;justify-content:center;gap:14px;margin-top:24px;font-size:13px"></div></div>
    <div class="r-card"><div class="sec-t"><span class="sec-icon">ğŸ¦</span> VENUE BREAKDOWN</div><div id="venueBreakdownAlloc"></div></div>
  </div>
  <div class="r-card">
    <div class="sec-t"><span class="sec-icon">ğŸ“¦</span> BTC ACCUMULATION â€” HOLDINGS & COST BASIS VS MARKET PRICE</div>
    <div class="chart-leg">
      <div class="leg-i"><div class="leg-line" style="background:#F7931A"></div>BTC Price</div>
      <div class="leg-i"><div class="leg-dash" style="border-color:#EF4444"></div>Avg Cost</div>
      <div class="leg-i"><div class="leg-line" style="background:#8B5CF6"></div>Holdings</div>
      <div class="leg-i"><div class="leg-dot" style="background:#4ADE80;box-shadow:0 0 6px rgba(74,222,128,0.5)"></div>TWAP Buy</div>
      <div class="leg-i"><div class="leg-dot" style="background:#60A5FA;box-shadow:0 0 6px rgba(96,165,250,0.5)"></div>Limit Buy</div>
    </div>
    <div class="chart-box" style="height:400px"><canvas id="holdingsChart"></canvas></div>
    <div id="accumStats" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-top:20px;border-top:1px solid rgba(148,163,184,0.1);padding-top:16px"></div>
  </div>
</div>

<div class="tab-content" id="tab-tranches">
  <div class="r-card"><div class="sec-t"><span class="sec-icon">ğŸ›’</span> PURCHASE TRANCHES</div><div class="tbl-w"><table class="tbl"><thead><tr><th style="text-align:left">Tranche</th><th style="text-align:left">Date</th><th style="text-align:left">Asset</th><th style="text-align:right">Quantity</th><th style="text-align:right">Avg Cost</th><th style="text-align:right">Total Cost</th><th style="text-align:right">Current Value</th><th style="text-align:right">PNL</th></tr></thead><tbody id="purchaseTable"></tbody></table></div></div>
  <div class="r-card">
    <div class="sec-t"><span class="sec-icon">ğŸ“Š</span> COST BASIS BY TRANCHE</div>
    <div class="chart-leg" style="margin-bottom:16px">
      <div class="leg-i"><div style="width:16px;height:12px;background:linear-gradient(90deg,#F7931A,#E2761B);border-radius:2px"></div>Purchase Cost</div>
      <div class="leg-i"><div style="width:16px;height:0;border-top:2px dashed #8B5CF6"></div><span id="costBasisBtcPriceLegend">Current BTC Price</span></div>
    </div>
    <div id="costBars"></div>
  </div>
</div>

<div class="tab-content" id="tab-twitter">
  <div class="r-card">
    <div class="sec-t"><span class="sec-icon">ğŸ¦</span> DEFI DAILY BRIEF</div>
    <div class="tw-filters">
      <div class="tw-filter-group">
        <div class="tw-filter-label">Date View</div>
        <div class="tw-chips" id="twViewChips">
          <div class="tw-chip active" data-tw-view="yesterday" onclick="twSetViewMode('yesterday')">Yesterday</div>
          <div class="tw-chip" data-tw-view="last7days" onclick="twSetViewMode('last7days')">Last 7 Days</div>
          <div class="tw-chip" data-tw-view="thismonth" onclick="twSetViewMode('thismonth')">This Month</div>
        </div>
      </div>
      <div class="tw-filter-group">
        <div class="tw-filter-label">Filter by Section</div>
        <div class="tw-chips" id="twSectionFilters"></div>
      </div>
      <div class="tw-filter-group">
        <div class="tw-filter-label">Filter by Protocol</div>
        <div class="tw-chips" id="twProtocolFilters"></div>
      </div>
      <button class="tw-clear" onclick="twClearFilters()">Clear All Filters</button>
      <div class="tw-date-display" id="twDateDisplay"></div>
    </div>
  </div>
  <div id="twContent"></div>
</div>

</div><!-- /page-shell -->
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG (from index(4).html)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SHEET_ID = '1QiW-1REapN-UD76xTf5ne4P-J6cWvMPJuuVqaYATFk0';
const PUBLISH_ID = '2PACX-1vRwRHNmvnfYRYB3LRuUpLd2pt8R-RSSYYqU2DZ_QUoNRzFW0NmzZ2OsICbxX1xYc9l4ChniUmdwhDbF';
const TABS = {
  dashboard: 163729112,
  perfSummary: 828103600,
  returnsDaily: 1053773100,
  purchases: 1222270502,
  historicalPrices: 1760753841
};
const INCEPTION_DATE = '2025-12-12';
const INCEPTION_AUM = 33770670.78;
const INCEPTION_BTC_PRICE = 90287.49;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TWITTER / DEFI DAILY BRIEF
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const twBriefsData = {"Feb 09, 2026":{"Major Developments":{"Ethereum":[{"text":"ERC-8004 (AI Agent Registry) launches across major L2s including OP Mainnet, Linea, and MegaETH - establishing verifiable identity and portable reputation framework for trustless agent economy","link":"https://x.com/i/status/2020939849575079996"},{"text":"Ink Network achieves 4.7M+ unique wallets and ~300K secondary NFT sales in first week, showcasing rapid adoption when barriers are removed","link":"https://x.com/i/status/2020963512718327974"}]},"Founder Insights":{"Curve - @newmichwill (Founder)":[{"text":"Released comprehensive tokenomics thesis explaining Curve DAO's unique approach: DAO earns admin fees from revenue-generating AMM while CRV holders control emissions to drive liquidity","link":"https://x.com/i/status/2020844090091536871"}]},"DeFi Highlights":{"Pendle":[{"text":"Pendle Print #101: sPENDLE buyback commenced with first yield distribution Feb 13, new PT-srUSDe and PT-USDe markets on Lista (BNB Chain) and Aave, upcoming PT markets on Compound v4","link":"https://x.com/i/status/2020801373378584675"},{"text":"Compound v4 partnership announced as Priority Partner, enabling PT-sUSDe and PT-USDe access to deeper liquidity through enhanced looping strategies and isolated markets","link":"https://x.com/i/status/2020686704970223783"},{"text":"Neutrl sNUSD becomes highest yielding stablecoin PT at 12.2% Fixed APY with strong depth across large ticket sizes","link":"https://x.com/i/status/2020726286294065575"}],"Sky":[{"text":"Weekly buyback execution: 1.9M USDS deployed to acquire 31M SKY, cumulative buybacks surpass 108M USDS demonstrating consistent tokenomics","link":"https://x.com/i/status/2020877665066959299"},{"text":"$1B allocated from DeFi into AAA CLOs, showcasing onchain capital reaching traditional U.S. credit markets through Grove integration","link":"https://x.com/i/status/2020965940972687773"}],"Fluid":[{"text":"Expanding globally: Paris presence at 50 Partners Onchain Day and Hong Kong event during Consensus with Chainlink, GMX, and Dune","link":"https://x.com/i/status/2020952534295380062"}],"Maple Finance":[{"text":"Web application restored to full functionality after security incident - smart contracts and user funds remained safe throughout","link":"https://x.com/i/status/2020877091340955973"}],"Cowswap":[{"text":"Integration with Grand app highlights CoW's MEV-resistant architecture providing institutional-grade protection for every trade","link":"https://x.com/i/status/2020812240773922858"}]},"DEX Updates":{"Aerodrome":[{"text":"Emphasized modular architecture advantages: adding features flexibly without migrations, composable upgrades, and fast iteration maintaining pool competitiveness","link":"https://x.com/i/status/2020868936866599107"},{"text":"Strong LP rewards continue: USDC-CLAWD reaching ~2,799% APY, WETH-CLANKER at ~1,130% as concentrated liquidity drives efficiency","link":"https://x.com/i/status/2020843227698897231"}],"Curve":[{"text":"Strong pool performance: Pepe/USDC pool generating 25% APY, sUSDe pool delivering 13% APY for LPs","link":"https://x.com/i/status/2020876746883146203"}]}},"Feb 08, 2026":{"Major Developments":{"Ethereum":[{"text":"Major Pectra testnet upgrades launched on Holesky and Sepolia (Feb 5-7), implementing critical updates including account abstraction improvements ahead of mainnet activation","link":"https://x.com/i/status/2020555881970352586"}]},"Founder Insights":{"Curve - @newmichwill (Founder)":[{"text":"Detailed explanation of fee accrual mechanisms in Curve ecosystem: protocol fees from both AMM trading and lending, distributed to veCRV holders while maintaining sustainable emissions model","link":"https://x.com/i/status/2020418991815844332"}]},"Team Member Insights":{"Aave - @lemiscate (Team Member)":[{"text":"Highlighted Aave's critical role in stablecoin infrastructure: $12B stablecoins sitting in Aave earning yield, providing essential support for stablecoin growth","link":"https://x.com/i/status/2020541901664170447"}]},"DeFi Highlights":{"Pendle":[{"text":"YTs outperforming spot during market recovery: USDe YT and wstETH delivering superior returns compared to direct holdings, demonstrating yield trading advantages in volatile conditions","link":"https://x.com/i/status/2020521959459492116"},{"text":"Active market expansion: PT-rswETH on Sonic, PT-PT-sUSDe on Arbitrum, PT-ezETH on Mode all delivering strong fixed yields ranging 5-14% APY","link":"https://x.com/i/status/2020460880024822139"}],"Aave":[{"text":"Rare vulnerability disclosure handled: whitehat exploit resulted in $300K bounty payout while protecting user funds, demonstrating robust security response","link":"https://x.com/i/status/2020524949584437327"}],"Sky":[{"text":"Ranked #2 in top USD-denominated yield products by TVL for 2025 through sUSDS, trailing only Aave V3 USDT on Ethereum","link":"https://x.com/i/status/2020487625396867175"}],"Maple Finance":[{"text":"Strong performance from Base instance: Syrup Kamino USDC APY maintained at 8.42% with net deposits exceeding $300M","link":"https://x.com/i/status/2020438826638774313"}],"Fluid":[{"text":"Vault TVL hits $1B milestone, marking significant growth trajectory for improved liquidation infrastructure","link":"https://x.com/i/status/2020418095862542643"}]},"DEX Updates":{"Aerodrome":[{"text":"Continued exceptional Slipstream yields: USDC-CLAWD ~5,026% APY, WETH-CLANKER ~1,273% APY as AI agent tokens drive concentrated liquidity demand","link":"https://x.com/i/status/2020540779087495648"}],"Uniswap":[{"text":"CCA auctions proceeding: $RNBW in price discovery phase while $HUDL pre-bidding continues, demonstrating sustained adoption of transparent token launch mechanism","link":"https://x.com/i/status/2020510682929893556"}]}},"Feb 07, 2026":{"Major Developments":{"Ethereum Foundation":[{"text":"Announced $4.5M funding for zkVM team to build secure, production-ready zero-knowledge virtual machine advancing Ethereum's privacy and scaling roadmap","link":"https://x.com/i/status/2020186838869893416"}]},"Founder Insights":{"Morpho - @MerlinEgalite (Founder)":[{"text":"Highlighted Morpho's governance efficiency: protocol owned by token holders, decision-making distributed across token holders and risk curators, with Age 1 focused on maximum decentralization","link":"https://x.com/i/status/2020125662653989285"}]},"Team Member Insights":{"Chainlink - @ChainLinkGod (Team Member)":[{"text":"Explained institutional adoption drivers: proven infrastructure eliminates reinvention needs, Chainlink's track record driving enterprise selection over proprietary solutions","link":"https://x.com/i/status/2020092530832343488"}]},"DeFi Highlights":{"Pendle":[{"text":"Continued product expansion: YieldNest launching PT-ynLSDe market with 7.96% APY, Karak launching PT-kBTC offering 6.68% fixed BTC yields","link":"https://x.com/i/status/2020139645889085520"},{"text":"Strategic partnership development with Compound v4 as Priority Partner, enabling deeper institutional liquidity access through isolated PT markets","link":"https://x.com/i/status/2020072891113918772"}],"Aave":[{"text":"Strategic positioning update: focus shifting to direct wallet integrations and Ethena PT deployment expanding distribution beyond web interfaces","link":"https://x.com/i/status/2020165874518765875"}],"Maple Finance":[{"text":"Maintained #1 ranking in yield-generating RWA by TVL through syrupUSDC and syrupUSDT products","link":"https://x.com/i/status/2020055756073054275"}],"Fluid":[{"text":"Achieved key milestone: $1B total liquidity across all vaults demonstrating sustained growth momentum","link":"https://x.com/i/status/2020078382773010900"}],"Spark":[{"text":"Comprehensive 2025 wrap-up released detailing Sky Protocol's financial performance and Spark's role in institutional lending infrastructure","link":"https://x.com/i/status/2020050625777635774"}]},"DEX Updates":{"Aerodrome":[{"text":"Record-breaking Slipstream yields: USDC-CLAWD reaching ~10,137% APY, WETH-CLANKER at ~1,512% driven by intense AI agent token activity","link":"https://x.com/i/status/2020118774093742172"}],"Uniswap":[{"text":"$RNBW CCA progressing through price discovery following successful floor sale completion","link":"https://x.com/i/status/2020142651698315745"}]}},"Feb 06, 2026":{"Major Developments":{"Ethereum":[{"text":"EigenLayer enabling restaked collateral for AI inference at scale - bridging decentralized compute with Ethereum security guarantees","link":"https://x.com/i/status/2019719868597915877"}]},"Founder Insights":{"Morpho - @MerlinEgalite (Founder)":[{"text":"Outlined Morpho's competitive advantages: superior rates through reduced intermediation, flexible risk through modular vaults, enhanced liquidity through P2P matching - creating net-positive DeFi lending","link":"https://x.com/i/status/2019871012849082685"}],"Maple Finance - @syrupsid (Founder)":[{"text":"Discussed major shifts in credit markets: banks exiting leveraged lending creating opportunity, regulatory pressure on private credit opening space for institutional onchain credit","link":"https://x.com/i/status/2019768588175737194"}]},"Team Member Insights":{"Chainlink - @ChainLinkGod (Team Member)":[{"text":"Emphasized sustainable infrastructure thesis: enterprises choosing proven solutions over reinventing the wheel, Chainlink becoming default choice for institutional smart contracts","link":"https://x.com/i/status/2019786093758214267"}],"Fluid - @Mardeni01 (Team Member)":[{"text":"Differentiation messaging: Fluid as 'defi done right' - DeFi 2.0 focused on institutional-grade reliability and efficiency vs. speculation","link":"https://x.com/i/status/2019748866699534754"}]},"DeFi Highlights":{"Aave":[{"text":"Aave v4 development progressing: focus on improved liquidation parameters and revenue optimization based on analytical frameworks","link":"https://x.com/i/status/2019842799047745822"}],"Pendle":[{"text":"Expanding yield products: new PT-pxETH market launched with attractive fixed yields, continued growth in RWA and stablecoin PT offerings","link":"https://x.com/i/status/2019782488577515973"}],"Maple Finance":[{"text":"Platform performing strongly: $300M+ in Kamino Market deposits, consistent institutional inflows across syrup products","link":"https://x.com/i/status/2019669486878650754"}],"Cowswap":[{"text":"Further fee optimization: stablecoin-to-stablecoin trades now 0.3bps (down from 2bps), improving cost efficiency for correlated pairs","link":"https://x.com/i/status/2019701806076248428"}]},"DEX Updates":{"Aerodrome":[{"text":"Maintaining exceptional LP incentives: USDC-CLAWD pools delivering 4,000%+ APY through Slipstream concentrated liquidity","link":"https://x.com/i/status/2019861382766158217"}],"Uniswap":[{"text":"CCA platform momentum building: multiple verified auctions running concurrently demonstrating market acceptance of transparent price discovery mechanism","link":"https://x.com/i/status/2019848782044840419"}]}},"Feb 05, 2026":{"Major Developments":{"Ethereum Foundation":[{"text":"Launched comprehensive One Trillion Dollar Security Dashboard providing ecosystem-wide view of Ethereum's security infrastructure","link":"https://x.com/i/status/2019483909332107632"}],"Canton Network":[{"text":"Fireblocks integration expands Canton's institutional infrastructure with enterprise-grade custody and privacy-enabled settlement capabilities","link":"https://x.com/i/status/2019546829889966387"},{"text":"Reference architecture deployed demonstrating compliant DeFi primitives: programmable stablecoins, tokenized securities with automated settlement, and interoperable asset transfers","link":"https://x.com/i/status/2019517385976205395"}],"Chainlink":[{"text":"Reserve expansion continues with 125K LINK accumulated, bringing total holdings to 1.9M LINK as protocol strengthens tokenomics","link":"https://x.com/i/status/2019456872617500871"},{"text":"BTCFi expanding with Lombard Finance ($1.1B TVL) integrating Proof of Reserve for real-time LBTC and BTC.b collateral verification on Ethereum","link":"https://x.com/i/status/2019395941921415321"}]},"Founder Insights":{"Ethereum - @vitalikbuterin (Founder)":[{"text":"Outlined path to 1000x Ethereum L1 scaling through novel state architecture innovations - moving beyond traditional scaling approaches","link":"https://x.com/i/status/2019437232315056267"},{"text":"Clarified L2 positioning: distinguishing between chains that merely add features versus those that truly inherit Ethereum's security guarantees","link":"https://x.com/i/status/2019341766407725170"}],"Curve - @newmichwill (Founder)":[{"text":"Published strategy for scaling crvUSD to tens of billions by leveraging USDT's proven stability model and yield infrastructure","link":"https://x.com/i/status/2019463665418678291"}],"Spark - @hexonaut (Founder)":[{"text":"Sky's early RWA positioning now generating robust revenue despite rate environment - USDS matching DAI's 2022 size but with significantly superior unit economics","link":"https://x.com/i/status/2019516504916783319"}],"Aerodrome - @wagmialexander (Founder)":[{"text":"Emphasized fundamental value proposition during market volatility: AERO's actual utility distinguishes it from speculative tokens lacking real use cases","link":"https://x.com/i/status/2019493096694661596"}]},"Team Member Insights":{"Fluid - @smykjain (Team Member)":[{"text":"Demonstrated liquidation efficiency advantage during volatility: Fluid positions surviving with <20% liquidations while competitors would have wiped entire positions at 83% LT","link":"https://x.com/i/status/2019491629208612900"}]},"DeFi Highlights":{"Pendle":[{"text":"Expanded Ethena product suite with new PT markets (May 2026 maturity) while launching sPENDLE buyback program beginning Feb 9 with time-weighted rewards from Jan 29","link":"https://x.com/i/status/2019406850257744138"}],"Sky":[{"text":"USDS demonstrates resilient adoption trajectory: grew from $5.3B to $9.4B throughout 2025 despite SSR dropping from 12.5% to 4%, outpacing overall stablecoin market growth","link":"https://x.com/i/status/2019460504800903466"}],"Spark":[{"text":"Maintaining steady 4% APY across multiple stablecoins (USDS, USDT, USDC, PYUSD) with growing user base exceeding 247K participants","link":"https://x.com/i/status/2019433124401467764"}],"Maple Finance":[{"text":"Released January performance reports for syrupUSDC and syrupUSDT products showing continued institutional lending growth","link":"https://x.com/i/status/2019410765044957471"}]},"DEX Updates":{"Uniswap":[{"text":"CCA platform gaining momentum with three simultaneous verified auctions including HUDL pre-bidding and RNBW completing floor sale to enter price discovery","link":"https://x.com/i/status/2019429901078786334"}],"Aerodrome":[{"text":"Exceptional FX pair yields available through Slipstream: WETH-MXNE reaching ~6,000% APY with CLAWNCH pools now eligible for AERO emissions","link":"https://x.com/i/status/2019539047602090040"}],"Curve":[{"text":"Governance proposals optimizing crvUSD economics: reducing price dependency in borrow rates and increasing fee share for scrvUSD depositors during volatile periods","link":"https://x.com/i/status/2019521255901454366"}],"Orca":[{"text":"Enhanced AutoSwap functionality with token selection feature, streamlining single-transaction swap-to-LP workflows","link":"https://x.com/i/status/2019554782097404125"}]}},"Feb 04, 2026":{"Major Developments":{"Ethereum":[{"text":"Y Combinator expanding crypto adoption: YC startups can now receive funding directly in USDC on Base, marking significant milestone for mainstream crypto integration in startup ecosystem","link":"https://x.com/i/status/2018989485479969037"}],"Fidelity":[{"text":"Announced Fidelity Digital Dollar (FIDD) - new institutional-grade stablecoin with 1:1 USD backing, leveraging Fidelity's $5.5T AUM credibility to enter competitive stablecoin market","link":"https://x.com/i/status/2019020695773937865"}],"Chainlink":[{"text":"Major derivatives expansion: CME Group launching LINK and Micro LINK futures within one week, bringing institutional-grade derivatives to oracle infrastructure","link":"https://x.com/i/status/2019131772009251286"},{"text":"CCIP integration by Morph enables $2.1B+ BGB cross-chain transfers, expanding institutional bridge infrastructure","link":"https://x.com/i/status/2019052437234315502"}],"Canton Network":[{"text":"Fireblocks integration brings institutional custody infrastructure to Canton Network, enabling enterprise-grade asset management for tokenized securities","link":"https://x.com/i/status/2018975969077129419"}]},"Founder Insights":{"Maple Finance - @syrupsid (Founder)":[{"text":"Record performance: $2.57M monthly revenue ($30.84M ARR) representing new all-time high as institutional credit demand accelerates","link":"https://x.com/i/status/2019167295816184243"}],"Aave - @StaniKulechov (Founder)":[{"text":"Strategic focus on direct wallet integrations and Ethena PT market deployment to expand Aave's reach beyond traditional web interfaces","link":"https://x.com/i/status/2019118752925233413"}],"Aerodrome - @wagmialexander (Founder)":[{"text":"AERO token integrated into Aragon's Ownership Token Framework, establishing presence in DAO governance infrastructure","link":"https://x.com/i/status/2019150775479415053"}]},"Team Member Insights":{"Chainlink - @ChainLinkGod (Team Member)":[{"text":"Emphasized institutional adoption trend: enterprises increasingly choosing proven infrastructure over building proprietary solutions, validating Chainlink's market positioning","link":"https://x.com/i/status/2019063746748760386"}],"Fluid - @thirdtimesthecharm (Team Member)":[{"text":"Announced Venus as launch partner for Fluid Flux on BNB Chain, expanding Fluid's liquidation infrastructure across ecosystems","link":"https://x.com/i/status/2019045645034918204"}]},"DeFi Highlights":{"Aave":[{"text":"Rabby Mobile integration enables direct Aave borrowing and yield farming from mobile wallet, streamlining DeFi accessibility","link":"https://x.com/i/status/2019150527223345204"}],"Pendle":[{"text":"Three Ethena PT markets reaching maturity Feb 5, representing significant locked value entering redemption phase","link":"https://x.com/i/status/2019001867023868405"}],"Fluid":[{"text":"iETH vault doubled since August launch, demonstrating sustained demand for Fluid's improved liquidation mechanics during growth and volatility","link":"https://x.com/i/status/2019064753844437404"}],"PancakeSwap":[{"text":"Record January volume: $240B processed across all chains, solidifying position as leading multi-chain DEX","link":"https://x.com/i/status/2019058854330384464"}],"Spark":[{"text":"Positioned as leading institutional-grade money-market protocol, emphasizing compliant structure for sophisticated capital","link":"https://x.com/i/status/2018983027887513786"}],"Cowswap":[{"text":"Solvers now accessible via dedicated domain, improving MEV protection infrastructure and solver network transparency","link":"https://x.com/i/status/2019119234893095294"}],"Maple Finance":[{"text":"Launched new treasury automation products through partnership with Centrifuge, targeting protocol treasury management market","link":"https://x.com/i/status/2019064271863701863"}]},"DEX Updates":{"Aerodrome":[{"text":"Exceptional yield opportunities in Slipstream pools: WETH-AERO reaching 2,052% APY as concentrated liquidity incentives drive capital efficiency","link":"https://x.com/i/status/2019131421967327468"}],"Uniswap":[{"text":"CCA (Continuous Clearing Auctions) gaining traction as preferred token launch mechanism, with multiple projects choosing transparent onchain price discovery","link":"https://x.com/i/status/2019051913453138195"}],"Curve":[{"text":"LlamaRisk IPOR Vault now routing crvUSD, expanding DeFi integration for Curve's native stablecoin across yield strategies","link":"https://x.com/i/status/2019089451018096816"}]}},"Feb 03, 2026":{"Major Developments":{"Aave":[{"text":"Published case study on Aave's role in scaling stablecoins - global stablecoin supply crossed $300B in 2025 with Aave as key growth rail","link":"https://x.com/i/status/2018752166454759627"},{"text":"Winding down Family iOS wallet while Family Accounts continue to power Aave App infrastructure","link":"https://x.com/i/status/2018766256724447521"},{"text":"Stablecoin float pushed past $500M+ demonstrating balance sheet depth and battle-tested stress performance","link":"https://x.com/i/status/2018618259487203336"}],"Chainlink":[{"text":"Strategic partnership with Texas Blockchain Council to advance digital asset standards across Texas","link":"https://x.com/i/status/2018750395632279576"},{"text":"Highlighted 5 ways Chainlink supercharges growth for stablecoin issuers","link":"https://x.com/i/status/2018672859560686055"},{"text":"Making privacy programmable with confidential compute and private cross-chain execution for institutional adoption","link":"https://x.com/i/status/2018520091059765335"}],"Cowswap":[{"text":"Integration with MetaMask to enable trading USDC for Ondo Finance tokenized assets with MEV-free execution","link":"https://x.com/i/status/2018708147284677096"},{"text":"Reduced fees on correlated asset pairs (including stablecoin-to-stablecoin) from 2bps to 0.3bps","link":"https://x.com/i/status/2018671533485629659"}]},"Founder Insights":{"Aave - @StaniKulechov (Founder)":[{"text":"Strong analysis highlights Aave V4 liquidation parameters and revenue impact optimization","link":"https://x.com/i/status/2018750835312763218"},{"text":"Aave's deepest liquidity pools create flywheel effect with stable float, deeper money markets, stronger credit loops","link":"https://x.com/i/status/2018618259487203336"}],"Maple Finance - @syrupsid (Founder)":[{"text":"Standard Chartered warning of $500B bank deposit flight to stablecoins - capital going where it's treated best with onchain rails offering speed, transparency and yield","link":"https://x.com/i/status/2018670811452740060"},{"text":"Institutions want curated, reliable access to yield - discussing curated vs. modular credit models in DeFi","link":"https://x.com/i/status/2018728919646532010"}],"Curve - @newmichwill (Founder)":[{"text":"Curve daily active users at ATH according to Token Terminal","link":"https://x.com/i/status/2018827623753982228"},{"text":"Discussion on DAO sovereignty: Should DAOs be incorporated or self-sovereign like Curve truly is?","link":"https://x.com/i/status/2018637158106472733"}],"Uniswap - @haydenzadams (Founder)":[{"text":"Excited for L2 proving systems secured by L1 hardforks - was biggest complaint about L2-centric roadmap historically","link":"https://x.com/i/status/2018739946706596309"},{"text":"Called for increased code size limit on Ethereum L1 for DeFi development","link":"https://x.com/i/status/2018831529338904633"}]},"Team Member Insights":{"Chainlink - @ChainLinkGod (Team Member)":[{"text":"Institutions choosing Chainlink: \"Institutions realizing they don't need to reinvent the wheel when there is proven infrastructure\"","link":"https://x.com/i/status/2018823564435357871"},{"text":"Chainlink making privacy programmable with confidential compute unlocking institutional adoption","link":"https://x.com/i/status/2018520091059765335"}]},"DeFi Highlights":{"Pendle":[{"text":"YT long yields hitting 700%+ APY with extra boost from External Incentives - Pendle adds up to 40% extra $PENDLE on top of protocol rewards","link":"https://x.com/i/status/2018618301967151361"},{"text":"First protocol leverages Pendle's permissionless pool contracts to independently deploy market with custom UI - showcasing composability vision","link":"https://x.com/i/status/2018500876193898570"},{"text":"Hiring product researcher for data-driven initiatives","link":"https://x.com/i/status/2018558182302593149"}],"Maple Finance":[{"text":"Maple continues strong inflows on Aave's Base instance: 100M cap filled, new cap set at 200M","link":"https://x.com/i/status/2018691007307767906"}],"Sky Protocol":[{"text":"Q4 Update and 2026 Outlook released","link":"https://x.com/i/status/2018756893813219356"},{"text":"Rune Kek at NYSE discussing state of digital assets in U.S. and institutional stablecoin adoption","link":"https://x.com/i/status/2018722707605799035"}],"Orca":[{"text":"NX8 index now live to trade & LP on Orca - captures leading L1 blockchains in single liquid asset","link":"https://x.com/i/status/2018672301961863598"},{"text":"Prioritizing direct communication with Solana traders, LPers and builders to shape future of Solana liquidity","link":"https://x.com/i/status/2018689441469276476"}],"PancakeSwap":[{"text":"Weekly stats: Net CAKE mint -626k CAKE (-$946k), total product burns 777k CAKE ($1.17M)","link":"https://x.com/i/status/2018640818740068517"}],"Spark":[{"text":"Chinese community call scheduled for February 5th to discuss latest financials, buybacks, emissions reduction, and institutional lending","link":"https://x.com/i/status/2018672441338257614"}]},"DEX Updates":{"Aerodrome":[{"text":"AI agents making Base more efficient: 6x capital efficiency on $BNKR, 15x on $CLANKER compared to competition","link":"https://x.com/i/status/2018819482681291055"},{"text":"Slipstream LP Rewards: up to 4,606% APY on USDC-CLAWD pair","link":"https://x.com/i/status/2018742547695468880"},{"text":"14% Flight School Lock Bonus for new veAERO locks over 2,500","link":"https://x.com/i/status/2018712352066277656"},{"text":"More volume than all other DEXs on Base with day 1 Coinbase distribution","link":"https://x.com/i/status/2018776747354005919"}],"Uniswap":[{"text":"CCA (Continuous Clearing Auctions) now being built on by teams like Huddle01 for transparent onchain token distributions","link":"https://x.com/i/status/2018823277351956673"},{"text":"$RNBW CCA Auction officially live - liquidity bootstrapping and price discovery happening onchain","link":"https://x.com/i/status/2018722976347062746"}]}},"Feb 02, 2026":{"Major Developments":{"HyperLiquid":[{"text":"Introducing outcome trading (HIP-4) - fully collateralized contracts settling within fixed range for prediction markets and bounded options-like instruments","link":"https://x.com/i/status/2018327360723202167"},{"text":"Outcomes bring non-linearity, dated contracts, and alternative derivative trading without leverage or liquidations","link":"https://x.com/i/status/2018327360723202167"},{"text":"Currently testing on testnet, will deploy canonical markets denominated in USDH once complete","link":"https://x.com/i/status/2018327360723202167"},{"text":"New ATH: $1B in open interest and $4.8B in 24-hour volume on HIP-3 markets","link":"https://x.com/i/status/2018227446320173431"}],"Chainlink":[{"text":"Highlighting $2.8B lost to cross-chain exploits","link":"https://x.com/i/status/2018459841879322898"},{"text":"Positioning as the only platform for institutional smart contracts at scale","link":"https://x.com/i/status/2018333738858381575"}]},"Founder Insights":{"Maple Finance - @syrupsid (Founder)":[{"text":"Maple Finance now #1 in yield-generating RWA by TVL, combining syrupUSDC and syrupUSDT products","link":"https://x.com/i/status/2018380095233163298"}]},"Team Member Insights":{"Fluid - @mardeni01 (Team Member)":[{"text":"Weekend crash proved another successful stress test: $0 bad debt, flawless liquidations, $3.3B weekly trading volume (#2 DEX on Ethereum with 22% market share), $260k in weekly revenue","link":"https://x.com/i/status/2018288981646163970"},{"text":"Fluid's liquidation system only liquidates minimum needed to restore health at 0.1-1% penalty vs competitors' 50% liquidations with 5-10% penalties","link":"https://x.com/i/status/2018288981646163970"}],"Chainlink - @chrisbarrett (Team Member)":[{"text":"Chainlink secures 83.49% of Ethereum DeFi","link":"https://x.com/i/status/2018383116893610304"},{"text":"January highlights: Chainlink 24/5 U.S. Equities Streams launched across 40+ chains and new Swift trial for tokenized bonds settlement","link":"https://x.com/i/status/2018435191753118197"}]},"DeFi Highlights":{"Aave":[{"text":"January stats: $57.3B in deposits, $23.2B in active loans, $75.1M in fees","link":"https://x.com/i/status/2018412674556579883"},{"text":"Successfully handled weekend stress test on $50B+ lending markets, liquidating over $140M collateral across multiple networks fully automated without issues","link":"https://x.com/i/status/2018326381680087452"}],"Pendle":[{"text":"Milestone: Pendle Print #100","link":"https://x.com/i/status/2018264003617968155"},{"text":"New AIM model cuts PENDLE emissions by ~30%","link":"https://x.com/i/status/2018264003617968155"},{"text":"New co-incentives module: $0.40 PENDLE on top of every $1 external incentive","link":"https://x.com/i/status/2018264003617968155"}],"Aerodrome":[{"text":"Massive LP rewards: up to 5,442% APY on USDC-CLAWD pair","link":"https://x.com/i/status/2018429905281941955"},{"text":"856K AERO buyback ($160M+ total locked)","link":"https://x.com/i/status/2018388637579379042"}],"Maple Finance":[{"text":"Now #1 in yield-generating RWA by TVL (combining syrupUSDC and syrupUSDT)","link":"https://x.com/i/status/2018380095233163298"},{"text":"Kamino's Maple Market hits $300M net deposits","link":"https://x.com/i/status/2018355596483842455"}],"Sky Protocol":[{"text":"Bought back 130M SKY tokens in January using 8.5M USDS","link":"https://x.com/i/status/2018351797623042496"}]},"DEX Updates":{"Uniswap":[{"text":"Auctions now live on web app with continuous clearing auctions","link":"https://x.com/i/status/2018343171504193925"},{"text":"Pre-bidding for $RNBW token has begun","link":"https://x.com/i/status/2018392229883056225"}]}},"Feb 10, 2026":{"Major Developments":{"Aave":[{"text":"Aave V4 security audit by Trail of Bits now public, advancing toward mainnet with security-first approach","link":"https://x.com/i/status/2021331340935979040"},{"text":"Launched on MegaETH expanding DeFi infrastructure to high-performance L2","link":"https://x.com/i/status/2021330872411009025"}],"Chainlink":[{"text":"Selected for Bank of England's Synchronisation Lab to support synchronized settlement exploration with institutional partners","link":"https://x.com/i/status/2021215016658100231"},{"text":"Asseto Finance integrates CCIP & Price Feeds for RWA-as-a-service platform, accelerating tokenized asset adoption","link":"https://x.com/i/status/2021147139070423279"}]},"Founder Insights":{"Sky - @RuneKek (Founder)":[{"text":"Fundamentals gaining recognition as SKY token demonstrates traction - crypto industry showing stronger foundation than before","link":"https://x.com/i/status/2021260164372877569"},{"text":"$100M+ in SKY buybacks completed with detailed analysis from Sky Frontier Foundation on effectiveness","link":"https://x.com/i/status/2021255945184063658"}],"Curve - @newmichwill (Founder)":[{"text":"Curve governance discussion on V2 expansion strategy and potential new crvUSD use cases","link":"https://x.com/i/status/2021333929874407497"}]},"Team Member Insights":{"Pendle - Team":[{"text":"Fixed yield gaining importance as market volatility highlights value of predictable returns over speculative positions","link":"https://x.com/i/status/2021252892104245488"}]},"DeFi Highlights":{"Pendle":[{"text":"Boros (Pendle's leveraged PT protocol) surpasses $10B in trading volume with Chaos Labs-designed risk framework","link":"https://x.com/i/status/2021095232025264632"}],"Sky":[{"text":"Sky Savings Rate maintaining 4% APY on USDS backed by diversified collateral portfolio","link":"https://x.com/i/status/2021254981525946654"}],"Ethereum Foundation":[{"text":"Urbe Hub officially recognized as Ethereum Community Hub in Italy, expanding European ecosystem presence","link":"https://x.com/i/status/2021298524248474014"}]},"DEX Updates":{"Aerodrome":[{"text":"Continued high-yield opportunities in Slipstream pools with optimized capital efficiency on Base","link":"https://x.com/i/status/2021331849143079208"}]}},"Feb 11, 2026":{"Major Developments":{"Aave":[{"text":"Expanded to Mantle ecosystem creating synergies with Bybit distribution and deepening presence across L2s","link":"https://x.com/i/status/2021685964389646399"},{"text":"First Aave V4 security audit released publicly by Trail of Bits marking major milestone toward V4 launch","link":"https://x.com/i/status/2021685293812736236"}],"Chainlink":[{"text":"Ondo Finance adopts Chainlink as official data oracle for tokenized stocks & ETFs - first integration enabling tokenized U.S. equities trading with institutional-grade data","link":"https://x.com/i/status/2021627058430906817"}],"Fluid":[{"text":"AI agent completed first autonomous lending and borrowing transaction on Fluid via Base - demonstrating agent-native DeFi stack forming","link":"https://x.com/i/status/2021653700054520044"},{"text":"Venus Flux Beta officially live on BNB Chain in collaboration with Venus Protocol, bringing connected liquidity infrastructure","link":"https://x.com/i/status/2021525855672090786"}]},"Founder Insights":{"Aave - @StaniKulechov (Founder)":[{"text":"\"Aave everywhere\" - emphasizing expansion strategy across multiple chains and ecosystems","link":"https://x.com/i/status/2021685491645456529"}],"Sky - @RuneKek (Founder)":[{"text":"Outlined 2026 vision for Sky Ecosystem with Agent Network expansion and institutional growth roadmap","link":"https://x.com/i/status/2021714148753572285"}]},"Team Member Insights":{"Pendle - Team":[{"text":"Permissionless listing model identified as key driver behind explosive growth - Community Pool Deployment enabling rapid market expansion","link":"https://x.com/i/status/2021574737672159291"}]},"DeFi Highlights":{"Pendle":[{"text":"PT-srUSDe supply cap on Aave increased from $50M to $100M after hitting capacity, offering >20% APY through PT looping strategies","link":"https://x.com/i/status/2021471035732996196"}],"Maple Finance":[{"text":"syrupUSDC and syrupUSDT surpass $1B in cross-chain AUM with strong institutional and fintech inflows","link":"https://x.com/i/status/2021600191670026422"},{"text":"BlackRock moving core business operations onchain - tokenizing ETFs and listing on Uniswap validates institutional DeFi migration","link":"https://x.com/i/status/2021731788465565885"}],"Sky":[{"text":"Sky accelerated Agent launches in 2025: Grove deploying $1B+ into tokenized vehicles, Obex launched with $2.5B mandate for institutional expansion","link":"https://x.com/i/status/2021634599374254411"},{"text":"Spark Prime introducing institutional margin lending powered by USDS as new yield source for Agent Network","link":"https://x.com/i/status/2021630523865804972"}],"Ethereum Foundation":[{"text":"Ethereum ecosystem headed to Consensus Hong Kong with comprehensive lineup of ecosystem talks","link":"https://x.com/i/status/2021685673393369598"},{"text":"TheDAO Security Fund announces first allocation supporting SEAL_Org and SEAL_911 security initiatives","link":"https://x.com/i/status/2021639622087053452"}]},"DEX Updates":{"Cowswap":[{"text":"Continued MEV-free trading infrastructure developments for institutional and retail users","link":"https://x.com/i/status/2021621971369566622"}]}}}
;

const twSectionOrder = ['Major Developments','Founder Insights','Team Member Insights','DeFi Highlights','DEX Updates'];
const twAllProtocols = ['Aave','Aerodrome','Canton Network','Chainlink','Cowswap','Curve','Ethereum','Fluid','HyperLiquid','Infinex','Kamino','Maple Finance','Morpho','Orca','PancakeSwap','Pendle','Plasma','Prysm (Plasma Star)','Sky','Sky Protocol','Spark','Uniswap'];
let twViewMode = 'yesterday';
let twActiveFilters = { sections: new Set(), protocols: new Set() };
let twAllDates = Object.keys(twBriefsData).sort((a,b) => new Date(b) - new Date(a));

function twNormalizeProtocol(name) {
  const cleaned = name.split(' - ')[0].trim().replace('(Founder)','').replace('(Team Member)','').trim();
  if (cleaned === 'Ethereum Foundation') return 'Ethereum';
  if (cleaned === 'Sky Protocol') return 'Sky';
  return cleaned;
}

function twFormatDate(dateStr) {
  const d = new Date(dateStr);
  return d.toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
}

function twInit() {
  // Render section filter chips
  const sf = document.getElementById('twSectionFilters');
  if (sf) sf.innerHTML = twSectionOrder.map(s => `<div class="tw-chip" data-tw-section="${s}" onclick="twToggleSection('${s}')">${s}</div>`).join('');
  // Render protocol filter chips
  const pf = document.getElementById('twProtocolFilters');
  if (pf) pf.innerHTML = twAllProtocols.sort().map(p => `<div class="tw-chip" data-tw-protocol="${p}" onclick="twToggleProtocol('${p.replace(/'/g, "\\'")}')">${p}</div>`).join('');
  twSetViewMode('yesterday');
}

function twSetViewMode(mode) {
  twViewMode = mode;
  document.querySelectorAll('[data-tw-view]').forEach(c => c.classList.toggle('active', c.dataset.twView === mode));
  const range = twGetDateRange(mode);
  const dd = document.getElementById('twDateDisplay');
  if (dd) dd.innerHTML = `<strong>Viewing:</strong> ${range.label}`;
  twRenderAggregated(range.dates);
}

function twGetDateRange(mode) {
  switch(mode) {
    case 'yesterday': {
      const now = new Date(new Date().toLocaleString('en-US', { timeZone:'America/Los_Angeles' }));
      const y = new Date(now); y.setDate(y.getDate() - 1);
      const yf = y.toLocaleDateString('en-US', { month:'short', day:'2-digit', year:'numeric', timeZone:'America/Los_Angeles' });
      const yd = twAllDates.find(d => d === yf) || twAllDates[twAllDates.length - 1];
      return { dates: [yd], label: `Yesterday - ${twFormatDate(yd)}` };
    }
    case 'last7days': return { dates: twAllDates, label: 'Last 7 Days' };
    case 'thismonth': {
      const cm = twAllDates[0]?.substring(0, 7);
      return { dates: twAllDates.filter(d => d.startsWith(cm || '')), label: 'This Month' };
    }
    default: return { dates: [twAllDates[0]], label: twFormatDate(twAllDates[0]) };
  }
}

function twRenderAggregated(dates) {
  const container = document.getElementById('twContent');
  if (!container) return;
  let html = '';
  dates.forEach(date => {
    const data = twBriefsData[date];
    if (!data) return;
    const content = twRenderDay(data, date);
    if (content) html += content;
  });
  if (!html) html = '<div class="r-card"><div class="tw-no-data"><h2>No Results</h2><p>No tweets match your current filters.</p></div></div>';
  container.innerHTML = html;
}

function twRenderDay(data, dateStr) {
  let html = '<div class="r-card"><div class="tw-date-header">' + twFormatDate(dateStr) + '</div>';
  let hasContent = false;
  twSectionOrder.forEach(section => {
    if (twActiveFilters.sections.size > 0 && !twActiveFilters.sections.has(section)) return;
    if (!data[section] || Object.keys(data[section]).length === 0) return;
    let sectionHtml = '', sectionHasContent = false;
    Object.entries(data[section]).forEach(([org, tweets]) => {
      const norm = twNormalizeProtocol(org);
      if (twActiveFilters.protocols.size > 0 && !twActiveFilters.protocols.has(norm)) return;
      sectionHasContent = true; hasContent = true;
      let orgName = org, handle = '', role = '';
      if (org.includes('(Founder)')) { role = 'Founder'; orgName = org.replace(/\s*\(Founder\)/, ''); }
      else if (org.includes('(Team Member)')) { role = 'Team Member'; orgName = org.replace(/\s*\(Team Member\)/, ''); }
      const parts = orgName.split(' - ');
      if (parts.length > 1) { orgName = parts[0]; handle = parts[1]; }
      sectionHtml += '<div class="tw-org"><div class="tw-org-header"><span class="tw-org-name">' + orgName + '</span>';
      if (role === 'Founder') sectionHtml += '<span class="tw-badge tw-badge-founder">Founder</span>';
      else if (role === 'Team Member') sectionHtml += '<span class="tw-badge tw-badge-team">Team Member</span>';
      if (handle) sectionHtml += '<span class="tw-handle">' + handle + '</span>';
      sectionHtml += '</div><ul class="tw-tweets">';
      tweets.forEach(t => {
        sectionHtml += '<li>' + t.text;
        if (t.link) sectionHtml += ' <a href="' + t.link + '" target="_blank">(View Tweet)</a>';
        sectionHtml += '</li>';
      });
      sectionHtml += '</ul></div>';
    });
    if (sectionHasContent) html += '<div class="tw-section"><div class="tw-section-title">' + section + '</div>' + sectionHtml + '</div>';
  });
  html += '</div>';
  return hasContent ? html : '';
}

function twToggleSection(section) {
  if (twActiveFilters.sections.has(section)) twActiveFilters.sections.delete(section);
  else twActiveFilters.sections.add(section);
  document.querySelector(`[data-tw-section="${section}"]`)?.classList.toggle('active');
  twSetViewMode(twViewMode);
}

function twToggleProtocol(protocol) {
  if (twActiveFilters.protocols.has(protocol)) twActiveFilters.protocols.delete(protocol);
  else twActiveFilters.protocols.add(protocol);
  document.querySelector(`[data-tw-protocol="${protocol}"]`)?.classList.toggle('active');
  twSetViewMode(twViewMode);
}

function twClearFilters() {
  twActiveFilters.sections.clear();
  twActiveFilters.protocols.clear();
  document.querySelectorAll('.tw-chip').forEach(c => c.classList.remove('active'));
  document.querySelector('[data-tw-view="yesterday"]')?.classList.add('active');
  twSetViewMode('yesterday');
}

// Initialize Twitter tab on page load
document.addEventListener('DOMContentLoaded', () => setTimeout(twInit, 100));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let lastGoodData = null;
let charts = {};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CSV FETCHING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function csvUrl(gid) {
  return `https://docs.google.com/spreadsheets/d/e/${PUBLISH_ID}/pub?gid=${gid}&single=true&output=csv&_t=${Date.now()}`;
}

async function fetchCSV(gid) {
  const resp = await fetch(csvUrl(gid), {cache: 'no-store'});
  if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
  const text = await resp.text();
  if (!text || text.length < 10 || text.includes('<!DOCTYPE')) throw new Error('Got HTML instead of CSV for gid ' + gid);
  return Papa.parse(text, { header: false, skipEmptyLines: true }).data;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARSING HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parseNum(s) {
  if (!s || s === '-' || s === '') return null;
  return parseFloat(String(s).replace(/[$,%()]/g, '').replace(/\s/g, ''));
}
function parsePct(s) {
  if (!s || s === '-' || s === '') return null;
  let n = parseFloat(String(s).replace(/[%$,+]/g, '').replace(/[()]/g, m => m === '(' ? '-' : ''));
  if (String(s).includes('%')) return n / 100;
  return n;
}
function parseDollar(s) {
  if (!s || s === '-' || s === '') return null;
  let str = String(s).replace(/[$,\s]/g, '');
  if (str.startsWith('(') && str.endsWith(')')) str = '-' + str.slice(1, -1);
  return parseFloat(str);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FORMATTING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmtDollar(n, compact) {
  if (n == null || isNaN(n)) return 'â€”';
  if (compact && Math.abs(n) >= 1e6) return '$' + (n / 1e6).toFixed(2) + 'M';
  if (compact && Math.abs(n) >= 1e3) return '$' + (n / 1e3).toFixed(1) + 'K';
  return n < 0 
    ? '-$' + Math.abs(n).toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2})
    : '$' + n.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2});
}
function fmtPct(n, decimals=2) {
  if (n == null || isNaN(n)) return 'â€”';
  return (n * 100).toFixed(decimals) + '%';
}
function fmtPctRaw(n, decimals=2) {
  if (n == null || isNaN(n)) return 'â€”';
  return n.toFixed(decimals) + '%';
}
function fmtNum(n, decimals=2) {
  if (n == null || isNaN(n)) return 'â€”';
  return n.toLocaleString('en-US', {minimumFractionDigits:decimals, maximumFractionDigits:decimals});
}
function colorPct(el, val) {
  if (val == null) return;
  el.style.color = val >= 0 ? '#4ADE80' : '#F87171';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA PARSING FROM SHEETS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parseDashboard(rows) {
  const data = {};
  data.todayDate = rows[1]?.[2] || '';
  data.aum = parseDollar(rows[4]?.[1]);
  data.btcPrice = parseDollar(rows[4]?.[4]);
  data.btcHoldings = parseNum(rows[4]?.[7]);
  data.btcAvgCost = parseDollar(rows[5]?.[14]);
  data.btcAvgPurchasePrice = parseDollar(rows[6]?.[14]);
  data.twoPointFiveAUM = parseDollar(rows[7]?.[14]);
  data.mwrITDFund = parsePct(rows[8]?.[14]);
  data.mwrQTDFund = parsePct(rows[10]?.[4]);
  data.itdTWRFund = parsePct(rows[10]?.[14]);
  data.itdTWRBTC = parsePct(rows[11]?.[14]);
  data.itdAlpha = parsePct(rows[12]?.[14]);
  data.qtdTWRFund = parsePct(rows[14]?.[14]);
  data.qtdTWRBTC = parsePct(rows[15]?.[14]);
  data.qtdAlpha = parsePct(rows[16]?.[14]);
  data.mwrRows = [];
  for (let i = 10; i <= 15; i++) {
    data.mwrRows.push({
      label: rows[i]?.[1] || '',
      qtdPnl: parseDollar(rows[i]?.[2]),
      qtdRet: parsePct(rows[i]?.[4]),
      itdPnl: parseDollar(rows[i]?.[6]),
      itdRet: parsePct(rows[i]?.[8])
    });
  }
  data.btcTWR = {
    label: rows[19]?.[1] || 'BTC (ALL TWR)',
    qtdPnl: parseDollar(rows[19]?.[2]),
    qtdRet: parsePct(rows[19]?.[4]),
    itdPnl: parseDollar(rows[19]?.[6]),
    itdRet: parsePct(rows[19]?.[8])
  };
  data.assets = [];
  for (let i = 23; i <= 27; i++) {
    const asset = rows[i]?.[1];
    if (!asset) continue;
    data.assets.push({
      asset: asset,
      amount: parseNum(rows[i]?.[2]),
      price: parseDollar(rows[i]?.[4]),
      aum: parseDollar(rows[i]?.[6]),
      pct: parseNum(rows[i]?.[8]?.replace('%','')) / 100
    });
  }
  data.venues = [];
  let currentAsset = '';
  for (let i = 31; i <= 44; i++) {
    const row = rows[i];
    if (!row) continue;
    const assetCol = row[1]?.trim();
    const venueCol = row[2]?.trim();
    if (assetCol && assetCol !== '') currentAsset = assetCol;
    if (venueCol && venueCol !== '') {
      data.venues.push({ asset: currentAsset, venue: venueCol, amount: row[4] || '', price: row[6] || '', value: row[8] || '' });
    } else if (assetCol) {
      data.venues.push({ asset: currentAsset, venue: '(Total)', amount: row[4] || '', price: row[6] || '', value: row[8] || '', isSummary: true });
    }
  }
  return data;
}

function parsePerfSummary(rows) {
  // PerfSummary tab layout (0-indexed):
  // Row 3 (idx 3): Inception Date | 12/12/2025 | Current Date | 2/10/2026
  // Row 4 (idx 4): Quarter Start | 12/31/2025 | Days Since Inception | 60
  // Row 8 (idx 8): Return | Fund(TWR) | BTC Benchmark | Alpha
  // Row 10 (idx 10): Inception BTC Price | | $90,287.49
  // Row 11 (idx 11): Current BTC Price | | $68,227.00
  // Row 12 (idx 12): P&L ($) | Fund | BTC | Alpha
  // Row 16 (idx 16): QTD Return | Fund | BTC | Alpha
  // Row 18 (idx 18): Dec 31 BTC Price | | $87,519.15
  // Row 19 (idx 19): QTD P&L ($) | Fund | BTC | Alpha
  // Row 22 (idx 22): Current AUM | value
  // Row 23 (idx 23): Total Capital Invested | value
  // Row 24 (idx 24): Total P&L | value
  // Row 25 (idx 25): BTC Holdings | 328.02
  // Row 26 (idx 26): Current BTC Price | $68,227.00
  // Row 27 (idx 27): Inception BTC Price | $90,287.49
  const data = {};
  data.inceptionDate = rows[3]?.[2];
  data.currentDate = rows[3]?.[4];
  data.quarterStart = rows[4]?.[2];
  data.daysSinceInception = parseNum(rows[4]?.[4]);
  
  // ITD (row 8)
  data.itdFundTWR = parsePct(rows[8]?.[2]);
  data.itdBTCTWR = parsePct(rows[8]?.[3]);
  data.itdAlpha = parsePct(rows[8]?.[4]);
  
  // BTC Prices (rows 10-11)
  data.inceptionBTCPrice = parseDollar(rows[10]?.[3]);
  data.currentBTCPrice = parseDollar(rows[11]?.[3]);
  
  // ITD P&L (row 12)
  data.itdPnLFund = parseDollar(rows[12]?.[2]);
  data.itdPnLBTC = parseDollar(rows[12]?.[3]);
  data.itdPnLAlpha = parseDollar(rows[12]?.[4]);
  
  // QTD (row 16)
  data.qtdFundTWR = parsePct(rows[16]?.[2]);
  data.qtdBTCTWR = parsePct(rows[16]?.[3]);
  data.qtdAlpha = parsePct(rows[16]?.[4]);
  
  // Dec 31 BTC price (row 18)
  data.dec31BTCPrice = parseDollar(rows[18]?.[3]);
  
  // QTD P&L (row 19)
  data.qtdPnLFund = parseDollar(rows[19]?.[2]);
  data.qtdPnLBTC = parseDollar(rows[19]?.[3]);
  data.qtdPnLAlpha = parseDollar(rows[19]?.[4]);
  
  // Key Metrics (rows 22-28)
  data.currentAUM = parseDollar(rows[22]?.[2]);
  data.totalCapitalInvested = parseDollar(rows[23]?.[2]);
  data.totalPnL = parseDollar(rows[24]?.[2]);
  data.btcHoldings = parseNum(rows[25]?.[2]);
  data.currentBTCPriceKM = parseDollar(rows[26]?.[2]);  // $68,227.00
  data.inceptionBTCPriceKM = parseDollar(rows[27]?.[2]); // $90,287.49
  
  return data;
}

function parseReturnsDaily(rows) {
  // RETURNS DAILY column layout (verified from sheet):
  // Portfolio - Consolidated group (cols 0-8):
  //   0: Date, 1: Inflows, 2: Invested (Cost Basis), 3: Cumulative Inflows
  //   4: Daily TWR, 5: Cumulative TWR, 6: Portfolio Value
  //   7: Total Gain/Loss, 8: MWR, 9: Alpha Spread (Fund cumTWR minus BTC cumTWR)
  // BTC group (cols 10-17):
  //   10: Holdings (Amt), 11: Asset Price, 12: Invested, 13: Market Value
  //   14: Total Gain/Loss (O), 15: Port Money Weighted Returns (P), 16: Daily TWR (Q), 17: Cumulative TWR (R)
  // WBTC group (cols 18+), USDC, USD, ETH follow after
  
  const COL = {
    date: 0,
    inflows: 1,
    invested: 2,
    cumInflows: 3,
    dailyTWR: 4,
    cumTWR: 5,
    portfolioValue: 6,
    totalGL: 7,
    mwr: 8,
    alphaSpread: 9,
    btcHoldings: 10,
    btcPrice: 11,
    btcInvested: 12,
    btcMarketValue: 13,
    btcCumTWR: 17,
  };
  
  console.log('[parseReturnsDaily] Using hardcoded columns:', COL);
  
  const data = [];
  
  for (let i = 3; i < rows.length; i++) {
    const row = rows[i];
    if (!row || !row[0]) continue;
    const dateStr = String(row[0]).trim();
    if (!dateStr.match(/^\d{1,2}\/\d{1,2}\/\d{2,4}$/)) continue;
    
    const dailyTWR = parsePctCell(row[COL.dailyTWR]);
    const cumTWR = parsePctCell(row[COL.cumTWR]);
    const portfolioValue = parseDollar(row[COL.portfolioValue]);
    const totalGL = parseDollar(row[COL.totalGL]);
    const alphaSpread = parsePctCell(row[COL.alphaSpread]);
    const btcHoldings = parseNum(row[COL.btcHoldings]);
    const btcPrice = parseDollar(row[COL.btcPrice]);
    const btcMarketValue = parseDollar(row[COL.btcMarketValue]);
    const btcInvested = parseDollar(row[COL.btcInvested]);
    const btcCumTWR = parsePctCell(row[COL.btcCumTWR]);
    const mwr = parsePctCell(row[COL.mwr]);
    
    if (cumTWR == null && dailyTWR == null && !portfolioValue) continue;
    data.push({ date: dateStr, dailyTWR, cumTWR, portfolioValue, totalGL, alphaSpread, btcHoldings, btcPrice, btcMarketValue, btcInvested, btcCumTWR, mwr });
  }
  return data;
}

function parsePctCell(s) {
  if (!s || s === '-' || s === '' || String(s).toLowerCase().includes('loading')) return null;
  const str = String(s).trim();
  let n = parseFloat(str.replace(/[%$,+]/g, '').replace(/[()]/g, m => m === '(' ? '-' : ''));
  if (isNaN(n)) return null;
  if (str.includes('%')) return n; // "-2.16%" â†’ -2.16
  // Small decimal without % sign = ratio, convert to percentage
  if (Math.abs(n) < 1) return n * 100;
  return n;
}

function parsePurchases(rows) {
  const purchases = [];
  for (let i = 3; i <= 20; i++) {
    const row = rows[i];
    if (!row || !row[1]) break;
    purchases.push({ token: row[1], venue: row[2], description: row[3], orderDate: row[4], fillDate: row[5], qty: parseNum(row[6]), basis: parseDollar(row[7]), value: parseDollar(row[8]) });
  }
  const inflows = [];
  for (let i = 3; i <= 20; i++) {
    const row = rows[i];
    if (!row || !row[10]) break;
    inflows.push({ stakeholder: row[10], person: row[11], asset: row[12], qty: row[13], basis: row[14], value: row[15], date: row[16] });
  }
  const stats = {};
  for (let i = 2; i <= 12; i++) {
    const row = rows[i];
    if (row && row[18]) stats[row[18].trim()] = row[19];
  }
  return { purchases, inflows, stats };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmtDollarCompact(n) {
  if (n == null || isNaN(n)) return 'â€”';
  if (Math.abs(n) >= 1e6) return '$' + (n/1e6).toFixed(2) + 'M';
  if (Math.abs(n) >= 1e3) return '$' + (n/1e3).toFixed(0) + 'K';
  return '$' + n.toFixed(0);
}

function makeBadge(val, prevVal, prevLabel) {
  if (val == null || isNaN(val)) return '';
  const isPos = val >= 0;
  const color = isPos ? '#4ADE80' : '#F87171';
  const arrow = isPos ? 'â–²' : 'â–¼';
  const bgClass = isPos ? 'badge-pos' : 'badge-neg';
  const pctStr = (isPos ? '+' : '') + (val * 100).toFixed(1) + '%';
  let html = `<span class="badge ${bgClass}">`;
  html += `<span class="arr" style="color:${color}">${arrow}</span>`;
  html += `<span class="pv" style="color:${color}">${pctStr}</span>`;
  if (prevLabel != null) {
    html += `<span class="sp">Â·</span><span class="dt">prev wk</span> <span class="dm">${prevLabel}</span>`;
  }
  html += '</span>';
  return html;
}

function renderDrawdownStats(returnsDaily) {
  // TWR-based drawdown (for overview tab if needed)
  let peak = 1, maxDD = 0, maxDDDate = '', curDD = 0;
  for (const d of returnsDaily) {
    const cumVal = 1 + (d.cumTWR || 0) / 100;
    if (cumVal > peak) peak = cumVal;
    const dd = (cumVal - peak) / peak;
    if (dd < maxDD) { maxDD = dd; maxDDDate = d.date; }
    curDD = dd;
  }
  ['maxDDValue'].forEach(id => { const el = document.getElementById(id); if (el) el.textContent = fmtPctRaw(maxDD * 100); });
  ['maxDDDate'].forEach(id => { const el = document.getElementById(id); if (el) el.textContent = maxDDDate ? formatDateLabel(maxDDDate) : ''; });
  ['curDDValue'].forEach(id => { const el = document.getElementById(id); if (el) el.textContent = fmtPctRaw(curDD * 100); });
  
  // MWR-based drawdown (for performance tab)
  let minMWR = 0, minMWRDate = '', curMWR = 0;
  for (const d of returnsDaily) {
    if (d.mwr != null) {
      curMWR = d.mwr;
      if (d.mwr < minMWR) { minMWR = d.mwr; minMWRDate = d.date; }
    }
  }
  
  const maxDDEl2 = document.getElementById('maxDDValue2');
  if (maxDDEl2) maxDDEl2.textContent = fmtPctRaw(minMWR);
  
  const maxDDDateEl2 = document.getElementById('maxDDDate2');
  if (maxDDDateEl2 && minMWRDate) {
    const d = new Date(minMWRDate);
    if (!isNaN(d)) {
      maxDDDateEl2.textContent = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    } else {
      maxDDDateEl2.textContent = formatDateLabel(minMWRDate);
    }
  }
  
  const curDDEl2 = document.getElementById('curDDValue2');
  if (curDDEl2) curDDEl2.textContent = fmtPctRaw(curMWR);
  
  // Recovery from trough
  const recoveryEl = document.getElementById('curDDRecovery2');
  if (recoveryEl && minMWR < 0) {
    const recoveryPct = Math.round(((curMWR - minMWR) / Math.abs(minMWR)) * 100);
    recoveryEl.textContent = recoveryPct + '% recovered from trough';
  }
}

function renderPerfHero(dash, perf, returnsDaily) {
  // Days since inception
  const inception = new Date(INCEPTION_DATE);
  const today = new Date();
  const daysSince = Math.floor((today - inception) / (1000 * 60 * 60 * 24));
  const daysEl = document.getElementById('heroDaysSinceInception');
  if (daysEl) daysEl.textContent = daysSince;
  
  // Max Drawdown based on MWR column
  let minMWR = 0;
  for (const d of returnsDaily) {
    if (d.mwr != null && d.mwr < minMWR) {
      minMWR = d.mwr;
    }
  }
  const maxDDEl = document.getElementById('heroMaxDDMWR');
  if (maxDDEl) {
    maxDDEl.textContent = fmtPctRaw(minMWR);
    maxDDEl.style.color = minMWR < 0 ? '#F87171' : '#4ADE80';
  }
  
  // ITD PNL - same as purchases tab (from mwrRows[0].itdPnl)
  const itdPnl = dash.mwrRows?.[0]?.itdPnl;
  const pnlEl = document.getElementById('heroPerfITDPNL');
  if (pnlEl && itdPnl != null) {
    const abs = Math.abs(itdPnl);
    const sign = itdPnl < 0 ? '-' : '';
    const formatted = abs >= 1e6 ? sign + '$' + (abs/1e6).toFixed(2) + 'M' : abs >= 1e3 ? sign + '$' + (abs/1e3).toFixed(0) + 'K' : sign + '$' + abs.toFixed(0);
    pnlEl.textContent = formatted;
    pnlEl.style.color = itdPnl >= 0 ? '#4ADE80' : '#F87171';
  }
  
  // ITD MWR
  const itdMWR = dash.mwrITDFund;
  const mwrEl = document.getElementById('heroITDMWR');
  if (mwrEl && itdMWR != null) {
    mwrEl.textContent = fmtPct(itdMWR);
    mwrEl.style.color = itdMWR < 0 ? '#F87171' : '#4ADE80';
  }
}

function renderHero(dash, perf, returnsDaily) {
  // AUM
  const aum = perf?.currentAUM || dash.aum;
  document.getElementById('heroAUM').textContent = fmtDollar(aum, true);
  const aumDelta = (aum - INCEPTION_AUM) / INCEPTION_AUM;
  // Prev week AUM from returnsDaily
  let prevAUM = null;
  if (returnsDaily && returnsDaily.length > 7) prevAUM = returnsDaily[returnsDaily.length - 8]?.portfolioValue;
  const prevAUMDelta = prevAUM ? (aum - prevAUM) / prevAUM : aumDelta;
  document.getElementById('heroAUMBadge').innerHTML = makeBadge(prevAUMDelta, null, prevAUM ? fmtDollar(prevAUM, true) : fmtDollar(INCEPTION_AUM, true));

  // BTC Holdings
  document.getElementById('heroBTC').textContent = fmtNum(dash.btcHoldings);
  let prevBTC = null;
  if (returnsDaily && returnsDaily.length > 7) prevBTC = returnsDaily[returnsDaily.length - 8]?.btcHoldings;
  const btcDelta = prevBTC ? (dash.btcHoldings - prevBTC) / prevBTC : null;
  const btcBadgeDefault = btcDelta != null ? makeBadge(btcDelta, null, fmtNum(prevBTC)) : '';
  document.getElementById('heroBTCBadge').innerHTML = btcBadgeDefault;

  // BTC hover to show USD â€” also update badge to show USD market value change
  const btcCard = document.getElementById('heroBTCCardHover');
  const btcValEl = document.getElementById('heroBTC');
  const btcHintEl = document.getElementById('heroBTCHint');
  const btcBadgeEl = document.getElementById('heroBTCBadge');
  const currentBTCMarketVal = dash.btcHoldings * dash.btcPrice;
  let prevBTCMarketVal = null;
  if (returnsDaily && returnsDaily.length > 7) {
    const prevRow = returnsDaily[returnsDaily.length - 8];
    prevBTCMarketVal = prevRow ? (prevRow.btcHoldings || 0) * (prevRow.btcPrice || 0) : null;
  }
  const btcMVDelta = prevBTCMarketVal ? (currentBTCMarketVal - prevBTCMarketVal) / prevBTCMarketVal : null;
  const btcBadgeUSD = btcMVDelta != null ? makeBadge(btcMVDelta, null, fmtDollar(prevBTCMarketVal, true)) : '';
  btcCard.onmouseenter = () => { btcValEl.textContent = fmtDollar(currentBTCMarketVal, true); btcHintEl.style.opacity = '0'; btcBadgeEl.innerHTML = btcBadgeUSD; };
  btcCard.onmouseleave = () => { btcValEl.textContent = fmtNum(dash.btcHoldings); btcHintEl.style.opacity = '1'; btcBadgeEl.innerHTML = btcBadgeDefault; };

  // BTC Price
  document.getElementById('heroBTCPrice').textContent = fmtDollar(dash.btcPrice);
  const prevPrice = returnsDaily && returnsDaily.length > 7 ? returnsDaily[returnsDaily.length - 8]?.btcPrice : null;
  const priceDelta = prevPrice ? (dash.btcPrice - prevPrice) / prevPrice : (dash.btcPrice - INCEPTION_BTC_PRICE) / INCEPTION_BTC_PRICE;
  document.getElementById('heroBTCPriceBadge').innerHTML = makeBadge(priceDelta, null, prevPrice ? fmtDollar(prevPrice, true) : fmtDollar(INCEPTION_BTC_PRICE, true));

  // Avg Cost Basis
  const avgCost = dash.btcAvgCost || 88923;
  document.getElementById('heroAvgCost').textContent = fmtDollar(avgCost);
  const aboveSpot = avgCost - dash.btcPrice;
  const isAbove = aboveSpot > 0;
  const aboveColor = isAbove ? '#F87171' : '#4ADE80';
  const badgeClass = isAbove ? 'badge-neg' : 'badge-pos';
  document.getElementById('heroAvgCostBadge').innerHTML = `<span class="badge ${badgeClass}"><span class="pv" style="color:${aboveColor}">${fmtDollarCompact(Math.abs(aboveSpot))}</span><span class="sp">Â·</span><span class="dt" style="color:#F1F5F9">${isAbove ? 'above spot' : 'below spot'}</span></span>`;

  // BTC Exposure and Cash + Stables for allocation tab
  if (dash.assets) {
    const btcPct = dash.assets.filter(a => a.asset === 'BTC' || a.asset === 'WBTC').reduce((s, a) => s + (a.pct || 0), 0);
    const cashPct = dash.assets.filter(a => a.asset === 'USDC' || a.asset === 'Cash').reduce((s, a) => s + (a.pct || 0), 0);
    const expEl = document.getElementById('heroBTCExposure');
    if (expEl) expEl.textContent = (btcPct * 100).toFixed(2) + '%';
    const cashEl = document.getElementById('heroCashStables');
    if (cashEl) cashEl.textContent = (cashPct * 100).toFixed(2) + '%';
    
    // BTC Exposure delta vs 80% target
    const btcDelta = (btcPct * 100) - 80;
    const btcDeltaStr = (btcDelta >= 0 ? '+' : '') + btcDelta.toFixed(2) + '%';
    const btcDeltaLabel = btcDelta >= 0 ? 'above target' : 'below target';
    const btcExpBadge = document.getElementById('heroBTCExposureBadge');
    if (btcExpBadge) btcExpBadge.innerHTML = `<span class="badge badge-neg"><span class="pv" style="color:#F87171">${btcDeltaStr}</span><span class="sp">Â·</span><span class="dt" style="color:#F1F5F9">${btcDeltaLabel}</span></span>`;
    
    // Cash + Stables delta vs 20% target
    const cashDelta = (cashPct * 100) - 20;
    const cashDeltaStr = (cashDelta >= 0 ? '+' : '') + cashDelta.toFixed(2) + '%';
    const cashDeltaLabel = cashDelta >= 0 ? 'above target' : 'below target';
    const cashBadge = document.getElementById('heroCashStablesBadge');
    if (cashBadge) cashBadge.innerHTML = `<span class="badge badge-neg"><span class="pv" style="color:#F87171">${cashDeltaStr}</span><span class="sp">Â·</span><span class="dt" style="color:#F1F5F9">${cashDeltaLabel}</span></span>`;
  }

  // Date
  // headerDate is set in loadAllData after all rendering
}

function renderITDQTD(dash, perf, returnsDaily) {
  const setReturn = (id, val) => {
    const el = document.getElementById(id);
    if (!el) return;
    if (val == null) { el.textContent = 'â€”'; return; }
    el.textContent = (val >= 0 ? '+' : '') + fmtPct(val);
    el.style.color = val >= 0 ? '#4ADE80' : '#F87171';
    const bar = el.closest('.ret-i')?.querySelector('.ret-bar');
    if (bar) bar.style.background = val >= 0 ? '#4ADE80' : '#F87171';
  };

  const itdFund = perf?.itdFundTWR ?? dash.itdTWRFund;
  const itdBTC = perf?.itdBTCTWR ?? dash.itdTWRBTC;
  const itdAlpha = perf?.itdAlpha ?? dash.itdAlpha;
  const qtdFund = perf?.qtdFundTWR ?? dash.qtdTWRFund;
  const qtdBTC = perf?.qtdBTCTWR ?? dash.qtdTWRBTC;
  const qtdAlpha = perf?.qtdAlpha ?? dash.qtdAlpha;

  setReturn('itdFund', itdFund);
  setReturn('itdBTC', itdBTC);
  setReturn('qtdFund', qtdFund);
  setReturn('qtdBTC', qtdBTC);

  // Alpha boxes
  const renderAlpha = (id, val, prevPP, prevPct) => {
    const el = document.getElementById(id);
    if (!el) return;
    if (val == null) { el.textContent = 'â€”'; return; }
    const isPos = val >= 0;
    el.textContent = (isPos ? '+' : '') + fmtPct(val);
    el.className = isPos ? 'alpha-val' : 'alpha-val';
    const badgeEl = document.getElementById(id === 'itdAlpha' ? 'itdAlphaBadge' : 'qtdAlphaBadge');
    if (badgeEl && prevPP) {
      badgeEl.innerHTML = `<span class="alpha-bdg"><span class="av">â–²</span><span class="av">${prevPP}</span><span class="as">Â·</span><span class="ad">prev wk</span> <span class="am">${prevPct}</span></span>`;
    }
  };

  // Compute ITD alpha WoW from returnsDaily alphaSpread (col J) 
  let itdPrevPP = null, itdPrevPct = null;
  if (returnsDaily && returnsDaily.length > 7) {
    const curAlpha = returnsDaily[returnsDaily.length - 1]?.alphaSpread;
    const prevAlpha = returnsDaily[returnsDaily.length - 8]?.alphaSpread;
    if (curAlpha != null && prevAlpha != null) {
      const ppChange = curAlpha - prevAlpha;
      itdPrevPP = (ppChange >= 0 ? '+' : '') + ppChange.toFixed(2) + 'pp';
      itdPrevPct = (prevAlpha >= 0 ? '+' : '') + prevAlpha.toFixed(2) + '%';
    }
  }

  // Compute QTD alpha WoW â€” find quarter start (Dec 31 / Jan 1), compute QTD alpha at current and prev week
  let qtdPrevPP = null, qtdPrevPct = null;
  if (returnsDaily && returnsDaily.length > 7) {
    // Find quarter start index (last trading day of Dec or first of Jan)
    let qStartIdx = 0;
    for (let i = 0; i < returnsDaily.length; i++) {
      const d = returnsDaily[i].date;
      if (d && (d.startsWith('1/1/') || d.startsWith('1/2/') || d === '12/31/2025')) { qStartIdx = i; break; }
    }
    // If no Jan date found, fallback to start of data
    if (qStartIdx === 0) {
      for (let i = 0; i < returnsDaily.length; i++) {
        if (returnsDaily[i].date && returnsDaily[i].date.startsWith('1/')) { qStartIdx = i; break; }
      }
    }
    
    const qStartFundTWR = returnsDaily[qStartIdx]?.cumTWR || 0;
    const qStartBtcTWR = returnsDaily[qStartIdx]?.btcCumTWR || 0;
    
    const cur = returnsDaily[returnsDaily.length - 1];
    const prev = returnsDaily[returnsDaily.length - 8];
    
    // QTD alpha = (fund return since q start) - (btc return since q start)
    // Using compound: ((1+cur)/(1+start) - 1) but since these are cumulative %, approximate with difference
    const curQtdFund = (cur?.cumTWR || 0) - qStartFundTWR;
    const curQtdBtc = (cur?.btcCumTWR || 0) - qStartBtcTWR;
    const curQtdAlpha = curQtdFund - curQtdBtc;
    
    const prevQtdFund = (prev?.cumTWR || 0) - qStartFundTWR;
    const prevQtdBtc = (prev?.btcCumTWR || 0) - qStartBtcTWR;
    const prevQtdAlpha = prevQtdFund - prevQtdBtc;
    
    const ppChange = curQtdAlpha - prevQtdAlpha;
    qtdPrevPP = (ppChange >= 0 ? '+' : '') + ppChange.toFixed(2) + 'pp';
    qtdPrevPct = (prevQtdAlpha >= 0 ? '+' : '') + prevQtdAlpha.toFixed(2) + '%';
  }

  renderAlpha('itdAlpha', itdAlpha, itdPrevPP, itdPrevPct);
  renderAlpha('qtdAlpha', qtdAlpha, qtdPrevPP, qtdPrevPct);
}

function renderMWR(dash) {
  const tbody = document.getElementById('mwrBody');
  if (!tbody) return;
  tbody.innerHTML = '';
  dash.mwrRows.forEach((r, i) => {
    if (!r.label) return;
    const tr = document.createElement('tr');
    if (i === 0) tr.className = 'bold';
    tr.innerHTML = `
      <td>${r.label}</td>
      <td style="color:${(r.qtdPnl||0) >= 0 ? '#4ADE80' : '#F87171'}">${fmtDollar(r.qtdPnl)}</td>
      <td style="color:${(r.qtdRet||0) >= 0 ? '#4ADE80' : '#F87171'}">${fmtPct(r.qtdRet)}</td>
      <td style="color:${(r.itdPnl||0) >= 0 ? '#4ADE80' : '#F87171'}">${fmtDollar(r.itdPnl)}</td>
      <td style="color:${(r.itdRet||0) >= 0 ? '#4ADE80' : '#F87171'}">${fmtPct(r.itdRet)}</td>`;
    tbody.appendChild(tr);
  });
}

function renderBTCTWR(dash) {
  const tbody = document.getElementById('btcTwrBody');
  if (!tbody) return;
  tbody.innerHTML = '';
  const r = dash.btcTWR;
  const tr = document.createElement('tr');
  tr.className = 'bold';
  tr.innerHTML = `
    <td>${r.label}</td>
    <td style="color:${(r.qtdPnl||0) >= 0 ? '#4ADE80' : '#F87171'}">${fmtDollar(r.qtdPnl)}</td>
    <td style="color:${(r.qtdRet||0) >= 0 ? '#4ADE80' : '#F87171'}">${fmtPct(r.qtdRet)}</td>
    <td style="color:${(r.itdPnl||0) >= 0 ? '#4ADE80' : '#F87171'}">${fmtDollar(r.itdPnl)}</td>
    <td style="color:${(r.itdRet||0) >= 0 ? '#4ADE80' : '#F87171'}">${fmtPct(r.itdRet)}</td>`;
  tbody.appendChild(tr);
}

function renderPerfSummary(dash) {
  const tbody = document.getElementById('perfSummaryBody');
  if (!tbody) return;
  tbody.innerHTML = '';
  
  function fmtPnlCompact(n) {
    if (n == null || isNaN(n)) return 'â€”';
    const abs = Math.abs(n);
    const sign = n < 0 ? '-' : '';
    if (abs >= 1e6) return sign + '$' + (abs/1e6).toFixed(2) + 'M';
    if (abs >= 1e3) return sign + '$' + (abs/1e3).toFixed(0) + 'K';
    return sign + '$' + abs.toFixed(0);
  }
  
  function valBadge(text, v) {
    const color = (v||0) >= 0 ? '#4ADE80' : '#F87171';
    const bg = (v||0) >= 0 ? 'rgba(34,197,94,0.12)' : 'rgba(248,113,113,0.12)';
    return `<span style="background:${bg};color:${color};padding:3px 10px;border-radius:4px;font-family:'JetBrains Mono',monospace;font-weight:700;font-size:12px">${text}</span>`;
  }
  function pnlBadge(n) { return valBadge(fmtPnlCompact(n), n); }
  function retBadge(v) {
    if (v == null || isNaN(v)) return 'â€”';
    const pct = (v * 100).toFixed(2);
    return valBadge(pct + '%', v);
  }
  
  // Check if a row has any meaningful data
  function hasData(r) {
    return (r.qtdPnl != null && !isNaN(r.qtdPnl)) || (r.qtdRet != null && !isNaN(r.qtdRet)) || (r.itdPnl != null && !isNaN(r.itdPnl)) || (r.itdRet != null && !isNaN(r.itdRet));
  }
  
  const cellStyle = 'text-align:right';
  
  // Fund row (bold, top-level)
  const fund = dash.mwrRows?.[0];
  if (fund && hasData(fund)) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="text-align:left;color:#F1F5F9;font-weight:700;font-size:14px">${fund.label || 'Fund'}</td>
      <td style="${cellStyle}">${pnlBadge(fund.qtdPnl)}</td>
      <td style="${cellStyle}">${retBadge(fund.qtdRet)}</td>
      <td style="${cellStyle}">${pnlBadge(fund.itdPnl)}</td>
      <td style="${cellStyle}">${retBadge(fund.itdRet)}</td>`;
    tbody.appendChild(tr);
  }
  
  // Component rows (indented with â”” prefix) - skip blank rows
  for (let i = 1; i < (dash.mwrRows?.length || 0); i++) {
    const r = dash.mwrRows[i];
    if (!r.label || !hasData(r)) continue;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="text-align:left;color:#94A3B8;padding-left:16px">â”” ${r.label}</td>
      <td style="${cellStyle}">${pnlBadge(r.qtdPnl)}</td>
      <td style="${cellStyle}">${retBadge(r.qtdRet)}</td>
      <td style="${cellStyle}">${pnlBadge(r.itdPnl)}</td>
      <td style="${cellStyle}">${retBadge(r.itdRet)}</td>`;
    tbody.appendChild(tr);
  }
  
  // BTC Benchmark row (bold) - force label
  const btc = dash.btcTWR;
  if (btc) {
    const tr = document.createElement('tr');
    tr.style.borderTop = '1px solid rgba(148,163,184,0.1)';
    tr.innerHTML = `
      <td style="text-align:left;color:#F1F5F9;font-weight:700;font-size:14px">BTC Benchmark</td>
      <td style="${cellStyle}">${pnlBadge(btc.qtdPnl)}</td>
      <td style="${cellStyle}">${retBadge(btc.qtdRet)}</td>
      <td style="${cellStyle}">${pnlBadge(btc.itdPnl)}</td>
      <td style="${cellStyle}">${retBadge(btc.itdRet)}</td>`;
    tbody.appendChild(tr);
  }
}

function renderKeyMetrics(dash, perf, purchData) {
  const container = document.getElementById('keyMetricsDetail');
  if (!container) return;
  const stats = purchData?.stats || {};
  const avgPurch = parseDollar(dash.btcAvgPurchasePrice) || parseDollar(stats['Average Purchase Price']) || 85737.07;
  const avgVsInception = avgPurch - INCEPTION_BTC_PRICE;
  const belowInception = avgVsInception < 0;
  const items = [
    { label: 'BTC Avg Cost', value: fmtDollar(Math.round(dash.btcAvgCost || dash.avgCost || 88923)) },
    { label: 'BTC Avg Purchase Price', value: fmtDollar(avgPurch) },
    { label: 'Inception Date BTC Price', value: fmtDollar(perf?.inceptionBTCPrice || INCEPTION_BTC_PRICE) },
    { label: 'Avg Purchase vs Inception', value: fmtDollar(avgVsInception), color: belowInception ? '#4ADE80' : '#F87171', sub: belowInception ? 'Below inception price' : 'Above inception price', subColor: belowInception ? '#4ADE80' : '#F87171' },
    { label: '2.5% of AUM', value: fmtDollar(parseDollar(dash.twoPointFiveAUM) || (dash.aum ? dash.aum * 0.025 : null)) },
    { label: 'ITD Money Weighted Return', value: fmtPct(dash.mwrITDFund), color: dash.mwrITDFund < 0 ? '#F87171' : '#4ADE80' },
    { label: 'QTD Money Weighted Return', value: fmtPct(dash.mwrQTDFund), color: (dash.mwrQTDFund || 0) < 0 ? '#F87171' : '#4ADE80' },
  ];
  container.innerHTML = items.map(i => {
    const valColor = i.color || '#F1F5F9';
    let html = `<div class="met-row"><span class="met-row-label">${i.label}</span><span class="met-row-value" style="color:${valColor}">${i.value || 'â€”'}</span></div>`;
    if (i.sub) html += `<div style="text-align:right;padding-bottom:8px"><span class="met-row-sub" style="color:${i.subColor || '#4ADE80'}">${i.sub}</span></div>`;
    return html;
  }).join('');
}

function renderTWRSummary(dash, perf) {
  const container = document.getElementById('twrSummary');
  if (!container) return;
  
  const itdFund = perf?.itdFundTWR ?? dash.itdTWRFund;
  const itdBTC = perf?.itdBTCTWR ?? dash.itdTWRBTC;
  const itdAlpha = perf?.itdAlpha ?? dash.itdAlpha;
  const qtdFund = perf?.qtdFundTWR ?? dash.qtdTWRFund;
  const qtdBTC = perf?.qtdBTCTWR ?? dash.qtdTWRBTC;
  const qtdAlpha = perf?.qtdAlpha ?? dash.qtdAlpha;
  
  const fmtVal = (v) => {
    if (v == null || isNaN(v)) return { text: 'â€”', color: '#94A3B8' };
    const pct = (v * 100).toFixed(2);
    return { text: (v >= 0 ? '+' : '') + pct + '%', color: v >= 0 ? '#4ADE80' : '#F87171' };
  };
  
  const periods = [
    { title: 'Inception to Date', color: '#F7931A', rows: [
      { label: 'Fund', ...fmtVal(itdFund) },
      { label: 'BTC Benchmark', ...fmtVal(itdBTC) },
      { label: 'Alpha', ...fmtVal(itdAlpha), isAlpha: true },
    ]},
    { title: 'Quarter to Date', color: '#3B82F6', rows: [
      { label: 'Fund', ...fmtVal(qtdFund) },
      { label: 'BTC Benchmark', ...fmtVal(qtdBTC) },
      { label: 'Alpha', ...fmtVal(qtdAlpha), isAlpha: true },
    ]}
  ];
  
  container.innerHTML = periods.map((p, i) => `
    <div class="twr-period" ${i === periods.length-1 ? 'style="border-bottom:none;margin-bottom:0;padding-bottom:0"' : ''}>
      <div class="twr-period-title"><span class="twr-period-bar" style="background:${p.color}"></span>${p.title}</div>
      ${p.rows.map(r => `
        <div class="twr-row">
          <span class="twr-row-label${r.isAlpha ? ' alpha' : ''}">${r.label}</span>
          <span class="twr-row-value" style="color:${r.isAlpha ? '#4ADE80' : r.color}">${r.text}</span>
        </div>
      `).join('')}
    </div>
  `).join('');
}

function renderAllocation(dash) {
  const colors = { BTC: '#F7931A', WBTC: '#E8A838', USDC: '#2775CA', Cash: '#16A34A', ETH: '#94A3B8' };
  
  // Sort assets by weight descending
  const sorted = [...dash.assets].sort((a, b) => (b.pct || 0) - (a.pct || 0));
  
  // New table with progress bars
  const tbody = document.getElementById('allocTableNew');
  if (tbody) {
    tbody.innerHTML = '';
    sorted.forEach(a => {
      const pct = ((a.pct || 0) * 100);
      const pctStr = pct.toFixed(2);
      const color = colors[a.asset] || '#94A3B8';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="text-align:left;color:#F1F5F9;font-weight:700"><span style="display:inline-block;width:8px;height:8px;border-radius:2px;background:${color};margin-right:8px"></span>${a.asset}</td>
        <td style="text-align:right;color:#F1F5F9;font-weight:700;font-family:'JetBrains Mono',monospace">${fmtNum(a.amount, a.asset === 'USDC' || a.asset === 'Cash' ? 2 : a.amount < 1 ? 4 : 2)}</td>
        <td style="text-align:right;color:#F1F5F9;font-weight:700;font-family:'JetBrains Mono',monospace">${fmtDollar(a.price)}</td>
        <td style="text-align:right;color:#F1F5F9;font-weight:700">${fmtDollar(a.aum, true)}</td>
        <td style="text-align:right">
          <div style="display:flex;align-items:center;justify-content:flex-end;gap:10px">
            <div style="width:120px;height:6px;background:rgba(148,163,184,0.1);border-radius:3px;overflow:hidden">
              <div style="width:${Math.max(1, pct)}%;height:100%;background:${color};border-radius:3px"></div>
            </div>
            <span style="min-width:55px;text-align:right;color:#F1F5F9;font-weight:700;font-family:'JetBrains Mono',monospace">${pctStr}%</span>
          </div>
        </td>`;
      tbody.appendChild(tr);
    });
  }
  
  // Allocation pie chart (same as overview but in allocation tab)
  const pieCtx = document.getElementById('allocPieChart')?.getContext('2d');
  if (pieCtx) {
    if (charts.allocPie) charts.allocPie.destroy();
    const assets = sorted.filter(a => (a.pct || 0) >= 0); // include all assets even 0%
    charts.allocPie = new Chart(pieCtx, {
      type: 'doughnut',
      data: {
        labels: assets.map(a => a.asset),
        datasets: [{ data: assets.map(a => (a.pct || 0) * 100), backgroundColor: assets.map(a => colors[a.asset] || '#94A3B8'), borderWidth: 2, borderColor: '#0B1120' }]
      },
      options: { responsive: true, maintainAspectRatio: false, cutout: '58%', rotation: -177, plugins: { legend: { display: false }, tooltip: { enabled: true, backgroundColor: 'rgba(15,23,42,0.95)', borderColor: 'rgba(148,163,184,0.2)', borderWidth: 1, callbacks: { label: ctx => ` ${ctx.label}: ${ctx.raw.toFixed(1)}%` } } } }
    });
    const legendEl = document.getElementById('allocPieLegend');
    if (legendEl) {
      legendEl.innerHTML = assets.map(a => {
        const c = colors[a.asset] || '#94A3B8';
        return `<div style="display:flex;align-items:center;gap:8px"><span style="width:13px;height:13px;border-radius:3px;background:${c}"></span><span style="color:#B0BEC5">${a.asset}</span><span style="color:#F1F5F9;font-family:'JetBrains Mono',monospace;font-weight:600">${((a.pct||0)*100).toFixed(1)}%</span></div>`;
      }).join('');
    }
  }
}

function renderVenues(dash) {
  const tbody = document.getElementById('venueTable');
  if (!tbody) return;
  tbody.innerHTML = '';
  dash.venues.forEach(v => {
    const tr = document.createElement('tr');
    if (v.isSummary) tr.className = 'bold';
    tr.innerHTML = `<td>${v.isSummary ? v.asset : ''}</td><td>${v.isSummary ? '' : v.venue}</td><td>${v.amount}</td><td>${v.price}</td><td>${v.value}</td>`;
    tbody.appendChild(tr);
  });
}

function renderAssetPieChart(dash) {
  const ctx = document.getElementById('assetPieChart')?.getContext('2d');
  if (!ctx || !dash.assets) return;
  if (charts.assetPie) charts.assetPie.destroy();
  
  const ASSET_COLORS = { BTC: '#F7931A', WBTC: '#E8A838', USDC: '#2775CA', Cash: '#16A34A', ETH: '#94A3B8' };
  const assets = dash.assets.filter(a => (a.pct || 0) >= 0); // include all assets even 0%
  
  charts.assetPie = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: assets.map(a => a.asset),
      datasets: [{
        data: assets.map(a => (a.pct || 0) * 100),
        backgroundColor: assets.map(a => ASSET_COLORS[a.asset] || '#94A3B8'),
        borderWidth: 2,
        borderColor: '#0B1120',
        hoverBorderColor: '#F1F5F9',
        hoverBorderWidth: 2,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      cutout: '58%',
      rotation: -177,
      plugins: {
        legend: { display: false },
        tooltip: {
          enabled: false,
          external: function(context) {
            let el = document.getElementById('pieTooltip');
            if (!el) {
              el = document.createElement('div');
              el.id = 'pieTooltip';
              el.style.cssText = 'position:absolute;pointer-events:none;z-index:50;transition:opacity 0.15s;';
              document.body.appendChild(el);
            }
            const tooltip = context.tooltip;
            if (tooltip.opacity === 0) { el.style.opacity = '0'; return; }
            
            const idx = tooltip.dataPoints?.[0]?.dataIndex;
            const asset = assets[idx];
            if (!asset) { el.style.opacity = '0'; return; }
            const color = ASSET_COLORS[asset.asset] || '#94A3B8';
            
            let html = '<div style="background:rgba(15,23,42,0.95);border:1px solid rgba(148,163,184,0.2);border-radius:10px;padding:14px 18px;min-width:180px;font-family:\'JetBrains Mono\',monospace">';
            html += '<div style="font-size:16px;font-weight:700;color:' + color + ';margin-bottom:10px">' + asset.asset + '</div>';
            
            const rows = [
              { label: 'Holdings:', value: fmtNum(asset.amount, asset.amount < 1 ? 4 : 2), valColor: color },
              { label: 'USD Value:', value: fmtDollar(asset.aum, true), valColor: color },
              { label: 'Weight:', value: ((asset.pct || 0) * 100).toFixed(2) + '%', valColor: '#F1F5F9' },
            ];
            rows.forEach(r => {
              html += '<div style="display:flex;justify-content:space-between;gap:20px;margin-bottom:4px">';
              html += '<span style="color:#94A3B8;font-size:12px">' + r.label + '</span>';
              html += '<span style="color:' + r.valColor + ';font-size:12px;font-weight:600">' + r.value + '</span>';
              html += '</div>';
            });
            html += '</div>';
            el.innerHTML = html;
            el.style.opacity = '1';
            
            const pos = context.chart.canvas.getBoundingClientRect();
            el.style.left = (pos.left + window.scrollX + tooltip.caretX + 12) + 'px';
            el.style.top = (pos.top + window.scrollY + tooltip.caretY - 20) + 'px';
          }
        }
      }
    }
  });
  
  // Render legend
  const legendEl = document.getElementById('pieLegend');
  if (legendEl) {
    legendEl.innerHTML = assets.map(a => {
      const c = ASSET_COLORS[a.asset] || '#94A3B8';
      return `<div style="display:flex;align-items:center;gap:8px"><span style="width:13px;height:13px;border-radius:3px;background:${c}"></span><span style="color:#B0BEC5">${a.asset}</span><span style="color:#F1F5F9;font-family:'JetBrains Mono',monospace;font-weight:600">${((a.pct||0)*100).toFixed(1)}%</span></div>`;
    }).join('');
  }
}

function renderVenueBreakdown(dash, containerId) {
  const container = document.getElementById(containerId || 'venueBreakdown');
  if (!container || !dash.venues) return;
  
  // Same colors as pie chart
  const ASSET_COLORS = { BTC: '#F7931A', WBTC: '#E8A838', USDC: '#2775CA', Cash: '#16A34A', ETH: '#94A3B8' };
  
  // Group venues by asset, parse values
  const groups = {};
  let currentAsset = null;
  dash.venues.forEach(v => {
    if (v.isSummary) {
      currentAsset = v.asset;
      const val = parseDollar(v.value) || parseDollar(v.amount) || 0;
      if (!groups[currentAsset]) groups[currentAsset] = { items: [], total: val };
      else groups[currentAsset].total = val;
    } else {
      if (!currentAsset) currentAsset = v.asset;
      if (!groups[currentAsset]) groups[currentAsset] = { items: [], total: 0 };
      const val = parseDollar(v.value) || 0;
      if (val > 0.01) { // filter out $0 venues
        groups[currentAsset].items.push({ venue: v.venue, value: val });
      }
    }
  });
  
  // Calculate totals for single-venue groups
  Object.keys(groups).forEach(asset => {
    if (groups[asset].total === 0 && groups[asset].items.length > 0) {
      groups[asset].total = groups[asset].items.reduce((s, i) => s + i.value, 0);
    }
  });
  
  // Sort by total value descending
  const sorted = Object.entries(groups)
    .filter(([_, data]) => data.total > 0.01)
    .sort((a, b) => b[1].total - a[1].total);
  
  // Compact dollar format
  const fmtCompact = (v) => {
    if (v == null || isNaN(v)) return 'â€”';
    if (Math.abs(v) >= 1e6) return '$' + (v / 1e6).toFixed(2) + 'M';
    if (Math.abs(v) >= 1e3) return '$' + Math.round(v / 1e3) + 'K';
    return '$' + v.toFixed(2);
  };
  
  let html = '';
  sorted.forEach(([asset, data]) => {
    const color = ASSET_COLORS[asset] || '#94A3B8';
    html += `<div class="venue-group">`;
    html += `<div class="venue-asset-title" style="color:${color}">${asset}</div>`;
    data.items.forEach((item, idx) => {
      html += `<div class="venue-row"><span class="venue-row-label">${item.venue}</span><span class="venue-row-value">${fmtCompact(item.value)}</span></div>`;
    });
    if (data.items.length > 1) {
      html += `<div class="venue-total"><span class="venue-total-label">TOTAL</span><span class="venue-total-value">${fmtCompact(data.total)}</span></div>`;
    }
    html += `</div>`;
  });
  
  container.innerHTML = html;
}

function renderPurchases(purchData, dash) {
  const ptbody = document.getElementById('purchaseTable');
  ptbody.innerHTML = '';
  const btcPrice = dash.btcPrice || 0;
  const avgCost = parseDollar(dash.btcAvgCost) || 88923;
  
  // Helper to format cost/value smartly
  function fmtSmartDollar(n) {
    if (n == null || isNaN(n)) return 'â€”';
    const abs = Math.abs(n);
    const sign = n < 0 ? '-' : '';
    if (abs >= 1e6) return sign + '$' + (abs/1e6).toFixed(2) + 'M';
    if (abs >= 1e3) return sign + '$' + (abs/1e3).toFixed(0) + 'K';
    return sign + '$' + abs.toLocaleString('en-US', {minimumFractionDigits:0, maximumFractionDigits:0});
  }
  
  // Helper to format date compactly
  function fmtDateCompact(dateStr) {
    if (!dateStr) return '';
    const rangeMatch = dateStr.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})\s*[-â€“]\s*(\d{1,2})\/(\d{1,2})\/(\d{4})/);
    if (rangeMatch) {
      const m1 = parseInt(rangeMatch[1]), d1 = parseInt(rangeMatch[2]);
      const m2 = parseInt(rangeMatch[4]), d2 = parseInt(rangeMatch[5]);
      const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      if (m1 === m2) return months[m1-1] + ' ' + d1 + 'â€“' + d2;
      return months[m1-1] + ' ' + d1 + 'â€“' + months[m2-1] + ' ' + d2;
    }
    const singleMatch = dateStr.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
    if (singleMatch) {
      const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      return months[parseInt(singleMatch[1])-1] + ' ' + parseInt(singleMatch[2]);
    }
    return dateStr;
  }
  
  // Filter inflows to BTC/WBTC only (exclude USDC/cash)
  const btcInflows = purchData.inflows.filter(inf => {
    const asset = (inf.asset || '').toUpperCase();
    return asset.includes('BTC') || asset.includes('WBTC');
  });
  
  const lpInflows = btcInflows.filter(inf => inf.stakeholder && inf.stakeholder.toLowerCase().includes('lp'));
  const gpInflows = btcInflows.filter(inf => inf.stakeholder && inf.stakeholder.toLowerCase().includes('gp'));
  const otherBtcInflows = btcInflows.filter(inf => inf.stakeholder && !inf.stakeholder.toLowerCase().includes('lp') && !inf.stakeholder.toLowerCase().includes('gp'));
  
  // Build combined rows: inflows (LP first, then GP) + purchases
  const allRows = [];
  
  [...lpInflows, ...gpInflows, ...otherBtcInflows].forEach(inf => {
    const qty = parseNum(inf.qty) || 0;
    const basis = parseDollar(inf.basis) || 0;
    const val = parseDollar(inf.value) || 0;
    const totalCost = qty * basis;
    const currentVal = qty * btcPrice;
    const pnl = currentVal - (totalCost || val);
    allRows.push({
      name: inf.stakeholder + ' Contribution',
      date: fmtDateCompact(inf.date),
      asset: inf.asset || 'BTC',
      qty: qty,
      avgCost: basis,
      totalCost: totalCost || val,
      currentValue: currentVal,
      pnl: pnl,
      isTranche: false
    });
  });
  
  // Clean up tranche descriptions and add purchases
  let twapCount = 0;
  purchData.purchases.forEach(p => {
    const qty = p.qty || 0;
    const basis = p.basis || 0;
    const totalCost = qty * basis;
    const currentVal = qty * btcPrice;
    const pnl = currentVal - totalCost;
    const dateStr = p.fillDate || p.orderDate || '';
    const desc = p.description || p.token || '';
    
    // Clean up name formatting
    let cleanName = desc;
    if (desc.toLowerCase().includes('twap')) {
      twapCount++;
      cleanName = 'Tranche ' + twapCount + ' â€“ 7d TWAP';
    } else if (desc.toLowerCase().includes('limit')) {
      cleanName = 'Limit Order â€“ $' + (basis/1000).toFixed(1) + 'K';
    }
    
    allRows.push({
      name: cleanName,
      date: fmtDateCompact(dateStr),
      asset: p.token || 'BTC',
      qty: qty,
      avgCost: basis,
      totalCost: totalCost,
      currentValue: currentVal,
      pnl: pnl,
      isTranche: true
    });
  });
  
  allRows.forEach(r => {
    const tr = document.createElement('tr');
    const pnlColor = r.pnl >= 0 ? '#4ADE80' : '#F87171';
    tr.innerHTML = `<td style="text-align:left;color:#F1F5F9;font-weight:700">${r.name}</td><td style="text-align:left;color:#F1F5F9;font-weight:700">${r.date}</td><td style="text-align:left;color:#F1F5F9;font-weight:700">${r.asset}</td><td style="text-align:right;color:#F7931A;font-family:'JetBrains Mono',monospace;font-weight:700">${fmtNum(r.qty, 2)}</td><td style="text-align:right;color:#F1F5F9;font-weight:700;font-family:'JetBrains Mono',monospace">$${Math.round(r.avgCost).toLocaleString()}</td><td style="text-align:right;color:#F1F5F9;font-weight:700;font-family:'JetBrains Mono',monospace">${fmtSmartDollar(r.totalCost)}</td><td style="text-align:right;color:#F1F5F9;font-weight:700;font-family:'JetBrains Mono',monospace">${fmtSmartDollar(r.currentValue)}</td><td style="text-align:right;color:${pnlColor};font-family:'JetBrains Mono',monospace;font-weight:700">${fmtSmartDollar(r.pnl)}</td>`;
    ptbody.appendChild(tr);
  });
  
  // Update purchase hero cards
  // BTC Holdings - total BTC
  const heroPurchHoldings = document.getElementById('heroPurchHoldings');
  if (heroPurchHoldings) heroPurchHoldings.textContent = fmtNum(dash.btcHoldings || 0, 2) + ' BTC';
  
  // BTC Purchased - sum of tranches only (not contributions)
  const trancheBTC = allRows.filter(r => r.isTranche).reduce((s, r) => s + r.qty, 0);
  const heroTotalBTC = document.getElementById('heroTotalBTCPurch');
  if (heroTotalBTC) heroTotalBTC.textContent = fmtNum(trancheBTC, 2) + ' BTC';
  
  // Weighted Avg Cost
  const heroAvgCostEl = document.getElementById('heroWeightedAvgCost');
  if (heroAvgCostEl) heroAvgCostEl.textContent = '$' + Math.round(avgCost).toLocaleString();
  
  // Unrealized ITD PNL - pull from mwrRows (same as performance tab ITD P&L)
  const itdPnl = dash.mwrRows?.[0]?.itdPnl;
  const heroPNL = document.getElementById('heroUnrealizedPNL');
  if (heroPNL && itdPnl != null) {
    heroPNL.textContent = fmtSmartDollar(itdPnl);
    heroPNL.style.color = itdPnl >= 0 ? '#4ADE80' : '#F87171';
  }
  
  // Cost bars rendering - BTC only (no USDC/cash contributions)
  const costEl = document.getElementById('costBars');
  costEl.innerHTML = '';
  
  const costBarRows = [];
  
  // Add BTC inflows (GP and LP contributions) - already filtered to BTC only
  [...lpInflows, ...gpInflows, ...otherBtcInflows].forEach(inf => {
    const basis = parseDollar(inf.basis) || 0;
    if (!basis) return;
    costBarRows.push({ label: (inf.stakeholder || '') + ' Contribution', basis: basis });
  });
  
  // Add purchases with short labels
  let twapIdx = 0;
  purchData.purchases.forEach((p, i) => {
    if (!p.basis) return;
    const desc = p.description || p.token || '';
    let shortLabel = desc;
    if (desc.toLowerCase().includes('twap')) {
      twapIdx++;
      shortLabel = 'T' + twapIdx + ' â€“ 7d TWAP';
    } else if (desc.toLowerCase().includes('limit')) {
      shortLabel = 'Limit Order â€“ $' + (p.basis/1000).toFixed(1) + 'K';
    }
    costBarRows.push({ label: shortLabel, basis: p.basis });
  });
  
  const allCostBases = costBarRows.map(r => r.basis);
  const maxCost = Math.max(...allCostBases, btcPrice, INCEPTION_BTC_PRICE) * 1.08;
  const btcPricePct = (btcPrice / maxCost) * 100;
  
  // Build cost bars with a shared wrapper for the vertical BTC price line
  const wrapperId = 'costBarsWrapper';
  costEl.innerHTML = '';
  
  // Create the bars container
  let barsHtml = '';
  costBarRows.forEach(r => {
    const width = (r.basis / maxCost) * 100;
    const isAbove = r.basis > btcPrice;
    const pnlPct = btcPrice ? ((btcPrice - r.basis) / r.basis) * 100 : 0;
    const pnlColor = pnlPct >= 0 ? '#4ADE80' : '#F87171';
    const pnlStr = (pnlPct >= 0 ? '+' : '') + pnlPct.toFixed(1) + '%';
    const gradient = isAbove
      ? 'linear-gradient(90deg, #F7931A 0%, #E2761B 60%, rgba(248,113,113,0.7) 100%)'
      : 'linear-gradient(90deg, #F7931A 0%, #E2761B 40%, rgba(74,222,128,0.7) 100%)';
    const costLabel = '$' + (r.basis/1000).toFixed(1) + 'K';
    barsHtml += `
      <div class="cb-row">
        <div class="cb-lbl">${r.label}</div>
        <div class="cb-track" style="position:relative">
          <div class="cb-fill" style="width:${width}%;background:${gradient}">
            ${costLabel}
          </div>
        </div>
        <div class="cb-pnl" style="color:${pnlColor}">${pnlStr}</div>
      </div>`;
  });
  
  costEl.innerHTML = barsHtml;
  
  // Now add the single vertical purple dashed line inside each cb-track at the correct position
  // This ensures proper alignment regardless of layout
  costEl.querySelectorAll('.cb-track').forEach(track => {
    const line = document.createElement('div');
    line.style.cssText = `position:absolute;top:0;bottom:0;left:${btcPricePct}%;width:0;border-left:2px dashed #8B5CF6;z-index:3;pointer-events:none`;
    track.appendChild(line);
  });
  
  // Update legend with current BTC price
  const legendEl = document.getElementById('costBasisBtcPriceLegend');
  if (legendEl) legendEl.textContent = 'Current BTC Price ($' + (btcPrice/1000).toFixed(1) + 'K)';
}

function renderCommentary(dash, perf) {
  const alpha = perf?.itdAlpha ?? dash.itdAlpha;
  const alphaStr = alpha ? '+' + (alpha * 100).toFixed(2) + '%' : '?';
  const avgCost = fmtDollar(dash.btcAvgCost);
  const inceptionPrice = '$90,287';
  const avgPurchPrice = parseDollar(dash.btcAvgPurchasePrice) || 85737;
  const avgPurchStr = fmtDollar(avgPurchPrice);
  const purchDelta = Math.abs(avgPurchPrice - 90287);
  const purchDeltaStr = fmtDollar(purchDelta);
  const purchBelow = avgPurchPrice < 90287;
  
  const text = `The fund has consistently outperformed a passive BTC hold by <span class="hl-g">${alphaStr}</span> ITD through disciplined TWAP execution and opportunistic limit orders during drawdowns. Key alpha drivers: deploying capital via 7-day TWAPs to smooth entry prices, and aggressive limit buys during the Feb sell-off (entries at <span class="hl-o">$78.5K</span> and <span class="hl-o">$63.1K</span> vs inception at <span class="hl-o">${inceptionPrice}</span>), lowering the blended cost basis from <span class="hl-o">${inceptionPrice}</span> to <span class="hl-o">${avgCost}</span>.<br><br>Our current BTC average purchase price of <span class="hl-o">${avgPurchStr}</span> is <span class="hl-g">${purchDeltaStr}</span> ${purchBelow ? 'below' : 'above'} the inception price of <span class="hl-o">${inceptionPrice}</span>.`;
  document.getElementById('commentary').innerHTML = text;
  const c2 = document.getElementById('commentary2');
  if (c2) c2.innerHTML = text;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHART RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const chartTooltip = {
  backgroundColor: 'rgba(15,23,42,0.95)',
  titleColor: '#F1F5F9', bodyColor: '#CBD5E1',
  borderColor: 'rgba(148,163,184,0.15)', borderWidth: 1, padding: 14,
  titleFont: { family: "'JetBrains Mono', monospace", size: 13, weight: 'bold' },
  bodyFont: { family: "'JetBrains Mono', monospace", size: 12 },
};
const axisFont = { family: "'JetBrains Mono', monospace", size: 10 };

function formatDateLabel(dateStr) {
  if (!dateStr) return '';
  const d = new Date(dateStr);
  if (isNaN(d)) return dateStr;
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function buildChartData(returnsDaily) {
  const labels = [], fundData = [], btcTWRData = [], btcPriceData = [], alphaPosData = [], alphaNegData = [];
  
  for (const d of returnsDaily) {
    const label = formatDateLabel(d.date);
    labels.push(label);
    const fund = d.cumTWR != null ? d.cumTWR : null;
    fundData.push(fund);
    
    // BTC Cumulative TWR directly from CSV column R
    const btcTWR = d.btcCumTWR != null ? d.btcCumTWR : null;
    btcTWRData.push(btcTWR);
    btcPriceData.push(d.btcPrice);
    
    // Alpha spread directly from CSV column J
    const alpha = d.alphaSpread != null ? d.alphaSpread : null;
    alphaPosData.push(alpha != null && alpha >= 0 ? alpha : 0);
    alphaNegData.push(alpha != null && alpha < 0 ? alpha : 0);
  }
  console.log('[buildChartData] All from CSV - Fund TWR:', fundData.slice(-3), 'BTC TWR:', btcTWRData.slice(-3), 'Alpha:', alphaPosData.slice(-3), alphaNegData.slice(-3));
  return { labels, fundData, btcTWRData, btcPriceData, alphaPosData, alphaNegData };
}

function makeAnnotations(labels, yMax) {
  const a = {};
  DECISIONS.forEach((dec, i) => {
    const idx = labels.findIndex(l => l === dec.date);
    if (idx === -1) return;
    const isOpp = dec.type === 'opportunistic';
    // Vertical dashed line with label at top
    a['line'+i] = { 
      type:'line', xMin:idx, xMax:idx, 
      borderColor: isOpp ? 'rgba(96,165,250,0.5)' : 'rgba(74,222,128,0.4)', 
      borderWidth:1.5, borderDash:[3,3],
      yScaleID: 'y',
      label: {
        display: true,
        content: dec.label,
        position: 'end',
        color: isOpp ? '#60A5FA' : '#4ADE80',
        font: { size: 9, weight: 'bold', family: "'JetBrains Mono',monospace" },
        backgroundColor: 'transparent',
        padding: 0,
        yAdjust: -14
      }
    };
  });
  return a;
}

function makeTWRChart(canvasId, returnsDaily, chartKey) {
  const ctx = document.getElementById(canvasId)?.getContext('2d');
  if (!ctx) return;
  if (charts[chartKey]) charts[chartKey].destroy();
  const { labels, fundData, btcTWRData, btcPriceData, alphaPosData, alphaNegData } = buildChartData(returnsDaily);
  
  // Build decision lookup by index
  const decisionMap = {};
  DECISIONS.forEach(d => {
    const idx = labels.findIndex(l => l === d.date);
    if (idx >= 0) decisionMap[idx] = d;
  });
  
  // Create gradient for fund area fill
  const gradFund = ctx.createLinearGradient(0, 0, 0, ctx.canvas.height);
  gradFund.addColorStop(0, 'rgba(59,130,246,0.15)');
  gradFund.addColorStop(1, 'rgba(59,130,246,0)');
  
  // Green gradient for positive alpha bars â€” bright and visible
  const gradGreen = ctx.createLinearGradient(0, ctx.canvas.height * 0.45, 0, 0);
  gradGreen.addColorStop(0, 'rgba(74,222,128,0.5)');
  gradGreen.addColorStop(0.3, 'rgba(74,222,128,0.85)');
  gradGreen.addColorStop(1, 'rgba(74,222,128,1.0)');
  
  // Red gradient for negative alpha bars
  const gradRed = ctx.createLinearGradient(0, ctx.canvas.height * 0.55, 0, ctx.canvas.height);
  gradRed.addColorStop(0, 'rgba(248,113,113,0.5)');
  gradRed.addColorStop(0.3, 'rgba(248,113,113,0.85)');
  gradRed.addColorStop(1, 'rgba(248,113,113,1.0)');
  
  // Compute Y range for autoscaling with 5 ticks
  const allYVals = [...fundData, ...btcTWRData, ...alphaPosData, ...alphaNegData].filter(v => v != null);
  const yMax = allYVals.length > 0 ? Math.max(...allYVals) : 10;
  const yMin = allYVals.length > 0 ? Math.min(...allYVals) : -30;
  const yMaxPadded = Math.ceil(yMax / 5) * 5 + 5; // round up + headroom for labels
  const yMinPadded = Math.floor(yMin / 5) * 5;
  const yStep = Math.round((yMaxPadded - yMinPadded) / 4);
  
  // Only keep TWAP/Limit decision annotations (no vertical grid lines)
  const annotations = {};
  DECISIONS.forEach((dec, i) => {
    const idx = labels.findIndex(l => l === dec.date);
    if (idx === -1) return;
    const isOpp = dec.type === 'opportunistic';
    annotations['line'+i] = { 
      type:'line', xMin:idx, xMax:idx, 
      borderColor: isOpp ? 'rgba(96,165,250,0.5)' : 'rgba(74,222,128,0.4)', 
      borderWidth:1.5, borderDash:[3,3],
      yScaleID: 'y',
      label: {
        display: true, content: dec.label, position: 'end',
        color: isOpp ? '#60A5FA' : '#4ADE80',
        font: { size: 9, weight: 'bold', family: "'JetBrains Mono',monospace" },
        backgroundColor: 'transparent', padding: 0, yAdjust: -14
      }
    };
  });
  
  // 3 horizontal lines: top, 0%, bottom
  annotations['hLineTop'] = {
    type:'line', yMin: yMaxPadded, yMax: yMaxPadded, yScaleID:'y',
    borderColor:'rgba(148,163,184,0.15)', borderWidth:1
  };
  annotations['hLineZero'] = {
    type:'line', yMin: 0, yMax: 0, yScaleID:'y',
    borderColor:'rgba(148,163,184,0.25)', borderWidth:1
  };
  annotations['hLineBottom'] = {
    type:'line', yMin: yMinPadded, yMax: yMinPadded, yScaleID:'y',
    borderColor:'rgba(148,163,184,0.15)', borderWidth:1
  };
  
  charts[chartKey] = new Chart(ctx, {
    data: {
      labels,
      datasets: [
        // Alpha positive bars â€” thick, green gradient
        { type:'bar', label:'Alpha+', data:alphaPosData, 
          backgroundColor: gradGreen,
          borderWidth:0, barPercentage:0.92, categoryPercentage:1.0,
          borderRadius: { topLeft:2, topRight:2 },
          yAxisID:'y', order:4, grouped:false },
        // Alpha negative bars â€” thick, red gradient
        { type:'bar', label:'Alpha-', data:alphaNegData, 
          backgroundColor: gradRed,
          borderWidth:0, barPercentage:0.92, categoryPercentage:1.0,
          borderRadius: { bottomLeft:2, bottomRight:2 },
          yAxisID:'y', order:4, grouped:false },
        // Fund TWR â€” blue area + line
        { type:'line', label:'Fund TWR', data:fundData, 
          borderColor:'#3B82F6', borderWidth:2.5, 
          backgroundColor: gradFund, fill: true,
          tension:0.3, pointRadius:0, pointHoverRadius:5, 
          pointHoverBackgroundColor:'#3B82F6', pointHoverBorderColor:'#fff', pointHoverBorderWidth:2,
          yAxisID:'y', order:1 },
        // BTC TWR â€” orange dashed
        { type:'line', label:'BTC TWR', data:btcTWRData, 
          borderColor:'#F7931A', borderWidth:2, borderDash:[6,3], 
          fill:false, tension:0.3, pointRadius:0, pointHoverRadius:5,
          pointHoverBackgroundColor:'#F7931A', pointHoverBorderColor:'#fff', pointHoverBorderWidth:2,
          yAxisID:'y', order:2 },
        // BTC Price â€” purple thin, right axis
        { type:'line', label:'BTC Price', data:btcPriceData, 
          borderColor:'rgba(139,92,246,0.7)', borderWidth:1.5, 
          fill:false, tension:0.3, pointRadius:0, pointHoverRadius:4,
          pointHoverBackgroundColor:'#8B5CF6',
          yAxisID:'y1', order:3 }
      ]
    },
    options: {
      responsive:true, maintainAspectRatio:false,
      layout:{ padding:{ top:35 } },
      interaction:{ mode:'index', intersect:false },
      plugins:{
        legend:{ display:false },
        annotation:{ annotations },
        tooltip:{
          enabled: false,
          external: function(context) {
            let el = document.getElementById('chartTooltip-' + chartKey);
            if (!el) {
              el = document.createElement('div');
              el.id = 'chartTooltip-' + chartKey;
              el.style.cssText = 'position:absolute;pointer-events:none;z-index:50;transition:opacity 0.15s;';
              document.body.appendChild(el);
            }
            const tooltip = context.tooltip;
            if (tooltip.opacity === 0) { el.style.opacity = '0'; return; }
            
            const items = tooltip.dataPoints || [];
            const fundItem = items.find(i => i.dataset.label === 'Fund TWR');
            const btcItem = items.find(i => i.dataset.label === 'BTC TWR');
            const priceItem = items.find(i => i.dataset.label === 'BTC Price');
            const dateLabel = tooltip.title?.[0] || '';
            const idx = tooltip.dataPoints?.[0]?.dataIndex;
            const dec = decisionMap[idx];
            
            const fundVal = fundItem?.raw;
            const btcVal = btcItem?.raw;
            const priceVal = priceItem?.raw;
            const alpha = (fundVal != null && btcVal != null) ? fundVal - btcVal : null;
            
            const fmtP = v => v == null ? 'â€”' : (v >= 0 ? '+' : '') + v.toFixed(2) + '%';
            const fmtD = v => v == null ? 'â€”' : '$' + v.toLocaleString(undefined,{maximumFractionDigits:0});
            
            let html = '<div style="background:rgba(15,23,42,0.95);border:1px solid rgba(148,163,184,0.2);border-radius:10px;padding:12px 16px;min-width:220px;font-family:\'JetBrains Mono\',monospace;font-size:12px">';
            html += '<div style="color:#F1F5F9;font-weight:700;margin-bottom:8px;font-size:14px">' + dateLabel + '</div>';
            
            const rows = [
              { color:'#3B82F6', label:'Fund TWR', val: fmtP(fundVal) },
              { color:'#F7931A', label:'BTC TWR', val: fmtP(btcVal) },
              { color:'#8B5CF6', label:'BTC Price', val: fmtD(priceVal) },
            ];
            rows.forEach(r => {
              html += '<div style="display:flex;justify-content:space-between;margin-bottom:4px">';
              html += '<span style="color:' + r.color + '">' + r.label + '</span>';
              html += '<span style="color:#F1F5F9;font-weight:600">' + r.val + '</span>';
              html += '</div>';
            });
            
            if (alpha != null) {
              const aC = alpha >= 0 ? '#4ADE80' : '#F87171';
              html += '<div style="display:flex;justify-content:space-between;border-top:1px solid rgba(148,163,184,0.15);padding-top:6px;margin-top:4px">';
              html += '<span style="color:' + aC + ';font-weight:700">Alpha</span>';
              html += '<span style="color:' + aC + ';font-weight:700">' + fmtP(alpha) + '</span>';
              html += '</div>';
            }
            
            if (dec) {
              const isOpp = dec.type === 'opportunistic';
              const bg = isOpp ? 'rgba(96,165,250,0.15)' : 'rgba(74,222,128,0.15)';
              const labelColor = isOpp ? '#60A5FA' : '#4ADE80';
              html += '<div style="margin-top:8px;padding:6px 8px;background:' + bg + ';border-radius:6px;font-size:11px">';
              html += '<div style="color:' + labelColor + ';font-weight:700">ğŸ“Œ ' + dec.label + '</div>';
              html += '<div style="color:#B0BEC5;margin-top:2px">' + dec.desc + '</div>';
              html += '</div>';
            }
            
            html += '</div>';
            el.innerHTML = html;
            el.style.opacity = '1';
            
            const pos = context.chart.canvas.getBoundingClientRect();
            const tooltipWidth = el.offsetWidth || 240;
            let left = pos.left + window.scrollX + tooltip.caretX + 12;
            if (left + tooltipWidth > window.innerWidth - 20) {
              left = pos.left + window.scrollX + tooltip.caretX - tooltipWidth - 12;
            }
            el.style.left = left + 'px';
            el.style.top = (pos.top + window.scrollY + tooltip.caretY - 20) + 'px';
          }
        }
      },
      scales:{
        x:{ grid:{display:false}, ticks:{color:'#F1F5F9', font:{family:"'JetBrains Mono',monospace", size:11}, maxTicksLimit:12}, border:{display:false} },
        y:{ position:'left', min: yMinPadded, max: yMaxPadded, grid:{display:false}, 
          ticks:{color:'#F7931A', font:{family:"'JetBrains Mono',monospace", size:12, weight:'bold'}, 
            maxTicksLimit:5, callback:v=> (v>=0?'+':'')+v+'%' }, border:{display:false} },
        y1:{ position:'right', grid:{display:false}, 
          ticks:{color:'#8B5CF6', font:{family:"'JetBrains Mono',monospace", size:11, weight:'bold'}, 
            maxTicksLimit:5, callback:v=>'$'+(v/1000).toFixed(0)+'K'}, border:{display:false} }
      }
    }
  });
}

function makeDrawdownChart(canvasId, returnsDaily, chartKey) {
  const ctx = document.getElementById(canvasId)?.getContext('2d');
  if (!ctx) return;
  if (charts[chartKey]) charts[chartKey].destroy();
  const labels = [], ddData = [];
  
  // Use MWR for drawdown chart
  for (const d of returnsDaily) {
    labels.push(formatDateLabel(d.date));
    ddData.push(d.mwr != null ? d.mwr : 0);
  }
  
  // Find min/max for y-axis with padding
  const minVal = Math.min(...ddData);
  const maxVal = Math.max(...ddData);
  // Round to nice increments that fit 5 ticks
  const absMin = Math.abs(minVal);
  const step = Math.max(1, Math.ceil(absMin / 4));
  const yMin = -(step * 4) - (minVal < -(step * 4) ? step : 0);
  const yMax = maxVal > 0 ? Math.max(step, Math.ceil(maxVal / step) * step) : step;
  
  // Create two datasets: one for positive (green), one for negative (red)
  // Use segment styling for color changes
  const gradRed = ctx.createLinearGradient(0, 0, 0, ctx.canvas.height);
  gradRed.addColorStop(0, 'rgba(248,113,113,0.02)');
  gradRed.addColorStop(1, 'rgba(248,113,113,0.12)');
  
  // Custom plugin to draw crosshair line on hover
  const crosshairPlugin = {
    id: 'crosshair',
    afterDraw(chart) {
      if (chart.tooltip?._active?.length) {
        const x = chart.tooltip._active[0].element.x;
        const yAxis = chart.scales.y;
        const ctx2 = chart.ctx;
        ctx2.save();
        ctx2.beginPath();
        ctx2.setLineDash([4, 4]);
        ctx2.strokeStyle = 'rgba(241,245,249,0.3)';
        ctx2.lineWidth = 1;
        ctx2.moveTo(x, yAxis.top);
        ctx2.lineTo(x, yAxis.bottom);
        ctx2.stroke();
        ctx2.restore();
      }
    }
  };
  
  charts[chartKey] = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets: [{
      label: 'Drawdown',
      data: ddData,
      borderWidth: 2,
      fill: { target: 'origin', below: gradRed, above: 'rgba(74,222,128,0.05)' },
      tension: 0.3,
      pointRadius: 0,
      pointHoverRadius: 6,
      pointHoverBackgroundColor: '#F1F5F9',
      pointHoverBorderColor: '#F87171',
      pointHoverBorderWidth: 2,
      segment: {
        borderColor: ctx2 => {
          const v = ctx2.p1.parsed.y;
          return v >= 0 ? '#4ADE80' : '#F87171';
        }
      }
    }] },
    plugins: [crosshairPlugin],
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: {
          enabled: false,
          external: function(context) {
            let tooltipEl = document.getElementById('dd-tooltip');
            if (!tooltipEl) {
              tooltipEl = document.createElement('div');
              tooltipEl.id = 'dd-tooltip';
              tooltipEl.style.cssText = 'position:absolute;background:rgba(15,23,42,0.95);border:1px solid rgba(148,163,184,0.2);border-radius:8px;padding:10px 14px;pointer-events:none;font-family:"JetBrains Mono",monospace;z-index:100;transition:opacity 0.15s';
              document.body.appendChild(tooltipEl);
            }
            const tooltip = context.tooltip;
            if (tooltip.opacity === 0) { tooltipEl.style.opacity = '0'; return; }
            const item = tooltip.dataPoints?.[0];
            if (item) {
              const val = item.raw;
              const valColor = val >= 0 ? '#4ADE80' : '#F87171';
              tooltipEl.innerHTML = `<div style="color:#94A3B8;font-size:11px;margin-bottom:4px">${item.label}</div><div><span style="color:#F1F5F9;font-size:13px;font-weight:700">Drawdown: </span><span style="color:${valColor};font-size:13px;font-weight:700">${val.toFixed(2)}%</span></div>`;
            }
            const pos = context.chart.canvas.getBoundingClientRect();
            tooltipEl.style.opacity = '1';
            tooltipEl.style.left = pos.left + window.scrollX + tooltip.caretX + 'px';
            tooltipEl.style.top = pos.top + window.scrollY + tooltip.caretY - 60 + 'px';
          }
        }
      },
      scales: {
        x: { grid: { color: 'rgba(148,163,184,0.05)' }, ticks: { color: '#F1F5F9', font: { ...axisFont, weight: 'bold' }, autoSkip: true, autoSkipPadding: 0, maxRotation: 0, callback: function(val, index) { return index % 7 === 0 ? this.getLabelForValue(val) : null; } } },
        y: {
          grid: { color: 'rgba(148,163,184,0.05)' },
          ticks: { color: '#F1F5F9', font: { ...axisFont, weight: 'bold' }, callback: v => Math.round(v) + '%',
            stepSize: step
          },
          max: yMax, min: yMin,
          beginAtZero: false
        }
      }
    }
  });
}

function renderHoldingsChart(returnsDaily, dash) {
  const ctx = document.getElementById('holdingsChart')?.getContext('2d');
  if (!ctx) return;
  if (charts.holdings) charts.holdings.destroy();
  const labels = [], avgCostData = [], priceData = [], holdingsData = [];
  
  for (const d of returnsDaily) {
    labels.push(formatDateLabel(d.date));
    const avgCost = (d.btcInvested && d.btcHoldings && d.btcHoldings > 0) ? d.btcInvested / d.btcHoldings : null;
    avgCostData.push(avgCost);
    priceData.push(d.btcPrice);
    holdingsData.push(d.btcHoldings);
  }
  
  // Purple fill gradient for holdings area
  const gradHoldings = ctx.createLinearGradient(0, 0, 0, ctx.canvas.height);
  gradHoldings.addColorStop(0, 'rgba(139,92,246,0.12)');
  gradHoldings.addColorStop(1, 'rgba(139,92,246,0.01)');
  
  // Decision annotations for this chart
  const annotations = {};
  DECISIONS.forEach((dec, i) => {
    const idx = labels.findIndex(l => l === dec.date);
    if (idx === -1) return;
    const isOpp = dec.type === 'opportunistic';
    annotations['line'+i] = { 
      type:'line', xMin:idx, xMax:idx, 
      borderColor: isOpp ? 'rgba(96,165,250,0.5)' : 'rgba(74,222,128,0.4)', 
      borderWidth:1.5, borderDash:[3,3],
      yScaleID: 'y',
      label: {
        display: true, content: dec.label, position: 'end',
        color: isOpp ? '#60A5FA' : '#4ADE80',
        font: { size: 9, weight: 'bold', family: "'JetBrains Mono',monospace" },
        backgroundColor: 'transparent', padding: 0, yAdjust: -14
      }
    };
  });
  
  charts.holdings = new Chart(ctx, {
    data: {
      labels,
      datasets: [
        // Holdings â€” purple stepped area (right axis)
        { type:'line', label:'Holdings', data:holdingsData, 
          borderColor:'#8B5CF6', borderWidth:2, backgroundColor: gradHoldings, fill: true,
          stepped: 'before', pointRadius:0, pointHoverRadius:5, 
          pointHoverBackgroundColor:'#8B5CF6', pointHoverBorderColor:'#fff', pointHoverBorderWidth:2,
          yAxisID:'y1', order:2 },
        // BTC Price â€” orange smooth line (left axis)
        { type:'line', label:'BTC Price', data:priceData, 
          borderColor:'#F7931A', borderWidth:2, fill:false, tension:0.3,
          pointRadius:0, pointHoverRadius:5, 
          pointHoverBackgroundColor:'#F7931A', pointHoverBorderColor:'#fff', pointHoverBorderWidth:2,
          yAxisID:'y', order:1 },
        // Avg Cost â€” red dashed stepped line (left axis)
        { type:'line', label:'Avg Cost', data:avgCostData, 
          borderColor:'#EF4444', borderWidth:1.5, borderDash:[6,3], fill:false,
          stepped: 'before', pointRadius:0, pointHoverRadius:5,
          pointHoverBackgroundColor:'#EF4444', pointHoverBorderColor:'#fff', pointHoverBorderWidth:2,
          yAxisID:'y', order:1 }
      ]
    },
    options: {
      responsive:true, maintainAspectRatio:false,
      layout:{ padding:{ top:30, right:10 } },
      interaction:{ mode:'index', intersect:false },
      plugins:{
        legend:{ display:false },
        annotation:{ annotations },
        tooltip:{
          enabled: false,
          external: function(context) {
            let el = document.getElementById('chartTooltip-accum');
            if (!el) {
              el = document.createElement('div');
              el.id = 'chartTooltip-accum';
              el.style.cssText = 'position:absolute;pointer-events:none;z-index:50;transition:opacity 0.15s;';
              document.body.appendChild(el);
            }
            const tooltip = context.tooltip;
            if (tooltip.opacity === 0) { el.style.opacity = '0'; return; }
            const dateLabel = tooltip.title?.[0] || '';
            const items = tooltip.dataPoints || [];
            const avgItem = items.find(i => i.dataset.label === 'Avg Cost');
            const priceItem = items.find(i => i.dataset.label === 'BTC Price');
            const holdItem = items.find(i => i.dataset.label === 'Holdings');
            
            // Check for decision at this date
            const decMatch = DECISIONS.find(d => d.date === dateLabel);
            
            let html = '<div style="background:rgba(15,23,42,0.95);border:1px solid rgba(148,163,184,0.2);border-radius:10px;padding:12px 16px;min-width:210px;font-family:\'JetBrains Mono\',monospace;font-size:12px">';
            html += '<div style="color:#F1F5F9;font-weight:700;margin-bottom:8px;font-size:14px">' + dateLabel + '</div>';
            if (avgItem?.raw != null) html += '<div style="display:flex;justify-content:space-between;gap:20px;margin-bottom:4px"><span style="color:#EF4444">Avg Cost</span><span style="color:#F1F5F9;font-weight:600">$' + Math.round(avgItem.raw).toLocaleString() + '</span></div>';
            if (priceItem?.raw != null) html += '<div style="display:flex;justify-content:space-between;gap:20px;margin-bottom:4px"><span style="color:#F1F5F9">BTC Price</span><span style="color:#F1F5F9;font-weight:600">$' + Math.round(priceItem.raw).toLocaleString() + '</span></div>';
            if (holdItem?.raw != null) html += '<div style="display:flex;justify-content:space-between;gap:20px"><span style="color:#8B5CF6">Holdings</span><span style="color:#F1F5F9;font-weight:600">' + holdItem.raw.toFixed(2) + ' BTC</span></div>';
            
            // Decision callout
            if (decMatch) {
              const isOpp = decMatch.type === 'opportunistic';
              const dcColor = isOpp ? '#60A5FA' : '#4ADE80';
              const dcBg = isOpp ? 'rgba(96,165,250,0.15)' : 'rgba(74,222,128,0.15)';
              html += '<div style="margin-top:8px;padding:8px 10px;border-radius:6px;background:' + dcBg + ';border:1px solid ' + dcColor + '30">';
              html += '<div style="font-size:11px"><span style="margin-right:4px">ğŸ“Œ</span><span style="color:' + dcColor + ';font-weight:700">' + decMatch.label + '</span></div>';
              html += '<div style="font-size:10px;color:#94A3B8;margin-top:2px">' + decMatch.desc + '</div>';
              html += '</div>';
            }
            
            html += '</div>';
            el.innerHTML = html;
            el.style.opacity = '1';
            const pos = context.chart.canvas.getBoundingClientRect();
            const tooltipWidth = el.offsetWidth || 250;
            let left = pos.left + window.scrollX + tooltip.caretX + 12;
            if (left + tooltipWidth > window.innerWidth - 20) left = pos.left + window.scrollX + tooltip.caretX - tooltipWidth - 12;
            el.style.top = (pos.top + window.scrollY + tooltip.caretY - 20) + 'px';
            el.style.left = left + 'px';
          }
        }
      },
      scales:{
        x:{ grid:{color:'rgba(148,163,184,0.06)'}, ticks:{color:'#F1F5F9', font:{family:"'JetBrains Mono',monospace",size:11}, maxTicksLimit:16}, border:{display:false} },
        y:{ position:'left', grid:{color:'rgba(148,163,184,0.06)'}, 
          min:55000, max:100000,
          ticks:{color:'#F7931A', font:{family:"'JetBrains Mono',monospace",size:12,weight:'bold'}, 
            stepSize:15000,
            callback:v=>'$'+(v/1000).toFixed(0)+'K'}, border:{display:false} },
        y1:{ position:'right', grid:{display:false}, 
          ticks:{color:'#8B5CF6', font:{family:"'JetBrains Mono',monospace",size:12,weight:'bold'}, callback:v=>v.toFixed(0)+' BTC'}, border:{display:false} }
      }
    }
  });
  
  // 3 Mini Stat Cards
  const statsEl = document.getElementById('accumStats');
  if (statsEl) {
    const lastD = returnsDaily[returnsDaily.length - 1];
    const totalBTC = lastD?.btcHoldings || dash?.btcHoldings || 0;
    const avgCostFinal = dash?.btcAvgCost || 88923;
    const lastPrice = lastD?.btcPrice || dash?.btcPrice || 0;
    const itdPnl = (lastPrice - avgCostFinal) * totalBTC;
    const itdPnlStr = (itdPnl < 0 ? '-' : '') + '$' + (Math.abs(itdPnl) >= 1e6 ? (Math.abs(itdPnl)/1e6).toFixed(2)+'M' : Math.abs(itdPnl).toLocaleString(undefined,{maximumFractionDigits:0}));
    
    const stats = [
      { label: 'TOTAL BTC ACCUMULATED', value: totalBTC.toFixed(2) + ' BTC', color: '#8B5CF6' },
      { label: 'AVG COST BASIS', value: '$' + avgCostFinal.toLocaleString(undefined,{maximumFractionDigits:0}), color: '#EF4444' },
      { label: 'ITD PnL FOR BTC', value: itdPnlStr, color: itdPnl >= 0 ? '#4ADE80' : '#F87171' },
    ];
    statsEl.innerHTML = stats.map(s => `
      <div style="text-align:center">
        <div style="font-size:12px;color:#8896AB;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">${s.label}</div>
        <div style="font-size:18px;font-weight:700;font-family:'JetBrains Mono',monospace;color:${s.color}">${s.value}</div>
      </div>
    `).join('');
  }
}

function renderAlphaSpreadChart(returnsDaily) {
  const ctx = document.getElementById('alphaSpreadChart')?.getContext('2d');
  if (!ctx) return;
  if (charts.alphaSpread) charts.alphaSpread.destroy();
  const labels = [], alphaData = [], btcPriceData = [];
  for (const d of returnsDaily) {
    labels.push(formatDateLabel(d.date));
    const alpha = d.alphaSpread != null ? d.alphaSpread : null;
    alphaData.push(alpha);
    btcPriceData.push(d.btcPrice);
  }
  
  // Bar colors: green for positive, red for negative
  const barColors = alphaData.map(v => v != null && v >= 0 ? 'rgba(74,222,128,0.7)' : 'rgba(248,113,113,0.7)');
  const barBorders = alphaData.map(v => v != null && v >= 0 ? '#4ADE80' : '#F87171');
  
  // Alpha y-axis scaling
  const alphaMin = Math.min(...alphaData.filter(v => v != null));
  const alphaMax = Math.max(...alphaData.filter(v => v != null));
  const alphaAbsMax = Math.max(Math.abs(alphaMin), Math.abs(alphaMax));
  const alphaStep = Math.max(1, Math.ceil(alphaAbsMax / 2));
  const yAlphaMin = -(alphaStep * 2) - (alphaMin < -(alphaStep * 2) ? alphaStep : 0);
  const yAlphaMax = (alphaStep * 2) + (alphaMax > (alphaStep * 2) ? alphaStep : 0);
  
  // BTC price y-axis scaling
  const btcPrices = btcPriceData.filter(v => v != null);
  const btcMin = Math.min(...btcPrices);
  const btcMax = Math.max(...btcPrices, INCEPTION_BTC_PRICE);
  const btcPad = (btcMax - btcMin) * 0.15;
  const yBtcMin = Math.floor((btcMin - btcPad) / 5000) * 5000;
  const yBtcMax = Math.ceil((btcMax + btcPad) / 5000) * 5000;
  
  // Inception price horizontal line (array of same value)
  const inceptionLine = labels.map(() => INCEPTION_BTC_PRICE);
  
  // Decision annotations
  const annotations = {};
  DECISIONS.forEach((dec, i) => {
    const idx = labels.findIndex(l => l === dec.date);
    if (idx === -1) return;
    const color = dec.type === 'opportunistic' ? '#60A5FA' : '#4ADE80';
    annotations['dec' + i] = {
      type: 'line', xMin: idx, xMax: idx, borderColor: color, borderWidth: 1, borderDash: [4, 4]
    };
  });
  
  // Build decision lookup by label index
  const decisionByIdx = {};
  DECISIONS.forEach(dec => {
    const idx = labels.findIndex(l => l === dec.date);
    if (idx !== -1) decisionByIdx[idx] = dec;
  });
  
  // Custom tooltip
  const alphaTooltip = {
    enabled: false,
    external: function(context) {
      let el = document.getElementById('alpha-spread-tooltip');
      if (!el) {
        el = document.createElement('div');
        el.id = 'alpha-spread-tooltip';
        el.style.cssText = 'position:absolute;background:rgba(15,23,42,0.95);border:1px solid rgba(148,163,184,0.2);border-radius:8px;padding:10px 14px;pointer-events:none;font-family:"JetBrains Mono",monospace;z-index:100;transition:opacity 0.15s';
        document.body.appendChild(el);
      }
      const tooltip = context.tooltip;
      if (tooltip.opacity === 0) { el.style.opacity = '0'; return; }
      const items = tooltip.dataPoints || [];
      let alphaVal = null, btcVal = null;
      items.forEach(item => {
        if (item.dataset.label === 'Alpha') alphaVal = item.raw;
        else if (item.dataset.label === 'BTC Price') btcVal = item.raw;
      });
      const dateLabel = items[0]?.label || '';
      const dataIdx = items[0]?.dataIndex;
      const decision = decisionByIdx[dataIdx];
      let html = `<div style="color:#94A3B8;font-size:11px;margin-bottom:6px">${dateLabel}</div>`;
      if (alphaVal != null) {
        const aColor = alphaVal >= 0 ? '#4ADE80' : '#F87171';
        html += `<div style="display:flex;justify-content:space-between;gap:16px"><span style="color:${aColor};font-size:12px">Alpha</span><span style="color:${aColor};font-size:12px;font-weight:700">${alphaVal >= 0 ? '+' : ''}${alphaVal.toFixed(2)}%</span></div>`;
      }
      if (btcVal != null) {
        html += `<div style="display:flex;justify-content:space-between;gap:16px"><span style="color:#8B5CF6;font-size:12px">BTC Price</span><span style="color:#F1F5F9;font-size:12px;font-weight:700">$${btcVal.toLocaleString(undefined, {maximumFractionDigits: 0})}</span></div>`;
      }
      if (decision) {
        const isOpp = decision.type === 'opportunistic';
        const bg = isOpp ? 'rgba(96,165,250,0.15)' : 'rgba(74,222,128,0.15)';
        const labelColor = isOpp ? '#60A5FA' : '#4ADE80';
        html += `<div style="margin-top:8px;padding:6px 8px;background:${bg};border-radius:6px;font-size:11px">`;
        html += `<div style="color:${labelColor};font-weight:700">ğŸ“Œ ${decision.label}</div>`;
        html += `<div style="color:#B0BEC5;margin-top:2px">${decision.desc}</div>`;
        html += `</div>`;
      }
      el.innerHTML = html;
      const pos = context.chart.canvas.getBoundingClientRect();
      el.style.opacity = '1';
      el.style.left = pos.left + window.scrollX + tooltip.caretX + 12 + 'px';
      el.style.top = pos.top + window.scrollY + tooltip.caretY - 40 + 'px';
    }
  };
  
  charts.alphaSpread = new Chart(ctx, {
    data: {
      labels,
      datasets: [
        {
          type: 'bar',
          label: 'Alpha',
          data: alphaData,
          backgroundColor: barColors,
          borderColor: barBorders,
          borderWidth: 1,
          borderRadius: 2,
          yAxisID: 'y',
          order: 2
        },
        {
          type: 'line',
          label: 'BTC Price',
          data: btcPriceData,
          borderColor: '#8B5CF6',
          borderWidth: 2,
          fill: false,
          tension: 0.3,
          pointRadius: 0,
          pointHoverRadius: 5,
          pointHoverBackgroundColor: '#F1F5F9',
          pointHoverBorderColor: '#8B5CF6',
          pointHoverBorderWidth: 2,
          yAxisID: 'y1',
          order: 1
        },
        {
          type: 'line',
          label: 'Inception Price',
          data: inceptionLine,
          borderColor: 'rgba(241,245,249,0.5)',
          borderWidth: 1.5,
          borderDash: [6, 4],
          fill: false,
          pointRadius: 0,
          pointHoverRadius: 0,
          yAxisID: 'y1',
          order: 0
        }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: alphaTooltip,
        annotation: { annotations }
      },
      scales: {
        x: {
          grid: { color: 'rgba(148,163,184,0.06)' },
          ticks: { color: '#F1F5F9', font: { ...axisFont, weight: 'bold' }, autoSkip: true, autoSkipPadding: 0, maxRotation: 0, callback: function(val, index) { return index % 7 === 0 ? this.getLabelForValue(val) : null; } }
        },
        y: {
          position: 'left',
          grid: { color: 'rgba(148,163,184,0.06)' },
          ticks: {
            color: function(context) { return context.tick.value === 0 ? '#F1F5F9' : context.tick.value > 0 ? '#4ADE80' : '#F87171'; },
            font: { ...axisFont, weight: 'bold' },
            callback: v => Math.round(v) + '%',
            count: 5
          },
          min: yAlphaMin, max: yAlphaMax
        },
        y1: {
          position: 'right',
          grid: { display: false },
          ticks: { color: '#8B5CF6', font: { ...axisFont, weight: 'bold' }, callback: v => '$' + (v / 1000).toFixed(0) + 'K', count: 5 },
          min: yBtcMin, max: yBtcMax
        }
      }
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('tabBar').addEventListener('click', e => {
  const btn = e.target.closest('button');
  if (!btn || !btn.dataset.tab) return;
  document.querySelectorAll('#tabBar button').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.getElementById('tab-' + btn.dataset.tab)?.classList.add('active');
  const tab = btn.dataset.tab;
  const isOverview = tab === 'overview';
  const isPerf = tab === 'performance';
  const isAlloc = tab === 'allocation';
  const isPurch = tab === 'tranches';
  const isTwitter = tab === 'twitter';
  // Hide hero row on Twitter tab
  document.querySelector('.r-hero4').style.display = isTwitter ? 'none' : '';
  // AUM + BTC Holdings show on overview and allocation only
  document.querySelectorAll('.hero-common').forEach(el => el.style.display = (isOverview || isAlloc) ? '' : 'none');
  // BTC Price + Avg Cost show on overview only
  document.querySelectorAll('.hero-default').forEach(el => el.style.display = isOverview ? '' : 'none');
  // BTC Exposure + Cash show on allocation only
  document.querySelectorAll('.hero-alloc').forEach(el => el.style.display = isAlloc ? '' : 'none');
  // Purchase cards show on purchases only
  document.querySelectorAll('.hero-purch').forEach(el => el.style.display = isPurch ? '' : 'none');
  // Performance cards show on performance only
  document.querySelectorAll('.hero-perf').forEach(el => el.style.display = isPerf ? '' : 'none');
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN DATA LOADING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DECISION POINT ANNOTATIONS FOR CHARTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DECISIONS = [
  { date: 'Dec 12', label: 'Deploy', type: 'twap', desc: 'Initial deployment at $90,287' },
  { date: 'Dec 30', label: 'T1', type: 'twap', price: 87814, desc: '7d TWAP buy at $87,814 â€” 2.7% below inception' },
  { date: 'Jan 7', label: 'T2', type: 'twap', price: 94685, desc: '7d TWAP buy at $94,685' },
  { date: 'Jan 14', label: 'T3+T4', type: 'twap', price: 96483, desc: '7d TWAP buys at ~$96.5K' },
  { date: 'Jan 29', label: 'T5', type: 'twap', price: 101522, desc: '7d TWAP buy at $101,522' },
  { date: 'Feb 1', label: '$78.5K', type: 'opportunistic', price: 78500, desc: 'Limit buy at $78.5K â€” 13.1% below inception' },
  { date: 'Feb 5', label: '$63.1K', type: 'opportunistic', price: 63100, desc: 'Limit buy at $63.1K â€” 30.1% below inception' }
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA VALIDATION & RETRY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function hasLoadingValues(dashRows, perfRows) {
  // Check key cells that commonly show "Loading..."
  const checks = [
    dashRows[4]?.[1],   // AUM
    dashRows[4]?.[4],   // BTC Price
    perfRows[8]?.[2],   // ITD Fund TWR
    perfRows[16]?.[2],  // QTD Fund TWR
    perfRows[22]?.[2],  // Current AUM
  ];
  const loadingCount = checks.filter(v => v && String(v).toLowerCase().includes('loading')).length;
  console.log(`[Validation] ${loadingCount}/${checks.length} cells still show "Loading..."`, checks);
  return loadingCount;
}

async function fetchAllCSV() {
  return Promise.all([
    fetchCSV(TABS.dashboard),
    fetchCSV(TABS.perfSummary),
    fetchCSV(TABS.returnsDaily),
    fetchCSV(TABS.purchases)
  ]);
}

async function fetchWithRetry(maxRetries = 4, delayMs = 4000) {
  let bestData = null;
  let bestLoadingCount = Infinity;
  
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      const [dashRows, perfRows, returnsRows, purchRows] = await fetchAllCSV();
      const loadingCount = hasLoadingValues(dashRows, perfRows);
      
      if (loadingCount === 0) {
        console.log(`[Retry] Attempt ${attempt}: All values resolved!`);
        return { dashRows, perfRows, returnsRows, purchRows };
      }
      
      // Keep the best (fewest Loading...) result
      if (loadingCount < bestLoadingCount) {
        bestLoadingCount = loadingCount;
        bestData = { dashRows, perfRows, returnsRows, purchRows };
      }
      
      if (attempt < maxRetries) {
        console.log(`[Retry] Attempt ${attempt}: ${loadingCount} loading cells, waiting ${delayMs}ms...`);
        await new Promise(r => setTimeout(r, delayMs));
        delayMs += 2000; // increase delay each retry
      }
    } catch (err) {
      console.warn(`[Retry] Attempt ${attempt} failed:`, err.message);
      if (attempt < maxRetries) await new Promise(r => setTimeout(r, 3000));
    }
  }
  
  if (bestData) {
    console.log(`[Retry] Using best result with ${bestLoadingCount} loading cells`);
    return bestData;
  }
  throw new Error('All fetch attempts failed');
}

async function loadAllData() {
  try {
    const { dashRows, perfRows, returnsRows, purchRows } = await fetchWithRetry();
    
    const dash = parseDashboard(dashRows);
    const perf = parsePerfSummary(perfRows);
    const returnsDaily = parseReturnsDaily(returnsRows);
    const purchData = parsePurchases(purchRows);
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CROSS-FILL: Use returnsDaily to fill in any values still NaN/null
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    if (returnsDaily.length > 0) {
      const last = returnsDaily[returnsDaily.length - 1];
      
      // AUM: prefer parsed, fallback to last portfolio value
      if (!dash.aum || isNaN(dash.aum)) {
        dash.aum = last.portfolioValue || perf.currentAUM || null;
      }
      if (!perf.currentAUM || isNaN(perf.currentAUM)) {
        perf.currentAUM = dash.aum;
      }
      
      // BTC Price: prefer parsed, fallback to last day's price or perfSummary
      if (!dash.btcPrice || isNaN(dash.btcPrice)) {
        dash.btcPrice = last.btcPrice || perf.currentBTCPrice || perf.currentBTCPriceKM || null;
      }
      
      // Fund ITD TWR: compute from cumulative daily data
      if (!perf.itdFundTWR || isNaN(perf.itdFundTWR)) {
        perf.itdFundTWR = last.cumTWR != null ? last.cumTWR / 100 : null;
      }
      if (!dash.itdTWRFund || isNaN(dash.itdTWRFund)) {
        dash.itdTWRFund = perf.itdFundTWR;
      }
      
      // Alpha: compute Fund - BTC
      if (perf.itdFundTWR != null && perf.itdBTCTWR != null && (!perf.itdAlpha || isNaN(perf.itdAlpha))) {
        perf.itdAlpha = perf.itdFundTWR - perf.itdBTCTWR;
      }
      if (!dash.itdAlpha || isNaN(dash.itdAlpha)) {
        dash.itdAlpha = perf.itdAlpha;
      }
      
      // QTD: find Jan 1 (or closest) to compute QTD returns
      const q1Start = returnsDaily.find(d => d.date && d.date >= '2025-12-31') || returnsDaily[0];
      const q1Idx = returnsDaily.indexOf(q1Start);
      if (q1Idx >= 0 && q1Idx < returnsDaily.length - 1) {
        // QTD Fund TWR
        if (!perf.qtdFundTWR || isNaN(perf.qtdFundTWR)) {
          const startCum = q1Start.cumTWR || 0;
          const endCum = last.cumTWR || 0;
          perf.qtdFundTWR = ((1 + endCum/100) / (1 + startCum/100) - 1);
        }
        // QTD BTC TWR: use perfSummary hardcoded value
        // (already parsed correctly as -0.2204)
        
        // QTD Alpha
        if (perf.qtdFundTWR != null && perf.qtdBTCTWR != null && (!perf.qtdAlpha || isNaN(perf.qtdAlpha))) {
          perf.qtdAlpha = perf.qtdFundTWR - perf.qtdBTCTWR;
        }
      }
      if (!dash.qtdTWRFund || isNaN(dash.qtdTWRFund)) dash.qtdTWRFund = perf.qtdFundTWR;
      if (!dash.qtdTWRBTC || isNaN(dash.qtdTWRBTC)) dash.qtdTWRBTC = perf.qtdBTCTWR;
      if (!dash.qtdAlpha || isNaN(dash.qtdAlpha)) dash.qtdAlpha = perf.qtdAlpha;
    }
    
    lastGoodData = { dash, perf, returnsDaily, purchData };

    // === DEBUG LOGGING ===
    console.log("FINAL dash:", {aum:dash.aum,btcPrice:dash.btcPrice,btcHoldings:dash.btcHoldings,avgCost:dash.btcAvgCost,itdFund:dash.itdTWRFund,itdBTC:dash.itdTWRBTC,itdAlpha:dash.itdAlpha,qtdFund:dash.qtdTWRFund,qtdBTC:dash.qtdTWRBTC,qtdAlpha:dash.qtdAlpha});
    console.log("FINAL perf:", {currentAUM:perf.currentAUM,itdFundTWR:perf.itdFundTWR,itdBTCTWR:perf.itdBTCTWR,itdAlpha:perf.itdAlpha,qtdFundTWR:perf.qtdFundTWR,qtdBTCTWR:perf.qtdBTCTWR,qtdAlpha:perf.qtdAlpha});
    console.log("RETURNS DAILY ROW2 (asset groups) ALL COLS:", JSON.stringify(returnsRows[1]));
    console.log("RETURNS DAILY ROW3 (column headers) ALL COLS:", JSON.stringify(returnsRows[2]));
    console.log("RETURNS DAILY ROW4 (first data) ALL COLS:", JSON.stringify(returnsRows[3]));
    console.log("RETURNS DAILY ROW5 (second data) ALL COLS:", JSON.stringify(returnsRows[4]));
    console.log("RETURNS DAILY:", {length:returnsDaily.length, first:returnsDaily[0], last:returnsDaily[returnsDaily.length-1]});
    // === END DEBUG ===
    
    renderHero(dash, perf, returnsDaily);
    renderITDQTD(dash, perf, returnsDaily);
    renderKeyMetrics(dash, perf, purchData);
    renderTWRSummary(dash, perf);
    renderMWR(dash);
    renderBTCTWR(dash);
    renderPerfSummary(dash);
    renderAllocation(dash);
    renderVenues(dash);
    renderAssetPieChart(dash);
    renderVenueBreakdown(dash);
    renderVenueBreakdown(dash, 'venueBreakdownAlloc');
    renderPurchases(purchData, dash);
    renderCommentary(dash, perf);
    renderDrawdownStats(returnsDaily);
    renderPerfHero(dash, perf, returnsDaily);
    
    // Charts
    makeTWRChart('twrChart', returnsDaily, 'twr');
    makeTWRChart('twrChart2', returnsDaily, 'twr2');
    makeDrawdownChart('drawdownChart2', returnsDaily, 'dd2');
    renderHoldingsChart(returnsDaily, dash);
    renderAlphaSpreadChart(returnsDaily);
    
    const now = new Date();
    const timeStr = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', second: '2-digit', hour12: true });
    // Format date from sheet (e.g. "2/11/2026") to "February 11, 2026"
    const rawDate = dash.todayDate || perf.currentDate || '';
    let formattedDate = rawDate;
    const dateParts = rawDate.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
    if (dateParts) {
      const dt = new Date(parseInt(dateParts[3]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]));
      formattedDate = dt.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
    }
    const hd = document.getElementById('headerDate');
    if (hd) hd.textContent = formattedDate + ' - Updated ' + timeStr;
    
    document.getElementById('errorBanner').style.display = 'none';
    
  } catch (err) {
    console.error('Data fetch error:', err);
    const banner = document.getElementById('errorBanner');
    banner.textContent = `âš  Data refresh failed: ${err.message}. Showing last good data. Retrying in 60sâ€¦`;
    banner.style.display = 'block';
    if (!lastGoodData) {
      const hd2 = document.getElementById('headerDate');
      if (hd2) hd2.textContent = 'Failed to load â€” retryingâ€¦';
    }
  }
  
  document.getElementById('loadingOverlay')?.classList.add('hidden');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT & AUTO-REFRESH (synced to top of each minute)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init() {
  console.log('[init] Starting...');
  try {
    await loadAllData();
    console.log('[init] Initial load complete');
  } catch(e) {
    console.error('[init] Initial load failed:', e);
  }
  
  document.getElementById('loadingOverlay')?.classList.add('hidden');

  // Sheet refreshes every 5 min at :30s mark (e.g. :04:30, :09:30, :14:30, ...)
  // Dashboard fetches 90s later at :00s mark (e.g. :06:00, :11:00, :16:00, ...)
  function secsUntilNextFetch() {
    var now = new Date();
    var min = now.getMinutes();
    var sec = now.getSeconds();
    var totalSec = min * 60 + sec;
    var targets = [];
    for (var n = 0; n < 12; n++) targets.push((5 * n + 1) * 60);
    var wait = null;
    for (var i = 0; i < targets.length; i++) {
      if (targets[i] > totalSec) { wait = targets[i] - totalSec; break; }
    }
    if (wait === null) wait = (3600 - totalSec) + targets[0];
    return Math.max(wait, 10);
  }
  
  function fmtCountdown(s) {
    if (s >= 60) return Math.floor(s/60) + 'm ' + (s%60) + 's';
    return s + 's';
  }

  function scheduleNext() {
    var remaining = secsUntilNextFetch();
    var cd = document.getElementById('countdown');
    var pill = document.getElementById('livePill');
    console.log('[timer] Next fetch in', remaining, 'seconds');
    if (cd) cd.textContent = fmtCountdown(remaining);
    var tick = setInterval(function() {
      remaining--;
      if (remaining <= 0) {
        clearInterval(tick);
        if (cd) cd.textContent = 'â€¦';
        if (pill) pill.style.borderColor = 'rgba(34,197,94,0.5)';
        loadAllData().then(function() {
          if (pill) pill.style.borderColor = 'rgba(34,197,94,0.2)';
          scheduleNext();
        }).catch(function(e) {
          console.error('[timer] Refresh failed:', e);
          if (pill) pill.style.borderColor = 'rgba(248,113,113,0.3)';
          scheduleNext();
        });
      } else {
        if (cd) cd.textContent = fmtCountdown(remaining);
      }
    }, 1000);
  }
  scheduleNext();
}

init();
</script>
</body></html>
