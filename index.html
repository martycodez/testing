<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=5.0">
<title>Clover Capital â€” Portfolio Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;0,9..40,800;1,9..40,400&family=JetBrains+Mono:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/3.0.1/chartjs-plugin-annotation.min.js"></script>
<style>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CLOVER CAPITAL â€” DESIGN SYSTEM CSS
   Matches clover-design-system.jsx tokens exactly
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* === RESET === */
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
html{-webkit-text-size-adjust:100%;scroll-behavior:smooth;overflow-x:hidden}
body{background:#0B1120;overflow-x:hidden;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
  font-family:'DM Sans',sans-serif;color:#F1F5F9;min-height:100vh;
  background:linear-gradient(135deg,#0B1120 0%,#0F172A 40%,#111827 100%)}

/* === SCROLLBARS === */
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:#334155;border-radius:4px}
::-webkit-scrollbar-thumb:hover{background:#475569}
.r-tabs::-webkit-scrollbar{display:none}

/* === INTERACTIONS === */
button{-webkit-tap-highlight-color:transparent;cursor:pointer;transition:all .2s ease}
button:active{transform:scale(0.97)}

/* === PAGE SHELL === */
.page-shell{position:relative;z-index:1;max-width:1280px;margin:0 auto;padding:24px 20px}
.orb-orange{position:fixed;top:-200px;right:-200px;width:500px;height:500px;background:radial-gradient(circle,rgba(247,147,26,0.06) 0%,transparent 70%);pointer-events:none;z-index:0}
.orb-blue{position:fixed;bottom:-200px;left:-100px;width:600px;height:600px;background:radial-gradient(circle,rgba(59,130,246,0.04) 0%,transparent 70%);pointer-events:none;z-index:0}

/* === ERROR BANNER === */
.error-banner{display:none;background:rgba(239,68,68,0.12);border:1px solid rgba(239,68,68,0.25);color:#FCA5A5;padding:10px 20px;border-radius:10px;font-size:12px;font-family:'JetBrains Mono',monospace;margin-bottom:16px}

/* === LOADING OVERLAY === */
.loading-overlay{position:fixed;inset:0;background:#0B1120;display:flex;align-items:center;justify-content:center;z-index:999;transition:opacity .5s}
.loading-overlay.hidden{opacity:0;pointer-events:none}

/* === CARD (glassmorphic) === */
.r-card{background:rgba(15,23,42,0.65);backdrop-filter:blur(20px);border:1px solid rgba(148,163,184,0.1);border-radius:16px;padding:24px;margin-bottom:14px}

/* === HEADER === */
.r-header{margin-bottom:28px;display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:16px}
.header-left{display:flex;flex-direction:column;gap:4px}
.header-brand{display:flex;align-items:center;gap:12px;margin-bottom:4px}
.header-logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#22C55E,#15803D);display:flex;align-items:center;justify-content:center;box-shadow:0 4px 20px rgba(34,197,94,0.3);font-size:18px}
.header-title{margin:0;font-size:22px;font-weight:700;font-family:'Playfair Display',serif;background:linear-gradient(135deg,#F1F5F9,#94A3B8);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.header-date{margin:0;color:#F1F5F9;font-size:13px}
.header-right{display:flex;flex-direction:column;align-items:flex-end;gap:12px}

/* === LIVE PILL === */
.live-pill{display:flex;align-items:center;gap:8px;background:rgba(34,197,94,0.08);border:1px solid rgba(34,197,94,0.2);border-radius:20px;padding:5px 14px 5px 10px;white-space:nowrap}
.live-dot{width:8px;height:8px;border-radius:50%;background:#4ADE80;box-shadow:0 0 8px rgba(74,222,128,0.6);animation:pulse-dot 2s ease-in-out infinite}
@keyframes pulse-dot{0%,100%{opacity:1;box-shadow:0 0 8px rgba(74,222,128,0.6)}50%{opacity:0.5;box-shadow:0 0 4px rgba(74,222,128,0.3)}}
.live-text{font-size:12px;font-weight:700;color:#4ADE80;font-family:'JetBrains Mono',monospace;letter-spacing:1px}
.live-cd{font-size:12px;color:#94A3B8;font-family:'JetBrains Mono',monospace;min-width:24px;text-align:right}

/* === TABS === */
.r-tabs{display:flex;gap:6px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;-ms-overflow-style:none;padding-bottom:3px;flex-shrink:0}
.r-tabs button{background:rgba(148,163,184,0.06);color:#B0BEC5;border:1px solid rgba(148,163,184,0.1);border-radius:8px;padding:6px 14px;font-size:13px;font-weight:600;font-family:'DM Sans',sans-serif;transition:all .2s}
.r-tabs button.active{background:rgba(247,147,26,0.15);color:#F7931A;border-color:rgba(247,147,26,0.3)}
.r-tabs button:hover:not(.active){background:rgba(148,163,184,0.1)}

/* === TAB CONTENT === */
.tab-content{display:none}.tab-content.active{display:block}

/* === HERO GRID (4 columns) === */
.r-hero4{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:14px}
.hero-card{padding:24px 20px}
.hero-hdr{display:flex;align-items:center;gap:8px;margin-bottom:16px}
.hero-bar{width:4px;height:18px;border-radius:2px}
.hero-lbl{font-size:14px;font-weight:700;font-family:'DM Sans',sans-serif;color:#CBD5E1}
.hero-val{font-size:34px;font-weight:800;font-family:'DM Sans',sans-serif;color:#F1F5F9;line-height:1;margin-bottom:14px;text-align:center}
.hero-ctr{text-align:center}
.hero-hint{font-size:11px;color:#596882;text-align:right;transition:opacity .2s}

/* === DELTA PILL (badge) === */
.badge{display:inline-flex;align-items:center;gap:4px;border-radius:20px;padding:4px 10px;white-space:nowrap}
.badge-pos{background:rgba(34,197,94,0.12)}
.badge-neg{background:rgba(248,113,113,0.12)}
.badge-orange{background:rgba(247,147,26,0.12)}
.badge .arr{font-size:11px}
.badge .pv{font-size:12px;font-family:'JetBrains Mono',monospace;font-weight:700}
.badge .sp{font-size:11px;color:#CBD5E1;margin:0 1px}
.badge .dt{font-size:11px;color:#CBD5E1}
.badge .dm{font-size:11px;font-family:'JetBrains Mono',monospace;font-weight:600;color:#CBD5E1}

/* === ITD / QTD SPLIT PANEL === */
.r-itdqtd{display:grid;grid-template-columns:1fr 1fr;padding:0;overflow:hidden}
.r-itdqtd .itd-h{padding:28px 32px 24px}
.r-itdqtd .itd-h:first-child{border-right:1px solid rgba(148,163,184,0.08)}
.itd-tr{display:flex;align-items:center;gap:10px;margin-bottom:4px}
.itd-bar{width:5px;height:22px;border-radius:3px}
.itd-t{font-size:18px;font-weight:800;font-family:'DM Sans',sans-serif;color:#F1F5F9;letter-spacing:0.5px}
.itd-st{font-size:11px;color:#596882;font-family:'JetBrains Mono',monospace;letter-spacing:1px;margin-top:2px;padding-left:15px}
.itd-rets{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px}
.ret-i .ret-lr{display:flex;align-items:center;gap:6px;margin-bottom:10px}
.ret-bar{width:3px;height:14px;border-radius:2px}
.ret-nm{font-size:13px;font-weight:700;font-family:'DM Sans',sans-serif;color:#B0BEC5}
.ret-v{font-size:30px;font-weight:800;font-family:'DM Sans',sans-serif;line-height:1}

/* === ALPHA BOX === */
.alpha-box{background:linear-gradient(135deg,rgba(34,197,94,0.08),rgba(34,197,94,0.03));border:1px solid rgba(34,197,94,0.15);border-radius:14px;padding:18px 20px;text-align:center}
.alpha-hdr{display:flex;align-items:center;justify-content:center;gap:6px;margin-bottom:8px}
.alpha-bar{width:3px;height:14px;border-radius:2px;background:#4ADE80}
.alpha-lbl{font-size:13px;font-weight:700;font-family:'DM Sans',sans-serif;color:#4ADE80;text-transform:uppercase;letter-spacing:1.5px}
.alpha-val{font-size:32px;font-weight:800;font-family:'DM Sans',sans-serif;color:#4ADE80;line-height:1;margin-bottom:10px}
.alpha-bdg{display:inline-flex;align-items:center;gap:4px;background:rgba(34,197,94,0.12);border-radius:20px;padding:4px 10px}
.alpha-bdg span{font-size:12px;color:#4ADE80}
.alpha-bdg .av{font-family:'JetBrains Mono',monospace;font-weight:700}
.alpha-bdg .as{color:#CBD5E1;margin:0 1px;font-size:11px}
.alpha-bdg .ad{color:#CBD5E1;font-size:11px}
.alpha-bdg .am{font-family:'JetBrains Mono',monospace;font-weight:600;font-size:11px;color:#CBD5E1}

/* === CHART CARD === */
.chart-tr{display:flex;align-items:center;gap:8px;margin-bottom:16px}
.chart-icon{font-size:18px}
.chart-tt{margin:0;font-size:14px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:#F1F5F9}
.chart-leg{display:flex;align-items:center;gap:16px;margin-bottom:16px;font-size:12px;color:#8896AB}
.leg-i{display:flex;align-items:center;gap:6px}
.leg-line{width:16px;height:3px;border-radius:2px}
.leg-dash{width:16px;height:0;border-top:2px dashed #F7931A}
.leg-bars{width:16px;height:12px;background:linear-gradient(90deg,rgba(34,197,94,0.5) 50%,rgba(239,68,68,0.5) 50%);border-radius:2px}
.leg-dot{width:8px;height:8px;border-radius:50%}
.chart-box{height:360px;position:relative}

/* === SECTION TITLE === */
.sec-t{font-size:14px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:#F1F5F9;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.sec-icon{font-size:18px}

/* === NARRATIVE BOX === */
.narr{background:rgba(15,23,42,0.65);backdrop-filter:blur(20px);border:1px solid rgba(148,163,184,0.1);border-radius:14px;padding:20px;margin-top:16px}
.narr-t{font-size:16px;font-weight:700;color:#4ADE80;margin-bottom:8px}
.narr-p{font-size:13px;color:#B0BEC5;line-height:1.7}
.hl-g{color:#4ADE80;font-weight:700}
.hl-o{color:#F7931A;font-weight:700}
.hl-r{color:#F87171;font-weight:600}

/* === KEY METRICS ROWS === */
.met-row{display:flex;justify-content:space-between;align-items:baseline;padding:14px 0;border-bottom:1px solid rgba(148,163,184,0.06)}
.met-row:last-child{border-bottom:none}
.met-row-label{font-size:14px;color:#B0BEC5}
.met-row-value{font-size:15px;font-weight:700;color:#F1F5F9;font-family:'JetBrains Mono',monospace;text-align:right}
.met-row-sub{font-size:11px;color:#4ADE80;font-style:italic;text-align:right;margin-top:2px;font-family:'JetBrains Mono',monospace}

/* === TWR SUMMARY === */
.twr-period{margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid rgba(148,163,184,0.1)}
.twr-period:last-child{margin-bottom:0;padding-bottom:0;border-bottom:none}
.twr-period-title{font-size:14px;font-weight:800;color:#F1F5F9;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.twr-period-bar{width:4px;height:18px;border-radius:2px;display:inline-block}
.twr-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid rgba(148,163,184,0.06)}
.twr-row:last-child{border-bottom:none}
.twr-row-label{font-size:14px;color:#B0BEC5}
.twr-row-label.alpha{color:#4ADE80;font-weight:600}
.twr-row-value{font-size:16px;font-weight:700;font-family:'JetBrains Mono',monospace}

/* === VENUE BREAKDOWN === */
.venue-group{margin-bottom:16px}
.venue-asset-title{font-size:14px;font-weight:700;margin-bottom:6px}
.venue-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0 6px 16px;border-bottom:1px solid rgba(148,163,184,0.04)}
.venue-row-label{font-size:13px;color:#B0BEC5}
.venue-row-value{font-size:13px;font-family:'JetBrains Mono',monospace;color:#F1F5F9;font-weight:500}
.venue-total{display:flex;justify-content:space-between;align-items:center;padding:8px 0 8px 16px;border-top:1px solid rgba(148,163,184,0.12);margin-top:2px}
.venue-total-label{font-size:12px;font-weight:700;color:#CBD5E1;text-transform:uppercase;letter-spacing:0.5px}
.venue-total-value{font-size:13px;font-family:'JetBrains Mono',monospace;color:#F1F5F9;font-weight:700}

/* === 2-COL GRID === */
.r-grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:14px}
.r-grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-top:16px}

/* === TABLES === */
.tbl-w{overflow-x:auto;-webkit-overflow-scrolling:touch}
table.tbl{width:100%;border-collapse:collapse;font-size:13px;min-width:520px}
table.tbl th{text-align:left;padding:10px 12px;color:#8896AB;font-weight:600;font-size:12px;text-transform:uppercase;letter-spacing:1px;border-bottom:1px solid rgba(148,163,184,0.1)}
table.tbl td{padding:10px 12px;color:#B0BEC5;border-bottom:1px solid rgba(148,163,184,0.05)}
table.tbl td:first-child{color:#F1F5F9;font-weight:500}
table.tbl .mono{font-family:'JetBrains Mono',monospace}
table.tbl .right{text-align:right}
table.tbl th.right{text-align:right}
table.tbl .bold{font-weight:700;color:#F1F5F9}
table.tbl tr:hover td{background:rgba(148,163,184,0.03)}

/* === ALLOCATION BARS === */
.ab-row{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.ab-lbl{width:60px;font-size:13px;color:#B0BEC5;text-align:right;flex-shrink:0}
.ab-track{flex:1;height:28px;background:rgba(148,163,184,0.04);border-radius:4px;position:relative;overflow:hidden}
.ab-fill{height:100%;border-radius:4px;display:flex;align-items:center;padding-left:8px;font-size:11px;font-family:'JetBrains Mono',monospace;color:#F1F5F9;font-weight:600;opacity:0.7;transition:width .6s}
.ab-pct{width:55px;text-align:right;font-size:12px;font-family:'JetBrains Mono',monospace;color:#94A3B8;flex-shrink:0}

/* === COST BASIS BARS === */
.cb-row{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.cb-lbl{width:120px;flex-shrink:0;font-size:12px;color:#B0BEC5;text-align:right;font-family:'JetBrains Mono',monospace}
.cb-track{flex:1;height:28px;position:relative;background:rgba(148,163,184,0.04);border-radius:4px}
.cb-fill{height:100%;border-radius:4px;opacity:0.7}
.cb-marker{position:absolute;top:-2px;bottom:-2px;width:2px;background:#F1F5F9;border-radius:1px}
.cb-val{width:50px;flex-shrink:0;font-size:11px;font-family:'JetBrains Mono',monospace;text-align:right;font-weight:600}

/* === DRAWDOWN === */
.r-dd2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.dd-s{text-align:center}
.dd-l{font-size:12px;color:#8896AB;font-weight:600;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px}
.dd-v{font-size:22px;font-weight:700;font-family:'JetBrains Mono',monospace}
.dd-sub{font-size:11px;color:#596882;margin-top:2px}

/* === SMALL METRIC CARD === */
.smc{padding:18px}
.smc-l{font-size:12px;color:#8896AB;font-weight:600;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px}
.smc-v{font-size:22px;font-weight:700;font-family:'JetBrains Mono',monospace}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE BREAKPOINTS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* TABLET â‰¤ 1024px */
@media(max-width:1024px){
  .r-hero4{grid-template-columns:repeat(2,1fr)!important}
}

/* MOBILE â‰¤ 768px */
@media(max-width:768px){
  .r-header{flex-direction:column!important;align-items:stretch!important;gap:14px!important;margin-bottom:20px!important}
  .header-right{flex-direction:row!important;align-items:center!important;justify-content:space-between!important}
  .live-pill{order:1}
  .r-tabs{gap:5px;order:0;flex:1}
  .r-tabs button{white-space:nowrap;flex-shrink:0;padding:8px 14px!important;font-size:13px!important;border-radius:10px!important}
  .r-card{padding:16px!important;border-radius:14px!important}
  .r-hero4{grid-template-columns:repeat(2,1fr)!important;gap:10px!important}
  .r-grid2{grid-template-columns:1fr!important}
  .r-grid3{grid-template-columns:1fr!important}
  .r-itdqtd{grid-template-columns:1fr!important}
  .r-itdqtd .itd-h:first-child{border-right:none!important;border-bottom:1px solid rgba(148,163,184,0.1)!important;padding-bottom:24px!important;margin-bottom:8px}
  .r-dd2{grid-template-columns:1fr!important}
  .cb-lbl{width:80px!important;font-size:10px!important}
  div[style*="maxWidth: 1280"]{padding-left:14px!important;padding-right:14px!important}
}

/* SMALL PHONE â‰¤ 480px */
@media(max-width:480px){
  .r-hero4{grid-template-columns:1fr 1fr!important;gap:8px!important}
  .r-card{padding:12px!important;border-radius:12px!important}
  .r-tabs button{padding:7px 10px!important;font-size:12px!important;border-radius:8px!important}
  .cb-lbl{width:65px!important;font-size:9px!important}
}
</style>
</head>
<body>
<div class="loading-overlay" id="loadingOverlay">
  <div style="text-align:center">
    <div style="width:48px;height:48px;border-radius:14px;background:linear-gradient(135deg,#22C55E,#15803D);display:inline-flex;align-items:center;justify-content:center;font-size:24px;margin-bottom:12px;box-shadow:0 4px 20px rgba(34,197,94,0.3)">â˜˜</div>
    <div style="color:#94A3B8;font-size:13px;font-family:'JetBrains Mono',monospace">Loading portfolio dataâ€¦</div>
  </div>
</div>
<div class="orb-orange"></div>
<div class="orb-blue"></div>
<div class="page-shell">
<div class="error-banner" id="errorBanner"></div>

<div class="r-header">
  <div class="header-left">
    <div class="header-brand">
      <div class="header-logo">â˜˜</div>
      <h1 class="header-title">Clover Capital</h1>
    </div>
    <p class="header-date" id="headerDate">â€”</p>
  </div>
  <div class="header-right">
    <div class="live-pill" id="livePill">
      <span class="live-dot"></span>
      <span class="live-text">LIVE</span>
      <span class="live-cd" id="countdown">â€”</span>
    </div>
    <div class="r-tabs" id="tabBar">
      <button class="active" data-tab="overview">Overview</button>
      <button data-tab="performance">Performance</button>
      <button data-tab="allocation">Allocation</button>
      <button data-tab="tranches">Purchases</button>
    </div>
  </div>
</div>

<div class="r-hero4">
  <div class="r-card hero-card">
    <div class="hero-hdr"><div class="hero-bar" style="background:linear-gradient(180deg,#94A3B8,#64748B)"></div><span class="hero-lbl">Total AUM</span></div>
    <div class="hero-val" id="heroAUM">â€”</div>
    <div class="hero-ctr" id="heroAUMBadge"></div>
  </div>
  <div class="r-card hero-card" id="heroBTCCardHover" style="cursor:pointer">
    <div class="hero-hdr"><div class="hero-bar" style="background:linear-gradient(180deg,#F7931A,#E2761B)"></div><span class="hero-lbl">BTC Holdings</span><span class="hero-hint" id="heroBTCHint">hover for USD</span></div>
    <div class="hero-val" id="heroBTC" style="color:#F7931A">â€”</div>
    <div class="hero-ctr" id="heroBTCBadge"></div>
  </div>
  <div class="r-card hero-card">
    <div class="hero-hdr"><div class="hero-bar" style="background:linear-gradient(180deg,#F7931A,#E2761B)"></div><span class="hero-lbl">BTC Price</span></div>
    <div class="hero-val" id="heroBTCPrice" style="color:#F7931A">â€”</div>
    <div class="hero-ctr" id="heroBTCPriceBadge"></div>
  </div>
  <div class="r-card hero-card">
    <div class="hero-hdr"><div class="hero-bar" style="background:linear-gradient(180deg,#8B5CF6,#7C3AED)"></div><span class="hero-lbl">Avg Cost Basis</span></div>
    <div class="hero-val" id="heroAvgCost" style="color:#CBD5E1">â€”</div>
    <div class="hero-ctr" id="heroAvgCostBadge"></div>
  </div>
</div>

<div class="tab-content active" id="tab-overview">
  <div class="r-card r-itdqtd">
    <div class="itd-h">
      <div style="margin-bottom:24px"><div class="itd-tr"><div class="itd-bar" style="background:linear-gradient(180deg,#F7931A,#E2761B)"></div><div class="itd-t">Inception to Date</div></div><div class="itd-st">TIME-WEIGHTED RETURNS</div></div>
      <div class="itd-rets">
        <div class="ret-i"><div class="ret-lr"><div class="ret-bar" style="background:#F87171"></div><span class="ret-nm">Fund Return</span></div><div class="ret-v" id="itdFund" style="color:#F87171">â€”</div></div>
        <div class="ret-i"><div class="ret-lr"><div class="ret-bar" style="background:#F87171"></div><span class="ret-nm">BTC Benchmark</span></div><div class="ret-v" id="itdBTC" style="color:#F87171">â€”</div></div>
      </div>
      <div class="alpha-box"><div class="alpha-hdr"><div class="alpha-bar"></div><span class="alpha-lbl">ALPHA *</span></div><div class="alpha-val" id="itdAlpha">â€”</div><div id="itdAlphaBadge"></div></div>
    </div>
    <div class="itd-h">
      <div style="margin-bottom:24px"><div class="itd-tr"><div class="itd-bar" style="background:linear-gradient(180deg,#3B82F6,#2563EB)"></div><div class="itd-t">Quarter to Date</div></div><div class="itd-st">TIME-WEIGHTED RETURNS</div></div>
      <div class="itd-rets">
        <div class="ret-i"><div class="ret-lr"><div class="ret-bar" style="background:#F87171"></div><span class="ret-nm">Fund Return</span></div><div class="ret-v" id="qtdFund" style="color:#F87171">â€”</div></div>
        <div class="ret-i"><div class="ret-lr"><div class="ret-bar" style="background:#F87171"></div><span class="ret-nm">BTC Benchmark</span></div><div class="ret-v" id="qtdBTC" style="color:#F87171">â€”</div></div>
      </div>
      <div class="alpha-box"><div class="alpha-hdr"><div class="alpha-bar"></div><span class="alpha-lbl">ALPHA *</span></div><div class="alpha-val" id="qtdAlpha">â€”</div><div id="qtdAlphaBadge"></div></div>
    </div>
  </div>

  <div class="r-card">
    <div class="chart-tr"><span class="chart-icon">ğŸ§ </span><h3 class="chart-tt">ALPHA GENERATION â€” FUND VS BTC (ITD TIME-WEIGHTED RETURNS)</h3></div>
    <div class="chart-leg">
      <div class="leg-i"><div class="leg-line" style="background:#3B82F6"></div>Fund TWR</div>
      <div class="leg-i"><div class="leg-dash"></div>BTC TWR</div>
      <div class="leg-i"><div class="leg-line" style="background:#8B5CF6"></div>BTC Price</div>
      <div class="leg-i"><div class="leg-bars"></div>Alpha Spread</div>
      <div class="leg-i"><div class="leg-dot" style="background:#4ADE80;box-shadow:0 0 6px rgba(74,222,128,0.5)"></div>TWAP Buy</div>
      <div class="leg-i"><div class="leg-dot" style="background:#60A5FA;box-shadow:0 0 6px rgba(96,165,250,0.5)"></div>Limit Buy</div>
    </div>
    <div class="chart-box"><canvas id="twrChart"></canvas></div>
    <div class="narr"><div class="narr-t">ğŸ“Š Alpha Narrative</div><div class="narr-p" id="commentary">Loadingâ€¦</div></div>
  </div>

  <div class="r-grid2">
    <div class="r-card">
      <div class="sec-t"><span class="sec-icon">ğŸ”‘</span> KEY METRICS</div>
      <div id="keyMetricsDetail"></div>
    </div>
    <div class="r-card">
      <div class="sec-t"><span class="sec-icon">â±ï¸</span> TIME-WEIGHTED RETURNS</div>
      <div id="twrSummary"></div>
    </div>
  </div>

  <div class="r-grid2">
    <div class="r-card">
      <div class="sec-t"><span class="sec-icon">ğŸ³</span> ASSET BREAKDOWN</div>
      <div style="height:320px;position:relative"><canvas id="assetPieChart"></canvas></div>
      <div id="pieLegend" style="display:flex;flex-wrap:wrap;justify-content:center;gap:14px;margin-top:14px;font-size:12px"></div>
    </div>
    <div class="r-card">
      <div class="sec-t"><span class="sec-icon">ğŸ¦</span> VENUE BREAKDOWN</div>
      <div id="venueBreakdown"></div>
    </div>
  </div>
</div>

<div class="tab-content" id="tab-performance">
  <div class="r-card">
    <div class="chart-tr"><span class="chart-icon">ğŸ§ </span><h3 class="chart-tt">ALPHA GENERATION â€” FUND VS BTC</h3></div>
    <div class="chart-leg">
      <div class="leg-i"><div class="leg-line" style="background:#3B82F6"></div>Fund TWR</div><div class="leg-i"><div class="leg-dash"></div>BTC TWR</div><div class="leg-i"><div class="leg-line" style="background:#8B5CF6"></div>BTC Price</div><div class="leg-i"><div class="leg-bars"></div>Alpha Spread</div><div class="leg-i"><div class="leg-dot" style="background:#4ADE80;box-shadow:0 0 6px rgba(74,222,128,0.5)"></div>TWAP Buy</div><div class="leg-i"><div class="leg-dot" style="background:#60A5FA;box-shadow:0 0 6px rgba(96,165,250,0.5)"></div>Limit Buy</div>
    </div>
    <div class="chart-box"><canvas id="twrChart2"></canvas></div>
    <div class="narr"><div class="narr-t">ğŸ“Š Alpha Narrative</div><div class="narr-p" id="commentary2">Loadingâ€¦</div></div>
  </div>
  <div class="r-card"><div class="sec-t"><span class="sec-icon">ğŸ“ˆ</span> Alpha Spread Over Time</div><div class="chart-box" style="height:260px"><canvas id="alphaSpreadChart"></canvas></div></div>
  <div class="r-card">
    <div class="sec-t">Drawdown from Peak</div>
    <div class="r-dd2" style="margin-bottom:16px">
      <div class="dd-s"><div class="dd-l">Max Drawdown</div><div class="dd-v" id="maxDDValue2" style="color:#F87171">â€”</div><div class="dd-sub" id="maxDDDate2"></div></div>
      <div class="dd-s"><div class="dd-l">Current Drawdown</div><div class="dd-v" id="curDDValue2" style="color:#F87171">â€”</div></div>
    </div>
    <div class="chart-box" style="height:200px"><canvas id="drawdownChart2"></canvas></div>
  </div>
  <div class="r-grid2">
    <div class="r-card"><div class="sec-t">Time-Weighted Returns</div><div class="tbl-w"><table class="tbl"><thead><tr><th>Asset</th><th>QTD P&L</th><th>QTD Ret</th><th>ITD P&L</th><th>ITD Ret</th></tr></thead><tbody id="mwrBody"></tbody></table></div></div>
    <div class="r-card"><div class="sec-t">BTC Benchmark</div><div class="tbl-w"><table class="tbl"><thead><tr><th>Benchmark</th><th>QTD P&L</th><th>QTD Ret</th><th>ITD P&L</th><th>ITD Ret</th></tr></thead><tbody id="btcTwrBody"></tbody></table></div></div>
  </div>
</div>

<div class="tab-content" id="tab-allocation">
  <div class="r-card"><div class="sec-t">Asset Allocation</div><div id="allocBars"></div></div>
  <div class="r-grid2">
    <div class="r-card"><div class="sec-t">Holdings Chart</div><div class="chart-box" style="height:280px"><canvas id="holdingsChart"></canvas></div></div>
    <div class="r-card"><div class="sec-t">Asset Breakdown</div><div class="tbl-w"><table class="tbl"><thead><tr><th>Asset</th><th>Amount</th><th>Price</th><th>Value</th><th>Weight</th></tr></thead><tbody id="allocTable"></tbody></table></div></div>
  </div>
  <div class="r-card"><div class="sec-t">Custodian Breakdown</div><div class="tbl-w"><table class="tbl"><thead><tr><th>Asset</th><th>Venue</th><th>Amount</th><th>Price</th><th>Value</th></tr></thead><tbody id="venueTable"></tbody></table></div></div>
</div>

<div class="tab-content" id="tab-tranches">
  <div class="r-card"><div class="sec-t">Purchase Tranches</div><div class="tbl-w"><table class="tbl"><thead><tr><th>Tranche</th><th>Qty</th><th>Avg Cost</th><th>Date</th><th>Value</th></tr></thead><tbody id="purchaseTable"></tbody></table></div></div>
  <div class="r-card">
    <div class="sec-t">Cost Basis by Tranche</div>
    <div style="display:flex;justify-content:space-between;margin-bottom:12px;font-size:11px;font-family:'JetBrains Mono',monospace">
      <span style="color:#4ADE80">â— BTC Price: <span id="btcPriceLabel">â€”</span></span>
      <span style="color:#F7931A">â— Avg Cost: <span id="avgCostLabel">â€”</span></span>
    </div>
    <div id="costBars"></div>
  </div>
  <div class="r-card"><div class="sec-t">Purchase Cost</div><div class="chart-box" style="height:280px"><canvas id="purchaseCostChart"></canvas></div></div>
</div>

</div><!-- /page-shell -->
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG (from index(4).html)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SHEET_ID = '1QiW-1REapN-UD76xTf5ne4P-J6cWvMPJuuVqaYATFk0';
const PUBLISH_ID = '2PACX-1vRwRHNmvnfYRYB3LRuUpLd2pt8R-RSSYYqU2DZ_QUoNRzFW0NmzZ2OsICbxX1xYc9l4ChniUmdwhDbF';
const TABS = {
  dashboard: 163729112,
  perfSummary: 828103600,
  returnsDaily: 1053773100,
  purchases: 1222270502,
  historicalPrices: 1760753841
};
const INCEPTION_DATE = '2025-12-12';
const INCEPTION_AUM = 33770670.78;
const INCEPTION_BTC_PRICE = 90287.49;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let lastGoodData = null;
let charts = {};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CSV FETCHING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function csvUrl(gid) {
  return `https://docs.google.com/spreadsheets/d/e/${PUBLISH_ID}/pub?gid=${gid}&single=true&output=csv&_t=${Date.now()}`;
}

async function fetchCSV(gid) {
  const resp = await fetch(csvUrl(gid), {cache: 'no-store'});
  if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
  const text = await resp.text();
  if (!text || text.length < 10 || text.includes('<!DOCTYPE')) throw new Error('Got HTML instead of CSV for gid ' + gid);
  return Papa.parse(text, { header: false, skipEmptyLines: true }).data;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARSING HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parseNum(s) {
  if (!s || s === '-' || s === '') return null;
  return parseFloat(String(s).replace(/[$,%()]/g, '').replace(/\s/g, ''));
}
function parsePct(s) {
  if (!s || s === '-' || s === '') return null;
  let n = parseFloat(String(s).replace(/[%$,+]/g, '').replace(/[()]/g, m => m === '(' ? '-' : ''));
  if (String(s).includes('%')) return n / 100;
  return n;
}
function parseDollar(s) {
  if (!s || s === '-' || s === '') return null;
  let str = String(s).replace(/[$,\s]/g, '');
  if (str.startsWith('(') && str.endsWith(')')) str = '-' + str.slice(1, -1);
  return parseFloat(str);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FORMATTING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmtDollar(n, compact) {
  if (n == null || isNaN(n)) return 'â€”';
  if (compact && Math.abs(n) >= 1e6) return '$' + (n / 1e6).toFixed(2) + 'M';
  if (compact && Math.abs(n) >= 1e3) return '$' + (n / 1e3).toFixed(1) + 'K';
  return n < 0 
    ? '-$' + Math.abs(n).toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2})
    : '$' + n.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2});
}
function fmtPct(n, decimals=2) {
  if (n == null || isNaN(n)) return 'â€”';
  return (n * 100).toFixed(decimals) + '%';
}
function fmtPctRaw(n, decimals=2) {
  if (n == null || isNaN(n)) return 'â€”';
  return n.toFixed(decimals) + '%';
}
function fmtNum(n, decimals=2) {
  if (n == null || isNaN(n)) return 'â€”';
  return n.toLocaleString('en-US', {minimumFractionDigits:decimals, maximumFractionDigits:decimals});
}
function colorPct(el, val) {
  if (val == null) return;
  el.style.color = val >= 0 ? '#4ADE80' : '#F87171';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA PARSING FROM SHEETS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parseDashboard(rows) {
  const data = {};
  data.todayDate = rows[1]?.[2] || '';
  data.aum = parseDollar(rows[4]?.[1]);
  data.btcPrice = parseDollar(rows[4]?.[4]);
  data.btcHoldings = parseNum(rows[4]?.[7]);
  data.btcAvgCost = parseDollar(rows[5]?.[14]);
  data.btcAvgPurchasePrice = parseDollar(rows[6]?.[14]);
  data.twoPointFiveAUM = parseDollar(rows[7]?.[14]);
  data.mwrITDFund = parsePct(rows[8]?.[14]);
  data.itdTWRFund = parsePct(rows[10]?.[14]);
  data.itdTWRBTC = parsePct(rows[11]?.[14]);
  data.itdAlpha = parsePct(rows[12]?.[14]);
  data.qtdTWRFund = parsePct(rows[14]?.[14]);
  data.qtdTWRBTC = parsePct(rows[15]?.[14]);
  data.qtdAlpha = parsePct(rows[16]?.[14]);
  data.mwrRows = [];
  for (let i = 10; i <= 15; i++) {
    data.mwrRows.push({
      label: rows[i]?.[1] || '',
      qtdPnl: parseDollar(rows[i]?.[2]),
      qtdRet: parsePct(rows[i]?.[4]),
      itdPnl: parseDollar(rows[i]?.[6]),
      itdRet: parsePct(rows[i]?.[8])
    });
  }
  data.btcTWR = {
    label: rows[19]?.[1] || 'BTC (ALL TWR)',
    qtdPnl: parseDollar(rows[19]?.[2]),
    qtdRet: parsePct(rows[19]?.[4]),
    itdPnl: parseDollar(rows[19]?.[6]),
    itdRet: parsePct(rows[19]?.[8])
  };
  data.assets = [];
  for (let i = 23; i <= 27; i++) {
    const asset = rows[i]?.[1];
    if (!asset) continue;
    data.assets.push({
      asset: asset,
      amount: parseNum(rows[i]?.[2]),
      price: parseDollar(rows[i]?.[4]),
      aum: parseDollar(rows[i]?.[6]),
      pct: parseNum(rows[i]?.[8]?.replace('%','')) / 100
    });
  }
  data.venues = [];
  let currentAsset = '';
  for (let i = 31; i <= 44; i++) {
    const row = rows[i];
    if (!row) continue;
    const assetCol = row[1]?.trim();
    const venueCol = row[2]?.trim();
    if (assetCol && assetCol !== '') currentAsset = assetCol;
    if (venueCol && venueCol !== '') {
      data.venues.push({ asset: currentAsset, venue: venueCol, amount: row[4] || '', price: row[6] || '', value: row[8] || '' });
    } else if (assetCol) {
      data.venues.push({ asset: currentAsset, venue: '(Total)', amount: row[4] || '', price: row[6] || '', value: row[8] || '', isSummary: true });
    }
  }
  return data;
}

function parsePerfSummary(rows) {
  // PerfSummary tab layout (0-indexed):
  // Row 3 (idx 3): Inception Date | 12/12/2025 | Current Date | 2/10/2026
  // Row 4 (idx 4): Quarter Start | 12/31/2025 | Days Since Inception | 60
  // Row 8 (idx 8): Return | Fund(TWR) | BTC Benchmark | Alpha
  // Row 10 (idx 10): Inception BTC Price | | $90,287.49
  // Row 11 (idx 11): Current BTC Price | | $68,227.00
  // Row 12 (idx 12): P&L ($) | Fund | BTC | Alpha
  // Row 16 (idx 16): QTD Return | Fund | BTC | Alpha
  // Row 18 (idx 18): Dec 31 BTC Price | | $87,519.15
  // Row 19 (idx 19): QTD P&L ($) | Fund | BTC | Alpha
  // Row 22 (idx 22): Current AUM | value
  // Row 23 (idx 23): Total Capital Invested | value
  // Row 24 (idx 24): Total P&L | value
  // Row 25 (idx 25): BTC Holdings | 328.02
  // Row 26 (idx 26): Current BTC Price | $68,227.00
  // Row 27 (idx 27): Inception BTC Price | $90,287.49
  const data = {};
  data.inceptionDate = rows[3]?.[2];
  data.currentDate = rows[3]?.[4];
  data.quarterStart = rows[4]?.[2];
  data.daysSinceInception = parseNum(rows[4]?.[4]);
  
  // ITD (row 8)
  data.itdFundTWR = parsePct(rows[8]?.[2]);
  data.itdBTCTWR = parsePct(rows[8]?.[3]);
  data.itdAlpha = parsePct(rows[8]?.[4]);
  
  // BTC Prices (rows 10-11)
  data.inceptionBTCPrice = parseDollar(rows[10]?.[3]);
  data.currentBTCPrice = parseDollar(rows[11]?.[3]);
  
  // ITD P&L (row 12)
  data.itdPnLFund = parseDollar(rows[12]?.[2]);
  data.itdPnLBTC = parseDollar(rows[12]?.[3]);
  data.itdPnLAlpha = parseDollar(rows[12]?.[4]);
  
  // QTD (row 16)
  data.qtdFundTWR = parsePct(rows[16]?.[2]);
  data.qtdBTCTWR = parsePct(rows[16]?.[3]);
  data.qtdAlpha = parsePct(rows[16]?.[4]);
  
  // Dec 31 BTC price (row 18)
  data.dec31BTCPrice = parseDollar(rows[18]?.[3]);
  
  // QTD P&L (row 19)
  data.qtdPnLFund = parseDollar(rows[19]?.[2]);
  data.qtdPnLBTC = parseDollar(rows[19]?.[3]);
  data.qtdPnLAlpha = parseDollar(rows[19]?.[4]);
  
  // Key Metrics (rows 22-28)
  data.currentAUM = parseDollar(rows[22]?.[2]);
  data.totalCapitalInvested = parseDollar(rows[23]?.[2]);
  data.totalPnL = parseDollar(rows[24]?.[2]);
  data.btcHoldings = parseNum(rows[25]?.[2]);
  data.currentBTCPriceKM = parseDollar(rows[26]?.[2]);  // $68,227.00
  data.inceptionBTCPriceKM = parseDollar(rows[27]?.[2]); // $90,287.49
  
  return data;
}

function parseReturnsDaily(rows) {
  // RETURNS DAILY column layout (verified from sheet):
  // Portfolio - Consolidated group (cols 0-8):
  //   0: Date, 1: Inflows, 2: Invested (Cost Basis), 3: Cumulative Inflows
  //   4: Daily TWR, 5: Cumulative TWR, 6: Portfolio Value
  //   7: Total Gain/Loss, 8: MWR
  // BTC group (cols 9-15):
  //   9: Holdings (Amt), 10: Asset Price, 11: Invested, 12: Market Value
  //   13: Total Gain/Loss, 14: Port Daily Returns, 15: Token Daily Returns
  // WBTC group (cols 16-22), USDC (23-29), USD (30-36), ETH (37-43)
  
  const COL = {
    date: 0,
    inflows: 1,
    invested: 2,
    cumInflows: 3,
    dailyTWR: 4,
    cumTWR: 5,
    portfolioValue: 6,
    totalGL: 7,
    mwr: 8,
    btcHoldings: 9,
    btcPrice: 10,
    btcInvested: 11,
    btcMarketValue: 12,
    btcTokenDailyReturn: 15,
  };
  
  console.log('[parseReturnsDaily] Using hardcoded columns:', COL);
  
  const data = [];
  let btcCumTWR = 0; // compound BTC token returns
  
  for (let i = 3; i < rows.length; i++) {
    const row = rows[i];
    if (!row || !row[0]) continue;
    const dateStr = String(row[0]).trim();
    if (!dateStr.match(/^\d{1,2}\/\d{1,2}\/\d{2,4}$/)) continue;
    
    const dailyTWR = parsePctCell(row[COL.dailyTWR]);
    const cumTWR = parsePctCell(row[COL.cumTWR]);
    const portfolioValue = parseDollar(row[COL.portfolioValue]);
    const totalGL = parseDollar(row[COL.totalGL]);
    const btcHoldings = parseNum(row[COL.btcHoldings]);
    const btcPrice = parseDollar(row[COL.btcPrice]);
    const btcMarketValue = parseDollar(row[COL.btcMarketValue]);
    const btcDailyReturn = parsePctCell(row[COL.btcTokenDailyReturn]);
    
    // Compound BTC daily returns to get BTC cumulative TWR
    if (btcDailyReturn != null && data.length > 0) {
      btcCumTWR = ((1 + btcCumTWR/100) * (1 + btcDailyReturn/100) - 1) * 100;
    }
    
    if (cumTWR == null && dailyTWR == null && !portfolioValue) continue;
    data.push({ date: dateStr, dailyTWR, cumTWR, portfolioValue, totalGL, btcHoldings, btcPrice, btcMarketValue, btcDailyReturn, btcCumTWR });
  }
  return data;
}

function parsePctCell(s) {
  if (!s || s === '-' || s === '' || String(s).toLowerCase().includes('loading')) return null;
  const str = String(s).trim();
  let n = parseFloat(str.replace(/[%$,+]/g, '').replace(/[()]/g, m => m === '(' ? '-' : ''));
  if (isNaN(n)) return null;
  if (str.includes('%')) return n; // "-2.16%" â†’ -2.16
  // Small decimal without % sign = ratio, convert to percentage
  if (Math.abs(n) < 1) return n * 100;
  return n;
}

function parsePurchases(rows) {
  const purchases = [];
  for (let i = 3; i <= 20; i++) {
    const row = rows[i];
    if (!row || !row[1]) break;
    purchases.push({ token: row[1], venue: row[2], description: row[3], orderDate: row[4], fillDate: row[5], qty: parseNum(row[6]), basis: parseDollar(row[7]), value: parseDollar(row[8]) });
  }
  const inflows = [];
  for (let i = 3; i <= 20; i++) {
    const row = rows[i];
    if (!row || !row[10]) break;
    inflows.push({ stakeholder: row[10], person: row[11], asset: row[12], qty: row[13], basis: row[14], value: row[15], date: row[16] });
  }
  const stats = {};
  for (let i = 2; i <= 12; i++) {
    const row = rows[i];
    if (row && row[18]) stats[row[18].trim()] = row[19];
  }
  return { purchases, inflows, stats };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmtDollarCompact(n) {
  if (n == null || isNaN(n)) return 'â€”';
  if (Math.abs(n) >= 1e6) return '$' + (n/1e6).toFixed(2) + 'M';
  if (Math.abs(n) >= 1e3) return '$' + (n/1e3).toFixed(0) + 'K';
  return '$' + n.toFixed(0);
}

function makeBadge(val, prevVal, prevLabel) {
  if (val == null || isNaN(val)) return '';
  const isPos = val >= 0;
  const color = isPos ? '#4ADE80' : '#F87171';
  const arrow = isPos ? 'â–²' : 'â–¼';
  const bgClass = isPos ? 'badge-pos' : 'badge-neg';
  const pctStr = (isPos ? '+' : '') + (val * 100).toFixed(1) + '%';
  let html = `<span class="badge ${bgClass}">`;
  html += `<span class="arr" style="color:${color}">${arrow}</span>`;
  html += `<span class="pv" style="color:${color}">${pctStr}</span>`;
  if (prevLabel != null) {
    html += `<span class="sp">Â·</span><span class="dt">prev wk</span> <span class="dm">${prevLabel}</span>`;
  }
  html += '</span>';
  return html;
}

function renderDrawdownStats(returnsDaily) {
  let peak = 1, maxDD = 0, maxDDDate = '', curDD = 0;
  for (const d of returnsDaily) {
    const cumVal = 1 + (d.cumTWR || 0) / 100;
    if (cumVal > peak) peak = cumVal;
    const dd = (cumVal - peak) / peak;
    if (dd < maxDD) { maxDD = dd; maxDDDate = d.date; }
    curDD = dd;
  }
  ['maxDDValue','maxDDValue2'].forEach(id => { const el = document.getElementById(id); if (el) el.textContent = fmtPctRaw(maxDD * 100); });
  ['maxDDDate','maxDDDate2'].forEach(id => { const el = document.getElementById(id); if (el) el.textContent = maxDDDate ? formatDateLabel(maxDDDate) : ''; });
  ['curDDValue','curDDValue2'].forEach(id => { const el = document.getElementById(id); if (el) el.textContent = fmtPctRaw(curDD * 100); });
}

function renderHero(dash, perf, returnsDaily) {
  // AUM
  const aum = perf?.currentAUM || dash.aum;
  document.getElementById('heroAUM').textContent = fmtDollar(aum, true);
  const aumDelta = (aum - INCEPTION_AUM) / INCEPTION_AUM;
  // Prev week AUM from returnsDaily
  let prevAUM = null;
  if (returnsDaily && returnsDaily.length > 7) prevAUM = returnsDaily[returnsDaily.length - 8]?.portfolioValue;
  const prevAUMDelta = prevAUM ? (aum - prevAUM) / prevAUM : aumDelta;
  document.getElementById('heroAUMBadge').innerHTML = makeBadge(prevAUMDelta, null, prevAUM ? fmtDollar(prevAUM, true) : fmtDollar(INCEPTION_AUM, true));

  // BTC Holdings
  document.getElementById('heroBTC').textContent = fmtNum(dash.btcHoldings);
  let prevBTC = null;
  if (returnsDaily && returnsDaily.length > 7) prevBTC = returnsDaily[returnsDaily.length - 8]?.btcHoldings;
  const btcDelta = prevBTC ? (dash.btcHoldings - prevBTC) / prevBTC : null;
  document.getElementById('heroBTCBadge').innerHTML = btcDelta != null ? makeBadge(btcDelta, null, fmtNum(prevBTC)) : '';

  // BTC hover to show USD
  const btcCard = document.getElementById('heroBTCCardHover');
  const btcValEl = document.getElementById('heroBTC');
  const btcHintEl = document.getElementById('heroBTCHint');
  btcCard.onmouseenter = () => { btcValEl.textContent = fmtDollar(dash.btcHoldings * dash.btcPrice, true); btcHintEl.style.opacity = '0'; };
  btcCard.onmouseleave = () => { btcValEl.textContent = fmtNum(dash.btcHoldings); btcHintEl.style.opacity = '1'; };

  // BTC Price
  document.getElementById('heroBTCPrice').textContent = fmtDollar(dash.btcPrice);
  const priceDelta = (dash.btcPrice - INCEPTION_BTC_PRICE) / INCEPTION_BTC_PRICE;
  const prevPrice = returnsDaily && returnsDaily.length > 7 ? returnsDaily[returnsDaily.length - 8]?.btcPrice : null;
  document.getElementById('heroBTCPriceBadge').innerHTML = makeBadge(priceDelta, null, prevPrice ? fmtDollar(prevPrice, true) : fmtDollar(INCEPTION_BTC_PRICE, true));

  // Avg Cost Basis
  const avgCost = dash.btcAvgCost || 88923;
  document.getElementById('heroAvgCost').textContent = fmtDollar(avgCost);
  const aboveSpot = avgCost - dash.btcPrice;
  const aboveColor = aboveSpot > 0 ? '#F7931A' : '#4ADE80';
  document.getElementById('heroAvgCostBadge').innerHTML = `<span class="badge badge-orange"><span class="pv" style="color:${aboveColor}">${fmtDollarCompact(Math.abs(aboveSpot))}</span><span class="sp">Â·</span><span class="dt">${aboveSpot > 0 ? 'above spot' : 'below spot'}</span></span>`;

  // Date
  // headerDate is set in loadAllData after all rendering
}

function renderITDQTD(dash, perf) {
  const setReturn = (id, val) => {
    const el = document.getElementById(id);
    if (!el) return;
    if (val == null) { el.textContent = 'â€”'; return; }
    el.textContent = (val >= 0 ? '+' : '') + fmtPct(val);
    el.style.color = val >= 0 ? '#4ADE80' : '#F87171';
    const bar = el.closest('.ret-i')?.querySelector('.ret-bar');
    if (bar) bar.style.background = val >= 0 ? '#4ADE80' : '#F87171';
  };

  const itdFund = perf?.itdFundTWR ?? dash.itdTWRFund;
  const itdBTC = perf?.itdBTCTWR ?? dash.itdTWRBTC;
  const itdAlpha = perf?.itdAlpha ?? dash.itdAlpha;
  const qtdFund = perf?.qtdFundTWR ?? dash.qtdTWRFund;
  const qtdBTC = perf?.qtdBTCTWR ?? dash.qtdTWRBTC;
  const qtdAlpha = perf?.qtdAlpha ?? dash.qtdAlpha;

  setReturn('itdFund', itdFund);
  setReturn('itdBTC', itdBTC);
  setReturn('qtdFund', qtdFund);
  setReturn('qtdBTC', qtdBTC);

  // Alpha boxes
  const renderAlpha = (id, val, prevPP, prevPct) => {
    const el = document.getElementById(id);
    if (!el) return;
    if (val == null) { el.textContent = 'â€”'; return; }
    const isPos = val >= 0;
    el.textContent = (isPos ? '+' : '') + fmtPct(val);
    el.className = isPos ? 'alpha-val' : 'alpha-val';
    const badgeEl = document.getElementById(id === 'itdAlpha' ? 'itdAlphaBadge' : 'qtdAlphaBadge');
    if (badgeEl && prevPP) {
      badgeEl.innerHTML = `<span class="alpha-bdg"><span class="av">â–²</span><span class="av">${prevPP}</span><span class="as">Â·</span><span class="ad">prev wk</span> <span class="am">${prevPct}</span></span>`;
    }
  };

  renderAlpha('itdAlpha', itdAlpha, '+1.68pp', '+2.17%');
  renderAlpha('qtdAlpha', qtdAlpha, '+1.79pp', '+1.51%');
}

function renderMWR(dash) {
  const tbody = document.getElementById('mwrBody');
  tbody.innerHTML = '';
  dash.mwrRows.forEach((r, i) => {
    if (!r.label) return;
    const tr = document.createElement('tr');
    if (i === 0) tr.className = 'bold';
    tr.innerHTML = `
      <td>${r.label}</td>
      <td style="color:${(r.qtdPnl||0) >= 0 ? '#4ADE80' : '#F87171'}">${fmtDollar(r.qtdPnl)}</td>
      <td style="color:${(r.qtdRet||0) >= 0 ? '#4ADE80' : '#F87171'}">${fmtPct(r.qtdRet)}</td>
      <td style="color:${(r.itdPnl||0) >= 0 ? '#4ADE80' : '#F87171'}">${fmtDollar(r.itdPnl)}</td>
      <td style="color:${(r.itdRet||0) >= 0 ? '#4ADE80' : '#F87171'}">${fmtPct(r.itdRet)}</td>`;
    tbody.appendChild(tr);
  });
}

function renderBTCTWR(dash) {
  const tbody = document.getElementById('btcTwrBody');
  tbody.innerHTML = '';
  const r = dash.btcTWR;
  const tr = document.createElement('tr');
  tr.className = 'bold';
  tr.innerHTML = `
    <td>${r.label}</td>
    <td style="color:${(r.qtdPnl||0) >= 0 ? '#4ADE80' : '#F87171'}">${fmtDollar(r.qtdPnl)}</td>
    <td style="color:${(r.qtdRet||0) >= 0 ? '#4ADE80' : '#F87171'}">${fmtPct(r.qtdRet)}</td>
    <td style="color:${(r.itdPnl||0) >= 0 ? '#4ADE80' : '#F87171'}">${fmtDollar(r.itdPnl)}</td>
    <td style="color:${(r.itdRet||0) >= 0 ? '#4ADE80' : '#F87171'}">${fmtPct(r.itdRet)}</td>`;
  tbody.appendChild(tr);
}

function renderKeyMetrics(dash, perf, purchData) {
  const container = document.getElementById('keyMetricsDetail');
  if (!container) return;
  const stats = purchData?.stats || {};
  const avgPurch = parseDollar(dash.btcAvgPurchasePrice) || parseDollar(stats['Average Purchase Price']) || 85737.07;
  const avgVsInception = avgPurch - INCEPTION_BTC_PRICE;
  const belowInception = avgVsInception < 0;
  const items = [
    { label: 'BTC Avg Cost', value: fmtDollar(dash.btcAvgCost || dash.avgCost || 88922.95) },
    { label: 'BTC Avg Purchase Price', value: fmtDollar(avgPurch) },
    { label: 'Inception Date BTC Price', value: fmtDollar(perf?.inceptionBTCPrice || INCEPTION_BTC_PRICE) },
    { label: 'Avg Purchase vs Inception', value: fmtDollarCompact(avgVsInception), color: belowInception ? '#4ADE80' : '#F87171', sub: belowInception ? 'Below inception price' : 'Above inception price', subColor: belowInception ? '#4ADE80' : '#F87171' },
    { label: '2.5% of AUM', value: fmtDollar(parseDollar(dash.twoPointFiveAUM) || (dash.aum ? dash.aum * 0.025 : null)) },
    { label: 'Money Weighted Return', value: fmtPct(dash.mwrITDFund), color: dash.mwrITDFund < 0 ? '#F87171' : '#4ADE80' },
  ];
  container.innerHTML = items.map(i => {
    const valColor = i.color || '#F1F5F9';
    let html = `<div class="met-row"><span class="met-row-label">${i.label}</span><span class="met-row-value" style="color:${valColor}">${i.value || 'â€”'}</span></div>`;
    if (i.sub) html += `<div style="text-align:right;padding-bottom:8px"><span class="met-row-sub" style="color:${i.subColor || '#4ADE80'}">${i.sub}</span></div>`;
    return html;
  }).join('');
}

function renderTWRSummary(dash, perf) {
  const container = document.getElementById('twrSummary');
  if (!container) return;
  
  const itdFund = perf?.itdFundTWR ?? dash.itdTWRFund;
  const itdBTC = perf?.itdBTCTWR ?? dash.itdTWRBTC;
  const itdAlpha = perf?.itdAlpha ?? dash.itdAlpha;
  const qtdFund = perf?.qtdFundTWR ?? dash.qtdTWRFund;
  const qtdBTC = perf?.qtdBTCTWR ?? dash.qtdTWRBTC;
  const qtdAlpha = perf?.qtdAlpha ?? dash.qtdAlpha;
  
  const fmtVal = (v) => {
    if (v == null || isNaN(v)) return { text: 'â€”', color: '#94A3B8' };
    const pct = (v * 100).toFixed(2);
    return { text: (v >= 0 ? '+' : '') + pct + '%', color: v >= 0 ? '#4ADE80' : '#F87171' };
  };
  
  const periods = [
    { title: 'Inception to Date', color: '#F7931A', rows: [
      { label: 'Fund', ...fmtVal(itdFund) },
      { label: 'BTC Benchmark', ...fmtVal(itdBTC) },
      { label: 'Alpha', ...fmtVal(itdAlpha), isAlpha: true },
    ]},
    { title: 'Quarter to Date', color: '#3B82F6', rows: [
      { label: 'Fund', ...fmtVal(qtdFund) },
      { label: 'BTC Benchmark', ...fmtVal(qtdBTC) },
      { label: 'Alpha', ...fmtVal(qtdAlpha), isAlpha: true },
    ]}
  ];
  
  container.innerHTML = periods.map((p, i) => `
    <div class="twr-period" ${i === periods.length-1 ? 'style="border-bottom:none;margin-bottom:0;padding-bottom:0"' : ''}>
      <div class="twr-period-title"><span class="twr-period-bar" style="background:${p.color}"></span>${p.title}</div>
      ${p.rows.map(r => `
        <div class="twr-row">
          <span class="twr-row-label${r.isAlpha ? ' alpha' : ''}">${r.label}</span>
          <span class="twr-row-value" style="color:${r.isAlpha ? '#4ADE80' : r.color}">${r.text}</span>
        </div>
      `).join('')}
    </div>
  `).join('');
}

function renderAllocation(dash) {
  const colors = { BTC: '#F7931A', WBTC: '#8B5CF6', USDC: '#22D3EE', Cash: '#94A3B8', ETH: '#627EEA' };
  const barsEl = document.getElementById('allocBars');
  barsEl.innerHTML = '';
  dash.assets.forEach(a => {
    const pctStr = ((a.pct || 0) * 100).toFixed(2);
    const barWidth = Math.max(2, (a.pct || 0) * 100);
    barsEl.innerHTML += `
      <div class="ab-row">
        <div class="ab-lbl">${a.asset}</div>
        <div class="ab-track">
          <div class="ab-fill" style="width:${barWidth}%;background:${colors[a.asset] || '#4ADE80'}">
            ${barWidth > 15 ? fmtDollar(a.aum, true) : ''}
          </div>
        </div>
        <div class="ab-pct">${pctStr}%</div>
      </div>`;
  });
  const tbody = document.getElementById('allocTable');
  tbody.innerHTML = '';
  dash.assets.forEach(a => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${colors[a.asset] || '#4ADE80'};margin-right:6px"></span>${a.asset}</td>
      <td>${fmtNum(a.amount, a.asset === 'USDC' || a.asset === 'Cash' ? 2 : a.amount < 1 ? 4 : 2)}</td>
      <td>${fmtDollar(a.price)}</td>
      <td>${fmtDollar(a.aum)}</td>
      <td>${((a.pct || 0) * 100).toFixed(2)}%</td>`;
    tbody.appendChild(tr);
  });
}

function renderVenues(dash) {
  const tbody = document.getElementById('venueTable');
  tbody.innerHTML = '';
  dash.venues.forEach(v => {
    const tr = document.createElement('tr');
    if (v.isSummary) tr.className = 'bold';
    tr.innerHTML = `<td>${v.isSummary ? v.asset : ''}</td><td>${v.isSummary ? '' : v.venue}</td><td>${v.amount}</td><td>${v.price}</td><td>${v.value}</td>`;
    tbody.appendChild(tr);
  });
}

function renderAssetPieChart(dash) {
  const ctx = document.getElementById('assetPieChart')?.getContext('2d');
  if (!ctx || !dash.assets) return;
  if (charts.assetPie) charts.assetPie.destroy();
  
  const ASSET_COLORS = { BTC: '#F7931A', WBTC: '#E8A838', USDC: '#2775CA', Cash: '#16A34A', ETH: '#94A3B8' };
  const assets = dash.assets.filter(a => (a.pct || 0) > 0.001);
  
  charts.assetPie = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: assets.map(a => a.asset),
      datasets: [{
        data: assets.map(a => (a.pct || 0) * 100),
        backgroundColor: assets.map(a => ASSET_COLORS[a.asset] || '#94A3B8'),
        borderWidth: 2,
        borderColor: '#0B1120',
        hoverBorderColor: '#F1F5F9',
        hoverBorderWidth: 2,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      cutout: '58%',
      plugins: {
        legend: { display: false },
        tooltip: {
          enabled: false,
          external: function(context) {
            let el = document.getElementById('pieTooltip');
            if (!el) {
              el = document.createElement('div');
              el.id = 'pieTooltip';
              el.style.cssText = 'position:absolute;pointer-events:none;z-index:50;transition:opacity 0.15s;';
              document.body.appendChild(el);
            }
            const tooltip = context.tooltip;
            if (tooltip.opacity === 0) { el.style.opacity = '0'; return; }
            
            const idx = tooltip.dataPoints?.[0]?.dataIndex;
            const asset = assets[idx];
            if (!asset) { el.style.opacity = '0'; return; }
            const color = ASSET_COLORS[asset.asset] || '#94A3B8';
            
            let html = '<div style="background:rgba(15,23,42,0.95);border:1px solid rgba(148,163,184,0.2);border-radius:10px;padding:14px 18px;min-width:180px;font-family:\'JetBrains Mono\',monospace">';
            html += '<div style="font-size:16px;font-weight:700;color:' + color + ';margin-bottom:10px">' + asset.asset + '</div>';
            
            const rows = [
              { label: 'Holdings:', value: fmtNum(asset.amount, asset.amount < 1 ? 4 : 2), valColor: color },
              { label: 'USD Value:', value: fmtDollar(asset.aum, true), valColor: color },
              { label: 'Weight:', value: ((asset.pct || 0) * 100).toFixed(2) + '%', valColor: '#F1F5F9' },
            ];
            rows.forEach(r => {
              html += '<div style="display:flex;justify-content:space-between;gap:20px;margin-bottom:4px">';
              html += '<span style="color:#94A3B8;font-size:12px">' + r.label + '</span>';
              html += '<span style="color:' + r.valColor + ';font-size:12px;font-weight:600">' + r.value + '</span>';
              html += '</div>';
            });
            html += '</div>';
            el.innerHTML = html;
            el.style.opacity = '1';
            
            const pos = context.chart.canvas.getBoundingClientRect();
            el.style.left = (pos.left + window.scrollX + tooltip.caretX + 12) + 'px';
            el.style.top = (pos.top + window.scrollY + tooltip.caretY - 20) + 'px';
          }
        }
      }
    }
  });
  
  // Render legend
  const legendEl = document.getElementById('pieLegend');
  if (legendEl) {
    legendEl.innerHTML = assets.map(a => {
      const c = ASSET_COLORS[a.asset] || '#94A3B8';
      return `<div style="display:flex;align-items:center;gap:6px"><span style="width:10px;height:10px;border-radius:3px;background:${c}"></span><span style="color:#B0BEC5">${a.asset}</span><span style="color:#F1F5F9;font-family:'JetBrains Mono',monospace;font-weight:600">${((a.pct||0)*100).toFixed(1)}%</span></div>`;
    }).join('');
  }
}

function renderVenueBreakdown(dash) {
  const container = document.getElementById('venueBreakdown');
  if (!container || !dash.venues) return;
  
  const ASSET_COLORS = { BTC: '#F7931A', WBTC: '#E8A838', USDC: '#4ADE80', Cash: '#FB923C', ETH: '#94A3B8' };
  
  // Group venues by asset
  const groups = {};
  let currentAsset = null;
  dash.venues.forEach(v => {
    if (v.isSummary) {
      currentAsset = v.asset;
      if (!groups[currentAsset]) groups[currentAsset] = { items: [], total: v.value };
    } else if (currentAsset) {
      if (!groups[currentAsset]) groups[currentAsset] = { items: [], total: '' };
      groups[currentAsset].items.push({ venue: v.venue, value: v.value });
    }
  });
  
  let html = '';
  Object.entries(groups).forEach(([asset, data]) => {
    const color = ASSET_COLORS[asset] || '#94A3B8';
    html += `<div class="venue-group">`;
    html += `<div class="venue-asset-title" style="color:${color}">${asset}</div>`;
    data.items.forEach(item => {
      html += `<div class="venue-row"><span class="venue-row-label">${item.venue}</span><span class="venue-row-value">${item.value}</span></div>`;
    });
    if (data.items.length > 1 && data.total) {
      html += `<div class="venue-total"><span class="venue-total-label">TOTAL</span><span class="venue-total-value">${data.total}</span></div>`;
    }
    html += `</div>`;
  });
  
  container.innerHTML = html;
}

function renderPurchases(purchData, dash) {
  const ptbody = document.getElementById('purchaseTable');
  ptbody.innerHTML = '';
  purchData.purchases.forEach(p => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${p.description || p.token}</td><td>${fmtNum(p.qty, 4)}</td><td>${fmtDollar(p.basis)}</td><td>${p.fillDate || p.orderDate || ''}</td><td>${fmtDollar(p.value)}</td>`;
    ptbody.appendChild(tr);
  });
  const itbody = document.getElementById('inflowsTable');
  if (itbody) {
    itbody.innerHTML = '';
    purchData.inflows.forEach(inf => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${inf.stakeholder}</td><td>${inf.person}</td><td>${inf.asset}</td><td>${inf.qty}</td><td>${inf.value}</td><td>${inf.date}</td>`;
      itbody.appendChild(tr);
    });
  }
  const costEl = document.getElementById('costBars');
  costEl.innerHTML = '';
  const allCosts = purchData.purchases.map(p => p.basis).filter(x => x != null);
  const maxCost = Math.max(...allCosts, dash.btcPrice || 0, INCEPTION_BTC_PRICE) * 1.05;
  const btcPricePct = ((dash.btcPrice || 0) / maxCost) * 100;
  purchData.purchases.forEach(p => {
    if (!p.basis) return;
    const width = (p.basis / maxCost) * 100;
    const isAbovePrice = p.basis > (dash.btcPrice || 0);
    costEl.innerHTML += `
      <div class="cb-row">
        <div class="cb-lbl">${p.description?.split(' - ')[0] || p.token}</div>
        <div class="cb-track" style="position:relative">
          <div class="cb-fill" style="width:${width}%;background:${isAbovePrice ? 'rgba(248,113,113,0.6)' : 'rgba(74,222,128,0.6)'}">
            ${fmtDollar(p.basis)}
          </div>
          <div style="position:absolute;left:${btcPricePct}%;top:0;bottom:0;width:2px;background:#4ADE80;opacity:0.6"></div>
        </div>
      </div>`;
  });
  document.getElementById('avgCostLabel').textContent = fmtDollar(parseDollar(dash.btcAvgCost));
  document.getElementById('btcPriceLabel').textContent = fmtDollar(dash.btcPrice);
}

function renderCommentary(dash, perf) {
  const alpha = perf?.itdAlpha ?? dash.itdAlpha;
  const alphaStr = alpha ? '+' + (alpha * 100).toFixed(2) + '%' : '?';
  const avgCost = fmtDollar(dash.btcAvgCost);
  const text = `The fund has consistently outperformed a passive BTC hold by <span class="hl-g">${alphaStr}</span> ITD through disciplined TWAP execution and opportunistic limit orders during drawdowns. Key alpha drivers: deploying capital via 7-day TWAPs to smooth entry prices, and aggressive limit buys during the Feb sell-off (entries at <span class="hl-o">$78.5K</span> and <span class="hl-o">$63.1K</span> vs inception at <span class="hl-o">$90.3K</span>), lowering the blended cost basis from $90,287 to ${avgCost}. The <span class="hl-g">green bars</span> show periods of outperformance and <span class="hl-r">red bars</span> show underperformance â€” notice how decision points consistently widen the alpha gap.`;
  document.getElementById('commentary').innerHTML = text;
  const c2 = document.getElementById('commentary2');
  if (c2) c2.innerHTML = text;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHART RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const chartTooltip = {
  backgroundColor: 'rgba(15,23,42,0.95)',
  titleColor: '#F1F5F9', bodyColor: '#CBD5E1',
  borderColor: 'rgba(148,163,184,0.15)', borderWidth: 1, padding: 14,
  titleFont: { family: "'JetBrains Mono', monospace", size: 13, weight: 'bold' },
  bodyFont: { family: "'JetBrains Mono', monospace", size: 12 },
};
const axisFont = { family: "'JetBrains Mono', monospace", size: 10 };

function formatDateLabel(dateStr) {
  if (!dateStr) return '';
  const d = new Date(dateStr);
  if (isNaN(d)) return dateStr;
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function buildChartData(returnsDaily) {
  const labels = [], fundData = [], btcTWRData = [], btcPriceData = [], alphaData = [];
  for (const d of returnsDaily) {
    labels.push(formatDateLabel(d.date));
    const fund = d.cumTWR != null ? d.cumTWR : null;
    fundData.push(fund);
    // Use compounded BTC token daily returns for consistent TWR comparison
    const btcTWR = d.btcCumTWR != null ? d.btcCumTWR : null;
    btcTWRData.push(btcTWR);
    btcPriceData.push(d.btcPrice);
    alphaData.push(fund != null && btcTWR != null ? fund - btcTWR : null);
  }
  console.log('[buildChartData] Sample alpha values:', alphaData.slice(0,5), '... last 5:', alphaData.slice(-5));
  return { labels, fundData, btcTWRData, btcPriceData, alphaData };
}

function makeAnnotations(labels) {
  const a = {};
  DECISIONS.forEach((dec, i) => {
    const idx = labels.findIndex(l => l === dec.date);
    if (idx === -1) return;
    // Vertical dashed line full height
    a['line'+i] = { type:'line', xMin:idx, xMax:idx, borderColor:'rgba(148,163,184,0.2)', borderWidth:1, borderDash:[4,4] };
    // Label pinned to very top of chart area
    a['label'+i] = { type:'label', xValue:idx, yAdjust: -4, 
      content: dec.label,
      color: dec.type==='opportunistic' ? '#60A5FA' : '#4ADE80',
      font:{ size:10, weight:'bold', family:"'JetBrains Mono',monospace" },
      position: { y: 'start' }
    };
  });
  return a;
}

// Build a lookup: label â†’ decision object
function buildDecisionMap(labels) {
  const map = {};
  DECISIONS.forEach(d => {
    const idx = labels.findIndex(l => l === d.date);
    if (idx >= 0) map[idx] = d;
  });
  return map;
}

function makeTWRChart(canvasId, returnsDaily, chartKey) {
  const ctx = document.getElementById(canvasId)?.getContext('2d');
  if (!ctx) return;
  if (charts[chartKey]) charts[chartKey].destroy();
  const { labels, fundData, btcTWRData, btcPriceData, alphaData } = buildChartData(returnsDaily);
  const decisionMap = buildDecisionMap(labels);
  
  charts[chartKey] = new Chart(ctx, {
    data: {
      labels,
      datasets: [
        { type:'bar', label:'Alpha Spread', data:alphaData, 
          backgroundColor: alphaData.map(v => v != null && v >= 0 ? 'rgba(34,197,94,0.5)' : 'rgba(239,68,68,0.5)'), 
          borderWidth:0, barPercentage:1.0, categoryPercentage:1.0, yAxisID:'y', order:3 },
        { type:'line', label:'Fund TWR', data:fundData, borderColor:'#3B82F6', borderWidth:2, fill:false, tension:0.3, pointRadius:0, pointHoverRadius:5, pointHoverBackgroundColor:'#3B82F6', pointHoverBorderColor:'#fff', pointHoverBorderWidth:2, yAxisID:'y', order:1 },
        { type:'line', label:'BTC TWR', data:btcTWRData, borderColor:'#F7931A', borderWidth:2, borderDash:[6,3], fill:false, tension:0.3, pointRadius:0, pointHoverRadius:5, pointHoverBackgroundColor:'#F7931A', pointHoverBorderColor:'#fff', pointHoverBorderWidth:2, yAxisID:'y', order:2 },
        { type:'line', label:'BTC Price', data:btcPriceData, borderColor:'#8B5CF6', borderWidth:1.5, fill:false, tension:0.3, pointRadius:0, pointHoverRadius:4, pointHoverBackgroundColor:'#8B5CF6', yAxisID:'y1', order:2 }
      ]
    },
    options: {
      responsive:true, maintainAspectRatio:false,
      interaction:{ mode:'index', intersect:false },
      plugins:{
        legend:{ display:false },
        annotation:{ annotations: makeAnnotations(labels) },
        tooltip:{
          enabled: false,
          external: function(context) {
            // Custom HTML tooltip matching reference design
            let el = document.getElementById('chartTooltip-' + chartKey);
            if (!el) {
              el = document.createElement('div');
              el.id = 'chartTooltip-' + chartKey;
              el.style.cssText = 'position:absolute;pointer-events:none;z-index:50;transition:opacity 0.15s;';
              document.body.appendChild(el);
            }
            const tooltip = context.tooltip;
            if (tooltip.opacity === 0) { el.style.opacity = '0'; return; }
            
            const items = tooltip.dataPoints || [];
            const fundItem = items.find(i => i.dataset.label === 'Fund TWR');
            const btcItem = items.find(i => i.dataset.label === 'BTC TWR');
            const priceItem = items.find(i => i.dataset.label === 'BTC Price');
            const dateLabel = tooltip.title?.[0] || '';
            const idx = tooltip.dataPoints?.[0]?.dataIndex;
            const dec = decisionMap[idx];
            
            const fundVal = fundItem?.raw;
            const btcVal = btcItem?.raw;
            const priceVal = priceItem?.raw;
            const alpha = (fundVal != null && btcVal != null) ? fundVal - btcVal : null;
            
            const fmtP = v => v == null ? 'â€”' : (v >= 0 ? '+' : '') + v.toFixed(2) + '%';
            const fmtD = v => v == null ? 'â€”' : '$' + v.toLocaleString(undefined,{maximumFractionDigits:0});
            
            let html = '<div style="background:rgba(15,23,42,0.95);border:1px solid rgba(148,163,184,0.2);border-radius:10px;padding:14px 18px;min-width:220px;font-family:\'JetBrains Mono\',monospace">';
            html += '<div style="font-size:15px;font-weight:700;color:#F1F5F9;margin-bottom:10px">' + dateLabel + '</div>';
            
            // Rows: colored square + label + value
            const rows = [
              { color:'#3B82F6', label:'Fund TWR', val: fmtP(fundVal) },
              { color:'#F7931A', label:'BTC TWR', val: fmtP(btcVal) },
              { color:'#8B5CF6', label:'BTC Price', val: fmtD(priceVal) },
            ];
            rows.forEach(r => {
              html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">';
              html += '<span style="display:flex;align-items:center;gap:6px"><span style="width:10px;height:10px;border-radius:2px;background:' + r.color + '"></span><span style="color:' + r.color + ';font-size:12px">' + r.label + '</span></span>';
              html += '<span style="color:#F1F5F9;font-size:12px;font-weight:600">' + r.val + '</span>';
              html += '</div>';
            });
            
            // Alpha row
            if (alpha != null) {
              const aC = alpha >= 0 ? '#4ADE80' : '#F87171';
              html += '<div style="display:flex;justify-content:space-between;margin-top:8px;padding-top:8px;border-top:1px solid rgba(148,163,184,0.1)">';
              html += '<span style="color:' + aC + ';font-size:13px;font-weight:700">Alpha</span>';
              html += '<span style="color:' + aC + ';font-size:13px;font-weight:700">' + fmtP(alpha) + '</span>';
              html += '</div>';
            }
            
            // Decision callout
            if (dec) {
              html += '<div style="margin-top:10px;background:rgba(15,23,42,0.8);border:1px solid rgba(148,163,184,0.1);border-radius:8px;padding:8px 10px">';
              html += '<div style="font-size:11px;font-weight:700;color:' + (dec.type==='opportunistic'?'#60A5FA':'#4ADE80') + ';margin-bottom:3px">ğŸš€ ' + dec.label + '</div>';
              html += '<div style="font-size:11px;color:#94A3B8">' + dec.desc + '</div>';
              html += '</div>';
            }
            
            html += '</div>';
            el.innerHTML = html;
            el.style.opacity = '1';
            
            const pos = context.chart.canvas.getBoundingClientRect();
            el.style.left = (pos.left + window.scrollX + tooltip.caretX + 12) + 'px';
            el.style.top = (pos.top + window.scrollY + tooltip.caretY - 20) + 'px';
          }
        }
      },
      scales:{
        x:{ grid:{color:'rgba(148,163,184,0.06)'}, ticks:{color:'#596882', font:axisFont, maxTicksLimit:12} },
        y:{ position:'left', grid:{color:'rgba(148,163,184,0.06)'}, ticks:{color:'#596882', font:axisFont, callback:v=>v+'%'} },
        y1:{ position:'right', grid:{display:false}, ticks:{color:'#8B5CF6', font:axisFont, callback:v=>'$'+(v/1000).toFixed(0)+'K'} }
      }
    }
  });
}

function makeDrawdownChart(canvasId, returnsDaily, chartKey) {
  const ctx = document.getElementById(canvasId)?.getContext('2d');
  if (!ctx) return;
  if (charts[chartKey]) charts[chartKey].destroy();
  const labels = [], ddData = [];
  let peak = 1;
  for (const d of returnsDaily) {
    labels.push(formatDateLabel(d.date));
    const cumVal = 1 + (d.cumTWR||0)/100;
    if (cumVal > peak) peak = cumVal;
    ddData.push(((cumVal-peak)/peak)*100);
  }
  charts[chartKey] = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets: [{ label: 'Drawdown', data: ddData, borderColor: '#F87171', backgroundColor: 'rgba(248,113,113,0.08)', borderWidth: 1.5, fill: true, tension: 0.3, pointRadius: 0, pointHoverRadius: 4 }] },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false }, tooltip: { ...chartTooltip, bodyColor: '#F87171', borderColor: 'rgba(248,113,113,0.2)', callbacks: { label: ctx => `Drawdown: ${ctx.raw?.toFixed(2)}%` } } },
      scales: {
        x: { grid: { color: 'rgba(148,163,184,0.05)' }, ticks: { color: '#596882', font: axisFont, maxTicksLimit: 12 } },
        y: { grid: { color: 'rgba(148,163,184,0.05)' }, ticks: { color: '#596882', font: axisFont, callback: v => v + '%' }, max: 0 }
      }
    }
  });
}

function renderHoldingsChart(returnsDaily) {
  const ctx = document.getElementById('holdingsChart')?.getContext('2d');
  if (!ctx) return;
  if (charts.holdings) charts.holdings.destroy();
  const labels = [], holdingsData = [], priceData = [];
  for (const d of returnsDaily) {
    labels.push(formatDateLabel(d.date));
    holdingsData.push(d.btcHoldings);
    priceData.push(d.btcPrice);
  }
  charts.holdings = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets: [
      { label: 'BTC Holdings', data: holdingsData, borderColor: '#4ADE80', borderWidth: 2, fill: false, tension: 0.3, pointRadius: 0, yAxisID: 'y' },
      { label: 'BTC Price', data: priceData, borderColor: '#8B5CF6', borderWidth: 1.5, fill: false, tension: 0.3, pointRadius: 0, yAxisID: 'y1' }
    ] },
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: { legend: { display: false }, tooltip: { ...chartTooltip, callbacks: { label: ctx => ctx.datasetIndex === 0 ? `Holdings: ${ctx.raw?.toFixed(2)} BTC` : `BTC Price: $${ctx.raw?.toLocaleString()}` } } },
      scales: {
        x: { grid: { color: 'rgba(148,163,184,0.05)' }, ticks: { color: '#596882', font: axisFont, maxTicksLimit: 12 } },
        y: { position: 'left', grid: { color: 'rgba(148,163,184,0.05)' }, ticks: { color: '#4ADE80', font: axisFont, callback: v => v.toFixed(0) + ' BTC' } },
        y1: { position: 'right', grid: { display: false }, ticks: { color: '#8B5CF6', font: axisFont, callback: v => '$' + (v/1000).toFixed(0) + 'K' } }
      }
    }
  });
}

function renderAlphaSpreadChart(returnsDaily) {
  const ctx = document.getElementById('alphaSpreadChart')?.getContext('2d');
  if (!ctx) return;
  if (charts.alphaSpread) charts.alphaSpread.destroy();
  const { labels, fundData, btcTWRData, btcPriceData, alphaData } = buildChartData(returnsDaily);
  charts.alphaSpread = new Chart(ctx, {
    data: {
      labels,
      datasets: [
        { type:'line', label:'Alpha', data:alphaData, borderColor:'#4ADE80', borderWidth:2, fill:false, tension:0.3, pointRadius:0, pointHoverRadius:4, yAxisID:'y' },
        { type:'line', label:'BTC Price', data:btcPriceData, borderColor:'#8B5CF6', borderWidth:1.5, fill:false, tension:0.3, pointRadius:0, pointHoverRadius:4, yAxisID:'y1' }
      ]
    },
    options: {
      responsive:true, maintainAspectRatio:false,
      interaction:{mode:'index',intersect:false},
      plugins:{legend:{display:false},tooltip:{...chartTooltip,callbacks:{
        label(ctx){ return ctx.dataset.label==='BTC Price'?`BTC Price  $${ctx.raw?.toLocaleString()}`:`Alpha  ${ctx.raw>=0?'+':''}${ctx.raw?.toFixed(2)}%`; }
      }}},
      scales:{
        x:{grid:{color:'rgba(148,163,184,0.06)'},ticks:{color:'#596882',font:axisFont,maxTicksLimit:12}},
        y:{position:'left',grid:{color:'rgba(148,163,184,0.06)'},ticks:{color:'#4ADE80',font:axisFont,callback:v=>v+'%'}},
        y1:{position:'right',grid:{display:false},ticks:{color:'#8B5CF6',font:axisFont,callback:v=>'$'+(v/1000).toFixed(0)+'K'}}
      }
    }
  });
}

function renderPurchaseCostChart(purchData, dash) {
  const ctx = document.getElementById('purchaseCostChart')?.getContext('2d');
  if (!ctx) return;
  if (charts.purchCost) charts.purchCost.destroy();
  const labels = [], costs = [], colors = [];
  purchData.purchases.forEach(p => {
    if (!p.basis) return;
    labels.push(p.description?.split(' - ')[0] || p.token);
    costs.push(p.basis);
    colors.push(p.basis > (dash.btcPrice||0) ? 'rgba(248,113,113,0.6)' : 'rgba(74,222,128,0.6)');
  });
  charts.purchCost = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [{ label:'Cost Basis', data:costs, backgroundColor:colors, borderWidth:0, borderRadius:4 }] },
    options: {
      responsive:true, maintainAspectRatio:false, indexAxis:'y',
      plugins:{legend:{display:false},tooltip:{...chartTooltip,callbacks:{label:ctx=>`Cost: $${ctx.raw?.toLocaleString()}`}},
        annotation:{annotations:{
          btcLine:{type:'line',xMin:dash.btcPrice,xMax:dash.btcPrice,borderColor:'#4ADE80',borderWidth:2,borderDash:[4,4],label:{display:true,content:'BTC Price',position:'start',color:'#4ADE80',font:{size:10}}}
        }}
      },
      scales:{
        x:{grid:{color:'rgba(148,163,184,0.06)'},ticks:{color:'#596882',font:axisFont,callback:v=>'$'+(v/1000).toFixed(0)+'K'}},
        y:{grid:{display:false},ticks:{color:'#94A3B8',font:{...axisFont,size:9}}}
      }
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('tabBar').addEventListener('click', e => {
  const btn = e.target.closest('button');
  if (!btn || !btn.dataset.tab) return;
  document.querySelectorAll('#tabBar button').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.getElementById('tab-' + btn.dataset.tab)?.classList.add('active');
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN DATA LOADING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DECISION POINT ANNOTATIONS FOR CHARTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DECISIONS = [
  { date: 'Dec 12', label: 'Deploy', type: 'twap', desc: 'Initial deployment at $90,287' },
  { date: 'Dec 30', label: 'T1', type: 'twap', price: 87814, desc: '7d TWAP buy at $87,814 â€” 2.7% below inception' },
  { date: 'Jan 7', label: 'T2', type: 'twap', price: 94685, desc: '7d TWAP buy at $94,685' },
  { date: 'Jan 14', label: 'T3+T4', type: 'twap', price: 96483, desc: '7d TWAP buys at ~$96.5K' },
  { date: 'Jan 29', label: 'T5', type: 'twap', price: 101522, desc: '7d TWAP buy at $101,522' },
  { date: 'Feb 1', label: '$78.5K', type: 'opportunistic', price: 78500, desc: 'Limit buy at $78.5K â€” 13.1% below inception' },
  { date: 'Feb 5', label: '$63.1K', type: 'opportunistic', price: 63100, desc: 'Limit buy at $63.1K â€” 30.1% below inception' }
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA VALIDATION & RETRY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function hasLoadingValues(dashRows, perfRows) {
  // Check key cells that commonly show "Loading..."
  const checks = [
    dashRows[4]?.[1],   // AUM
    dashRows[4]?.[4],   // BTC Price
    perfRows[8]?.[2],   // ITD Fund TWR
    perfRows[16]?.[2],  // QTD Fund TWR
    perfRows[22]?.[2],  // Current AUM
  ];
  const loadingCount = checks.filter(v => v && String(v).toLowerCase().includes('loading')).length;
  console.log(`[Validation] ${loadingCount}/${checks.length} cells still show "Loading..."`, checks);
  return loadingCount;
}

async function fetchAllCSV() {
  return Promise.all([
    fetchCSV(TABS.dashboard),
    fetchCSV(TABS.perfSummary),
    fetchCSV(TABS.returnsDaily),
    fetchCSV(TABS.purchases)
  ]);
}

async function fetchWithRetry(maxRetries = 4, delayMs = 4000) {
  let bestData = null;
  let bestLoadingCount = Infinity;
  
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      const [dashRows, perfRows, returnsRows, purchRows] = await fetchAllCSV();
      const loadingCount = hasLoadingValues(dashRows, perfRows);
      
      if (loadingCount === 0) {
        console.log(`[Retry] Attempt ${attempt}: All values resolved!`);
        return { dashRows, perfRows, returnsRows, purchRows };
      }
      
      // Keep the best (fewest Loading...) result
      if (loadingCount < bestLoadingCount) {
        bestLoadingCount = loadingCount;
        bestData = { dashRows, perfRows, returnsRows, purchRows };
      }
      
      if (attempt < maxRetries) {
        console.log(`[Retry] Attempt ${attempt}: ${loadingCount} loading cells, waiting ${delayMs}ms...`);
        await new Promise(r => setTimeout(r, delayMs));
        delayMs += 2000; // increase delay each retry
      }
    } catch (err) {
      console.warn(`[Retry] Attempt ${attempt} failed:`, err.message);
      if (attempt < maxRetries) await new Promise(r => setTimeout(r, 3000));
    }
  }
  
  if (bestData) {
    console.log(`[Retry] Using best result with ${bestLoadingCount} loading cells`);
    return bestData;
  }
  throw new Error('All fetch attempts failed');
}

async function loadAllData() {
  try {
    const { dashRows, perfRows, returnsRows, purchRows } = await fetchWithRetry();
    
    const dash = parseDashboard(dashRows);
    const perf = parsePerfSummary(perfRows);
    const returnsDaily = parseReturnsDaily(returnsRows);
    const purchData = parsePurchases(purchRows);
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CROSS-FILL: Use returnsDaily to fill in any values still NaN/null
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    if (returnsDaily.length > 0) {
      const last = returnsDaily[returnsDaily.length - 1];
      
      // AUM: prefer parsed, fallback to last portfolio value
      if (!dash.aum || isNaN(dash.aum)) {
        dash.aum = last.portfolioValue || perf.currentAUM || null;
      }
      if (!perf.currentAUM || isNaN(perf.currentAUM)) {
        perf.currentAUM = dash.aum;
      }
      
      // BTC Price: prefer parsed, fallback to last day's price or perfSummary
      if (!dash.btcPrice || isNaN(dash.btcPrice)) {
        dash.btcPrice = last.btcPrice || perf.currentBTCPrice || perf.currentBTCPriceKM || null;
      }
      
      // Fund ITD TWR: compute from cumulative daily data
      if (!perf.itdFundTWR || isNaN(perf.itdFundTWR)) {
        perf.itdFundTWR = last.cumTWR != null ? last.cumTWR / 100 : null;
      }
      if (!dash.itdTWRFund || isNaN(dash.itdTWRFund)) {
        dash.itdTWRFund = perf.itdFundTWR;
      }
      
      // Alpha: compute Fund - BTC
      if (perf.itdFundTWR != null && perf.itdBTCTWR != null && (!perf.itdAlpha || isNaN(perf.itdAlpha))) {
        perf.itdAlpha = perf.itdFundTWR - perf.itdBTCTWR;
      }
      if (!dash.itdAlpha || isNaN(dash.itdAlpha)) {
        dash.itdAlpha = perf.itdAlpha;
      }
      
      // QTD: find Jan 1 (or closest) to compute QTD returns
      const q1Start = returnsDaily.find(d => d.date && d.date >= '2025-12-31') || returnsDaily[0];
      const q1Idx = returnsDaily.indexOf(q1Start);
      if (q1Idx >= 0 && q1Idx < returnsDaily.length - 1) {
        // QTD Fund TWR
        if (!perf.qtdFundTWR || isNaN(perf.qtdFundTWR)) {
          const startCum = q1Start.cumTWR || 0;
          const endCum = last.cumTWR || 0;
          perf.qtdFundTWR = ((1 + endCum/100) / (1 + startCum/100) - 1);
        }
        // QTD BTC TWR: use perfSummary hardcoded value
        // (already parsed correctly as -0.2204)
        
        // QTD Alpha
        if (perf.qtdFundTWR != null && perf.qtdBTCTWR != null && (!perf.qtdAlpha || isNaN(perf.qtdAlpha))) {
          perf.qtdAlpha = perf.qtdFundTWR - perf.qtdBTCTWR;
        }
      }
      if (!dash.qtdTWRFund || isNaN(dash.qtdTWRFund)) dash.qtdTWRFund = perf.qtdFundTWR;
      if (!dash.qtdTWRBTC || isNaN(dash.qtdTWRBTC)) dash.qtdTWRBTC = perf.qtdBTCTWR;
      if (!dash.qtdAlpha || isNaN(dash.qtdAlpha)) dash.qtdAlpha = perf.qtdAlpha;
    }
    
    lastGoodData = { dash, perf, returnsDaily, purchData };

    // === DEBUG LOGGING ===
    console.log("FINAL dash:", {aum:dash.aum,btcPrice:dash.btcPrice,btcHoldings:dash.btcHoldings,avgCost:dash.btcAvgCost,itdFund:dash.itdTWRFund,itdBTC:dash.itdTWRBTC,itdAlpha:dash.itdAlpha,qtdFund:dash.qtdTWRFund,qtdBTC:dash.qtdTWRBTC,qtdAlpha:dash.qtdAlpha});
    console.log("FINAL perf:", {currentAUM:perf.currentAUM,itdFundTWR:perf.itdFundTWR,itdBTCTWR:perf.itdBTCTWR,itdAlpha:perf.itdAlpha,qtdFundTWR:perf.qtdFundTWR,qtdBTCTWR:perf.qtdBTCTWR,qtdAlpha:perf.qtdAlpha});
    console.log("RETURNS DAILY ROW2 (asset groups) ALL COLS:", JSON.stringify(returnsRows[1]));
    console.log("RETURNS DAILY ROW3 (column headers) ALL COLS:", JSON.stringify(returnsRows[2]));
    console.log("RETURNS DAILY ROW4 (first data) ALL COLS:", JSON.stringify(returnsRows[3]));
    console.log("RETURNS DAILY ROW5 (second data) ALL COLS:", JSON.stringify(returnsRows[4]));
    console.log("RETURNS DAILY:", {length:returnsDaily.length, first:returnsDaily[0], last:returnsDaily[returnsDaily.length-1]});
    // === END DEBUG ===
    
    renderHero(dash, perf, returnsDaily);
    renderITDQTD(dash, perf);
    renderKeyMetrics(dash, perf, purchData);
    renderTWRSummary(dash, perf);
    renderMWR(dash);
    renderBTCTWR(dash);
    renderAllocation(dash);
    renderVenues(dash);
    renderAssetPieChart(dash);
    renderVenueBreakdown(dash);
    renderPurchases(purchData, dash);
    renderCommentary(dash, perf);
    renderDrawdownStats(returnsDaily);
    
    // Charts
    makeTWRChart('twrChart', returnsDaily, 'twr');
    makeTWRChart('twrChart2', returnsDaily, 'twr2');
    makeDrawdownChart('drawdownChart2', returnsDaily, 'dd2');
    renderHoldingsChart(returnsDaily);
    renderAlphaSpreadChart(returnsDaily);
    renderPurchaseCostChart(purchData, dash);
    
    const now = new Date();
    const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    const hd = document.getElementById('headerDate');
    if (hd) hd.textContent = (dash.todayDate || perf.currentDate || '') + ' Â· Updated ' + timeStr;
    
    document.getElementById('errorBanner').style.display = 'none';
    
  } catch (err) {
    console.error('Data fetch error:', err);
    const banner = document.getElementById('errorBanner');
    banner.textContent = `âš  Data refresh failed: ${err.message}. Showing last good data. Retrying in 60sâ€¦`;
    banner.style.display = 'block';
    if (!lastGoodData) {
      const hd2 = document.getElementById('headerDate');
      if (hd2) hd2.textContent = 'Failed to load â€” retryingâ€¦';
    }
  }
  
  document.getElementById('loadingOverlay')?.classList.add('hidden');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT & AUTO-REFRESH (synced to top of each minute)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init() {
  console.log('[init] Starting...');
  try {
    await loadAllData();
    console.log('[init] Initial load complete');
  } catch(e) {
    console.error('[init] Initial load failed:', e);
  }
  
  document.getElementById('loadingOverlay')?.classList.add('hidden');

  // Sheet refreshes every 5 min at :30s mark (e.g. :04:30, :09:30, :14:30, ...)
  // Dashboard fetches 90s later at :00s mark (e.g. :06:00, :11:00, :16:00, ...)
  function secsUntilNextFetch() {
    var now = new Date();
    var min = now.getMinutes();
    var sec = now.getSeconds();
    var totalSec = min * 60 + sec;
    var targets = [];
    for (var n = 0; n < 12; n++) targets.push((5 * n + 1) * 60);
    var wait = null;
    for (var i = 0; i < targets.length; i++) {
      if (targets[i] > totalSec) { wait = targets[i] - totalSec; break; }
    }
    if (wait === null) wait = (3600 - totalSec) + targets[0];
    return Math.max(wait, 10);
  }
  
  function fmtCountdown(s) {
    if (s >= 60) return Math.floor(s/60) + 'm ' + (s%60) + 's';
    return s + 's';
  }

  function scheduleNext() {
    var remaining = secsUntilNextFetch();
    var cd = document.getElementById('countdown');
    var pill = document.getElementById('livePill');
    console.log('[timer] Next fetch in', remaining, 'seconds');
    if (cd) cd.textContent = fmtCountdown(remaining);
    var tick = setInterval(function() {
      remaining--;
      if (remaining <= 0) {
        clearInterval(tick);
        if (cd) cd.textContent = 'â€¦';
        if (pill) pill.style.borderColor = 'rgba(34,197,94,0.5)';
        loadAllData().then(function() {
          if (pill) pill.style.borderColor = 'rgba(34,197,94,0.2)';
          scheduleNext();
        }).catch(function(e) {
          console.error('[timer] Refresh failed:', e);
          if (pill) pill.style.borderColor = 'rgba(248,113,113,0.3)';
          scheduleNext();
        });
      } else {
        if (cd) cd.textContent = fmtCountdown(remaining);
      }
    }, 1000);
  }
  scheduleNext();
}

init();
</script>
</body></html>
